# ZANTARA RAG Architecture - Complete System Diagram

## 🏗️ HIGH-LEVEL OVERVIEW

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                    ZANTARA RAG SYSTEM                                    │
│                          Multi-Tier Agentic RAG with ReAct Pattern                      │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                         │
│   ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐            │
│   │   MOUTH     │    │  BACKEND    │    │   QDRANT    │    │  POSTGRES   │            │
│   │  (Next.js)  │───▶│  (FastAPI)  │───▶│  (Vectors)  │    │  (Memory)   │            │
│   │  Frontend   │    │   RAG API   │    │  53K+ docs  │    │  CRM/Facts  │            │
│   └─────────────┘    └──────┬──────┘    └─────────────┘    └─────────────┘            │
│                             │                                                          │
│                    ┌────────▼────────┐                                                 │
│                    │  LLM PROVIDERS  │                                                 │
│                    ├─────────────────┤                                                 │
│                    │ Gemini 2.5 Flash│ ◀── Primary                                    │
│                    │ Gemini 2.0 Flash│ ◀── Fallback 1                                 │
│                    │ Gemini 2.5 Pro  │ ◀── Fallback 2                                 │
│                    │ OpenRouter      │ ◀── Final Fallback                             │
│                    └─────────────────┘                                                 │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 🔄 COMPLETE REQUEST FLOW

```
┌──────────────────────────────────────────────────────────────────────────────────────────┐
│                              QUERY LIFECYCLE (End-to-End)                                │
└──────────────────────────────────────────────────────────────────────────────────────────┘

     USER QUERY
         │
         ▼
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│ 1. FASTAPI ROUTER (/api/agentic-rag/query)                                              │
│    ├── Authentication (Hybrid: API Key / JWT Cookie / Header)                           │
│    ├── Request validation                                                               │
│    └── Extract: query, user_id, session_id, conversation_history                        │
└────────────────────────────────────────┬────────────────────────────────────────────────┘
                                         │
                                         ▼
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│ 2. SEMANTIC CACHE CHECK                                                                 │
│    ┌────────────────────────────────────────────────────────────────────────┐          │
│    │  Redis-backed cache (TTL: 1h, Max: 10K entries)                        │          │
│    │  ├── Compute query embedding                                           │          │
│    │  ├── Cosine similarity search (threshold: 0.95)                        │          │
│    │  └── HIT? → Return cached response (150ms vs 800ms)                    │          │
│    └────────────────────────────────────────────────────────────────────────┘          │
│    MISS ↓                                                                               │
└────────────────────────────────────────┬────────────────────────────────────────────────┘
                                         │
                                         ▼
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│ 3. INTENT CLASSIFICATION                                                                │
│    ┌────────────────────────────────────────────────────────────────────────┐          │
│    │  IntentClassifier                                                       │          │
│    │  ├── Query type: question / instruction / clarification                 │          │
│    │  ├── Domain: visa / tax / legal / kbli / team / general                │          │
│    │  ├── Urgency level                                                      │          │
│    │  └── Model tier selection: FLASH (0) / PRO (2) / DEEPTHINK             │          │
│    └────────────────────────────────────────────────────────────────────────┘          │
└────────────────────────────────────────┬────────────────────────────────────────────────┘
                                         │
                                         ▼
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│ 4. CONTEXT ENRICHMENT                                                                   │
│    ┌────────────────────────────────────────────────────────────────────────┐          │
│    │  ContextManager + ContextWindowManager                                  │          │
│    │  ├── Retrieve conversation history (last 10-15 messages)               │          │
│    │  ├── Fetch user memory context (preferences, facts)                    │          │
│    │  ├── Summarize if > 15 messages                                        │          │
│    │  └── Build context object                                              │          │
│    └────────────────────────────────────────────────────────────────────────┘          │
│                                                                                         │
│    Memory Sources:                                                                      │
│    ┌──────────────┐  ┌──────────────┐  ┌──────────────┐                               │
│    │   Episodic   │  │  Collective  │  │  PostgreSQL  │                               │
│    │   Memory     │  │   Memory     │  │   Facts DB   │                               │
│    │  (Sessions)  │  │  (Patterns)  │  │  (Persistent)│                               │
│    └──────────────┘  └──────────────┘  └──────────────┘                               │
└────────────────────────────────────────┬────────────────────────────────────────────────┘
                                         │
                                         ▼
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│ 5. PROMPT BUILDING                                                                      │
│    ┌────────────────────────────────────────────────────────────────────────┐          │
│    │  PromptBuilder                                                          │          │
│    │  ├── System prompt (ZANTARA persona + capabilities)                    │          │
│    │  ├── Tool definitions (10 tools with function schemas)                 │          │
│    │  ├── User context section                                              │          │
│    │  ├── Conversation history                                              │          │
│    │  └── Current query with instructions                                   │          │
│    └────────────────────────────────────────────────────────────────────────┘          │
│                                                                                         │
│    Persona Variants:                                                                    │
│    ┌──────────────┐  ┌──────────────┐                                                  │
│    │   JAKSEL     │  │    BALI      │                                                  │
│    │   Persona    │  │   Persona    │                                                  │
│    │  (Jakarta)   │  │   (Bali)     │                                                  │
│    └──────────────┘  └──────────────┘                                                  │
└────────────────────────────────────────┬────────────────────────────────────────────────┘
                                         │
                                         ▼
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│ 6. AGENTIC ORCHESTRATOR                                                                 │
│ ┌─────────────────────────────────────────────────────────────────────────────────────┐│
│ │                         ReAct REASONING LOOP                                        ││
│ │                                                                                     ││
│ │   ┌─────────────────────────────────────────────────────────────────────────────┐  ││
│ │   │                           ITERATION 1-5                                     │  ││
│ │   │                                                                             │  ││
│ │   │   ┌───────────┐      ┌───────────┐      ┌───────────┐      ┌───────────┐   │  ││
│ │   │   │  THOUGHT  │ ───▶ │  ACTION   │ ───▶ │  EXECUTE  │ ───▶ │OBSERVATION│   │  ││
│ │   │   │           │      │           │      │           │      │           │   │  ││
│ │   │   │ "I need   │      │ tool_call │      │ Run tool  │      │ Results   │   │  ││
│ │   │   │  to find  │      │ {name,    │      │ with args │      │ returned  │   │  ││
│ │   │   │  visa     │      │  args}    │      │           │      │           │   │  ││
│ │   │   │  info..." │      │           │      │           │      │           │   │  ││
│ │   │   └───────────┘      └───────────┘      └─────┬─────┘      └───────────┘   │  ││
│ │   │                                               │                             │  ││
│ │   │                                               ▼                             │  ││
│ │   │                                    ┌───────────────────┐                    │  ││
│ │   │                                    │ TOOL EXECUTOR     │                    │  ││
│ │   │                                    │ ├── Parse native  │                    │  ││
│ │   │                                    │ │   function call │                    │  ││
│ │   │                                    │ ├── Regex fallback│                    │  ││
│ │   │                                    │ └── Execute tool  │                    │  ││
│ │   │                                    └───────────────────┘                    │  ││
│ │   │                                                                             │  ││
│ │   │   Exit Conditions:                                                          │  ││
│ │   │   ├── Final answer provided by LLM                                         │  ││
│ │   │   ├── Max steps reached (5)                                                │  ││
│ │   │   └── Early exit (sufficient context)                                      │  ││
│ │   └─────────────────────────────────────────────────────────────────────────────┘  ││
│ └─────────────────────────────────────────────────────────────────────────────────────┘│
└────────────────────────────────────────┬────────────────────────────────────────────────┘
                                         │
                                         ▼
```

---

## 🔧 TOOLS AVAILABLE TO AGENT

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                    TOOL CATALOG                                          │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                         │
│  ┌─────────────────────────────────────────────────────────────────────────────────┐   │
│  │ 1. VECTOR SEARCH TOOL (Primary)                                                 │   │
│  │    ├── Semantic search across 15+ Qdrant collections                           │   │
│  │    ├── Hybrid mode: Dense (1536D) + BM25 Sparse                               │   │
│  │    ├── Ze-Rank 2 API reranking (optional)                                     │   │
│  │    └── Rate limit: 10 req/min per user                                        │   │
│  └─────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                         │
│  ┌─────────────────────────────────────────────────────────────────────────────────┐   │
│  │ 2. DATABASE QUERY TOOL                                                          │   │
│  │    ├── PostgreSQL direct queries                                               │   │
│  │    ├── CRM data access (clients, practices)                                   │   │
│  │    └── SQL injection protection                                               │   │
│  └─────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                         │
│  ┌─────────────────────────────────────────────────────────────────────────────────┐   │
│  │ 3. GRAPH TRAVERSAL TOOL                                                         │   │
│  │    ├── Knowledge graph navigation                                              │   │
│  │    ├── Multi-hop reasoning                                                     │   │
│  │    └── Relationship exploration                                                │   │
│  └─────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                         │
│  ┌─────────────────────────────────────────────────────────────────────────────────┐   │
│  │ 4. CALCULATOR TOOL                    5. VISION TOOL                           │   │
│  │    ├── Math operations                   ├── Image analysis                    │   │
│  │    └── Financial calculations            └── Document OCR                      │   │
│  └─────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                         │
│  ┌─────────────────────────────────────────────────────────────────────────────────┐   │
│  │ 6. PRICING TOOL                       7. TEAM KNOWLEDGE TOOL                   │   │
│  │    ├── Service pricing                   ├── Team info queries                 │   │
│  │    └── Quote generation                  └── Internal knowledge                │   │
│  └─────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                         │
│  ┌─────────────────────────────────────────────────────────────────────────────────┐   │
│  │ 8. WEB SEARCH TOOL                    9. MCP SUPER TOOL                        │   │
│  │    ├── External search                   ├── Model Context Protocol            │   │
│  │    └── (Disabled by default)             └── External integrations             │   │
│  └─────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                         │
│  ┌─────────────────────────────────────────────────────────────────────────────────┐   │
│  │ 10. DIAGNOSTICS TOOL                                                            │   │
│  │     ├── System health checks                                                    │   │
│  │     └── Performance metrics                                                     │   │
│  └─────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 🔍 VECTOR SEARCH DEEP DIVE

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                              VECTOR SEARCH PIPELINE                                      │
└─────────────────────────────────────────────────────────────────────────────────────────┘

     QUERY: "How to get B211A visa?"
              │
              ▼
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│ 1. QUERY ROUTER (3-Layer System)                                                        │
│    ┌─────────────────────────────────────────────────────────────────────────────────┐ │
│    │ Layer 1: KEYWORD MATCHING (~1ms) ─────────────────────────────────────────────▶ │ │
│    │          Handles 99% of queries                                                 │ │
│    │          ├── "visa" → visa_oracle                                              │ │
│    │          ├── "tax" → tax_genius, tax_updates                                   │ │
│    │          ├── "kbli" → kbli_eye, kbli_comprehensive                            │ │
│    │          ├── "legal" → legal_architect                                        │ │
│    │          └── "property" → property_listings                                   │ │
│    ├─────────────────────────────────────────────────────────────────────────────────┤ │
│    │ Layer 2: SEMANTIC ANALYSIS (future) ─────────────────────────────────────────▶ │ │
│    │          For ambiguous queries                                                  │ │
│    ├─────────────────────────────────────────────────────────────────────────────────┤ │
│    │ Layer 3: LLM FALLBACK (future) ──────────────────────────────────────────────▶ │ │
│    │          Edge cases only                                                        │ │
│    └─────────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                         │
│    OUTPUT: collections=["visa_oracle"], confidence=0.95                                │
└────────────────────────────────────────┬────────────────────────────────────────────────┘
                                         │
                                         ▼
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│ 2. EMBEDDING GENERATION                                                                 │
│    ┌─────────────────────────────────────────────────────────────────────────────────┐ │
│    │  Provider Selection:                                                            │ │
│    │  ┌────────────────────────┐    ┌────────────────────────┐                      │ │
│    │  │ OpenAI (Primary)       │ OR │ SentenceTransformers   │                      │ │
│    │  │ text-embedding-3-small │    │ (Local Fallback)       │                      │ │
│    │  │ 1536 dimensions        │    │ 384 dimensions         │                      │ │
│    │  └────────────────────────┘    └────────────────────────┘                      │ │
│    └─────────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                         │
│    OUTPUT: embedding = [0.023, -0.041, 0.018, ...]  (1536 floats)                      │
└────────────────────────────────────────┬────────────────────────────────────────────────┘
                                         │
                                         ▼
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│ 3. QDRANT SEARCH                                                                        │
│    ┌─────────────────────────────────────────────────────────────────────────────────┐ │
│    │                                                                                 │ │
│    │   ┌─────────────────┐         ┌─────────────────┐                              │ │
│    │   │  DENSE SEARCH   │   +     │  BM25 SPARSE    │   =   HYBRID SEARCH          │ │
│    │   │  (Semantic)     │         │  (Keyword)      │                              │ │
│    │   │                 │         │                 │                              │ │
│    │   │  Cosine         │         │  Token IDs      │                              │ │
│    │   │  Similarity     │         │  TF-IDF scores  │                              │ │
│    │   └─────────────────┘         └─────────────────┘                              │ │
│    │                                                                                 │ │
│    │   Reciprocal Rank Fusion (RRF):                                                │ │
│    │   score = Σ 1/(k + rank_i)  where k=60                                        │ │
│    │                                                                                 │ │
│    └─────────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                         │
│    ┌─────────────────────────────────────────────────────────────────────────────────┐ │
│    │  QDRANT COLLECTIONS (53,757+ documents)                                         │ │
│    │  ┌────────────────┬─────────┬────────────────────────────────────────────────┐ │ │
│    │  │ Collection     │ Docs    │ Content                                        │ │ │
│    │  ├────────────────┼─────────┼────────────────────────────────────────────────┤ │ │
│    │  │ visa_oracle    │ 1,612   │ Visa & Immigration                            │ │ │
│    │  │ kbli_unified   │ 8,886   │ Business Codes (KBLI 2025)                    │ │ │
│    │  │ legal_unified  │ 5,041   │ Legal Framework                               │ │ │
│    │  │ tax_genius     │ 895     │ Tax Regulations                               │ │ │
│    │  │ knowledge_base │ 37,272  │ General Knowledge                             │ │ │
│    │  │ bali_zero_team │ 51      │ Team & Pricing                                │ │ │
│    │  └────────────────┴─────────┴────────────────────────────────────────────────┘ │ │
│    └─────────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                         │
│    OUTPUT: 10 candidate documents with scores                                          │
└────────────────────────────────────────┬────────────────────────────────────────────────┘
                                         │
                                         ▼
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│ 4. RERANKING (Ze-Rank 2 API)                                                           │
│    ┌─────────────────────────────────────────────────────────────────────────────────┐ │
│    │                                                                                 │ │
│    │   Input: query + 10 candidates                                                 │ │
│    │                    │                                                            │ │
│    │                    ▼                                                            │ │
│    │   ┌────────────────────────────────────────────────────────────────────────┐   │ │
│    │   │                    Ze-Rank 2 (ZeroEntropy)                             │   │ │
│    │   │                                                                        │   │ │
│    │   │   Cross-encoder model for semantic relevance scoring                   │   │ │
│    │   │   ├── Considers query-document interaction                             │   │ │
│    │   │   ├── More accurate than bi-encoder retrieval                          │   │ │
│    │   │   └── Returns relevance scores 0.0-1.0                                 │   │ │
│    │   │                                                                        │   │ │
│    │   └────────────────────────────────────────────────────────────────────────┘   │ │
│    │                    │                                                            │ │
│    │                    ▼                                                            │ │
│    │   Output: Top 5 reranked documents                                             │ │
│    │                                                                                 │ │
│    └─────────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                         │
│    FINAL OUTPUT: [doc1, doc2, doc3, doc4, doc5] with relevance scores                 │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 🤖 LLM GATEWAY & MODEL CASCADE

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                              LLM GATEWAY - FALLBACK CASCADE                             │
└─────────────────────────────────────────────────────────────────────────────────────────┘

                              ┌─────────────────────────┐
                              │      LLM Gateway        │
                              │    (llm_gateway.py)     │
                              └───────────┬─────────────┘
                                          │
                    ┌─────────────────────┼─────────────────────┐
                    │                     │                     │
                    ▼                     ▼                     ▼
         ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐
         │   TIER 0: FLASH  │  │   TIER 1: LITE   │  │   TIER 2: PRO    │
         │   (Primary)      │  │   (Fallback 1)   │  │   (Fallback 2)   │
         ├──────────────────┤  ├──────────────────┤  ├──────────────────┤
         │ gemini-2.5-flash │  │ gemini-2.0-flash │  │ gemini-2.5-pro   │
         │                  │  │                  │  │                  │
         │ • Fastest        │  │ • Stable         │  │ • Highest quality│
         │ • Cost-effective │  │ • Lower quota    │  │ • Higher quota   │
         │ • Default choice │  │ • Good fallback  │  │ • Complex tasks  │
         └────────┬─────────┘  └────────┬─────────┘  └────────┬─────────┘
                  │                     │                     │
                  │ ResourceExhausted   │ ResourceExhausted   │ ResourceExhausted
                  │ ServiceUnavailable  │ ServiceUnavailable  │ ServiceUnavailable
                  │                     │                     │
                  └──────────┬──────────┴──────────┬──────────┘
                             │                     │
                             ▼                     ▼
                  ┌──────────────────────────────────────────┐
                  │          TIER 3: OPENROUTER              │
                  │          (Final Fallback)                │
                  ├──────────────────────────────────────────┤
                  │ • External provider                      │
                  │ • Multiple model options                 │
                  │ • Pay-per-use                            │
                  │ • Lazy-loaded on first use               │
                  └──────────────────────────────────────────┘


┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                           FUNCTION CALLING SUPPORT                                       │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                         │
│   LLM Response                                                                          │
│        │                                                                                │
│        ▼                                                                                │
│   ┌───────────────────────────────────────────────────────────────────────────────┐    │
│   │                         PARSING PIPELINE                                      │    │
│   │                                                                               │    │
│   │   ┌─────────────────────┐         ┌─────────────────────┐                    │    │
│   │   │ NATIVE FUNCTION     │  FAIL   │ REGEX FALLBACK      │                    │    │
│   │   │ CALL PARSING        │ ──────▶ │ PARSING             │                    │    │
│   │   │                     │         │                     │                    │    │
│   │   │ Parse Gemini native │         │ Pattern: TOOL_CALL  │                    │    │
│   │   │ function_call       │         │ {name: X, args: Y}  │                    │    │
│   │   │ declarations        │         │                     │                    │    │
│   │   └─────────────────────┘         └─────────────────────┘                    │    │
│   │              │                              │                                 │    │
│   │              └──────────────┬───────────────┘                                 │    │
│   │                             ▼                                                 │    │
│   │                    ┌───────────────┐                                          │    │
│   │                    │  ToolCall     │                                          │    │
│   │                    │  {            │                                          │    │
│   │                    │   tool_name,  │                                          │    │
│   │                    │   arguments   │                                          │    │
│   │                    │  }            │                                          │    │
│   │                    └───────────────┘                                          │    │
│   └───────────────────────────────────────────────────────────────────────────────┘    │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## ✅ RESPONSE PIPELINE

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                              RESPONSE PROCESSING PIPELINE                                │
└─────────────────────────────────────────────────────────────────────────────────────────┘

     RAW LLM RESPONSE
           │
           ▼
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│ STAGE 1: VERIFICATION                                                                   │
│ ┌─────────────────────────────────────────────────────────────────────────────────────┐│
│ │                                                                                     ││
│ │   Draft Answer + Retrieved Context                                                  ││
│ │           │                                                                         ││
│ │           ▼                                                                         ││
│ │   ┌───────────────────────────────────────────────────────────────────────────┐    ││
│ │   │              VERIFICATION SERVICE (GenAI Flash)                           │    ││
│ │   │                                                                           │    ││
│ │   │   ├── Compare answer claims against context                              │    ││
│ │   │   ├── Check factual accuracy                                             │    ││
│ │   │   ├── Validate regulatory references                                     │    ││
│ │   │   └── Generate verification score (0.0-1.0)                              │    ││
│ │   │                                                                           │    ││
│ │   └───────────────────────────────────────────────────────────────────────────┘    ││
│ │           │                                                                         ││
│ │           ▼                                                                         ││
│ │   ┌───────────────────────────────────────────────────────────────────────────┐    ││
│ │   │  Score >= 0.7  ────────────────▶  PASS (is_valid = True)                 │    ││
│ │   │  Score <  0.7  ────────────────▶  SELF-CORRECT (retry with feedback)     │    ││
│ │   └───────────────────────────────────────────────────────────────────────────┘    ││
│ │                                                                                     ││
│ │   Status Levels:                                                                    ││
│ │   ├── VERIFIED: Fully supported by context                                         ││
│ │   ├── PARTIALLY_VERIFIED: Mostly supported                                         ││
│ │   ├── UNVERIFIED: Not supported                                                    ││
│ │   └── HALLUCINATION: Clear fabrication                                             ││
│ │                                                                                     ││
│ └─────────────────────────────────────────────────────────────────────────────────────┘│
└────────────────────────────────────────┬────────────────────────────────────────────────┘
                                         │
                                         ▼
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│ STAGE 2: POST-PROCESSING                                                                │
│ ┌─────────────────────────────────────────────────────────────────────────────────────┐│
│ │   ├── Clean text formatting                                                        ││
│ │   ├── Fix grammar & readability                                                    ││
│ │   ├── Remove technical artifacts (tool call remnants)                             ││
│ │   ├── Format as numbered lists (if appropriate)                                   ││
│ │   └── Add emotional acknowledgment                                                 ││
│ └─────────────────────────────────────────────────────────────────────────────────────┘│
└────────────────────────────────────────┬────────────────────────────────────────────────┘
                                         │
                                         ▼
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│ STAGE 3: CITATION                                                                       │
│ ┌─────────────────────────────────────────────────────────────────────────────────────┐│
│ │   ├── Add source references from retrieved documents                               ││
│ │   ├── Link claims to specific sources                                              ││
│ │   ├── Maintain citation trail for transparency                                     ││
│ │   └── Handle missing citations gracefully                                          ││
│ │                                                                                     ││
│ │   Citation Format:                                                                  ││
│ │   [Source: document_title, collection: visa_oracle]                                ││
│ └─────────────────────────────────────────────────────────────────────────────────────┘│
└────────────────────────────────────────┬────────────────────────────────────────────────┘
                                         │
                                         ▼
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│ STAGE 4: FORMAT                                                                         │
│ ┌─────────────────────────────────────────────────────────────────────────────────────┐│
│ │   ├── Final formatting                                                             ││
│ │   ├── Language-specific adjustments (ID/EN)                                        ││
│ │   ├── Persona-aware styling (JAKSEL/BALI)                                         ││
│ │   └── Validate output format                                                       ││
│ └─────────────────────────────────────────────────────────────────────────────────────┘│
└────────────────────────────────────────┬────────────────────────────────────────────────┘
                                         │
                                         ▼
                              FINAL VERIFIED RESPONSE
```

---

## 🧠 MEMORY SYSTEM

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                 MEMORY ARCHITECTURE                                      │
└─────────────────────────────────────────────────────────────────────────────────────────┘

                         ┌─────────────────────────────┐
                         │    MEMORY ORCHESTRATOR      │
                         │    (Centralized Control)    │
                         └─────────────┬───────────────┘
                                       │
           ┌───────────────────────────┼───────────────────────────┐
           │                           │                           │
           ▼                           ▼                           ▼
┌─────────────────────┐   ┌─────────────────────┐   ┌─────────────────────┐
│   EPISODIC MEMORY   │   │  COLLECTIVE MEMORY  │   │   FACT EXTRACTOR    │
│                     │   │                     │   │                     │
│ • Session history   │   │ • Group patterns    │   │ • Auto-extraction   │
│ • Conversation      │   │ • Shared knowledge  │   │ • Pattern matching  │
│   continuity        │   │ • Trend analysis    │   │ • Preference detect │
│ • User interactions │   │ • Aggregated prefs  │   │ • Context enrich    │
└─────────┬───────────┘   └─────────┬───────────┘   └─────────┬───────────┘
          │                         │                         │
          └─────────────────────────┼─────────────────────────┘
                                    │
                                    ▼
                    ┌───────────────────────────────┐
                    │        POSTGRESQL             │
                    │     (Persistent Storage)      │
                    ├───────────────────────────────┤
                    │  Tables:                      │
                    │  ├── memory_facts             │
                    │  ├── episodic_memories        │
                    │  ├── user_preferences         │
                    │  └── conversation_history     │
                    └───────────────────────────────┘


┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                              SEMANTIC CACHE                                              │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                         │
│   ┌─────────────────────────────────────────────────────────────────────────────────┐  │
│   │                              REDIS BACKEND                                      │  │
│   │                                                                                 │  │
│   │   Query ──▶ Embedding ──▶ Similarity Search (cosine, threshold: 0.95)          │  │
│   │                                │                                                │  │
│   │                    ┌───────────┴───────────┐                                   │  │
│   │                    │                       │                                   │  │
│   │                    ▼                       ▼                                   │  │
│   │              ┌──────────┐           ┌──────────┐                              │  │
│   │              │   HIT    │           │   MISS   │                              │  │
│   │              │          │           │          │                              │  │
│   │              │ Return   │           │ Process  │                              │  │
│   │              │ cached   │           │ query &  │                              │  │
│   │              │ response │           │ cache    │                              │  │
│   │              │ (150ms)  │           │ result   │                              │  │
│   │              └──────────┘           └──────────┘                              │  │
│   │                                                                                 │  │
│   │   Config: TTL=1 hour, Max entries=10,000, LRU eviction                         │  │
│   │                                                                                 │  │
│   │   Performance Impact:                                                           │  │
│   │   ├── Latency: 800ms → 150ms (-81%)                                           │  │
│   │   ├── API costs: -50%                                                          │  │
│   │   └── Database load: -70%                                                      │  │
│   │                                                                                 │  │
│   └─────────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 📊 FINAL RESPONSE STRUCTURE

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                              AgenticQueryResponse                                        │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                         │
│   {                                                                                     │
│     "answer": "B211A visa adalah visa kunjungan tunggal...",                           │
│                                                                                         │
│     "sources": [                                                                        │
│       {                                                                                 │
│         "title": "B211A Visa Requirements",                                            │
│         "collection": "visa_oracle",                                                   │
│         "relevance_score": 0.94                                                        │
│       }                                                                                 │
│     ],                                                                                  │
│                                                                                         │
│     "verification_score": 0.87,                                                        │
│     "verification_status": "VERIFIED",                                                 │
│                                                                                         │
│     "context_length": 4521,                                                            │
│     "execution_time": 2.34,                                                            │
│                                                                                         │
│     "route_used": "visa_oracle",                                                       │
│     "model_used": "gemini-2.5-flash",                                                  │
│                                                                                         │
│     "tools_called": 2,                                                                 │
│     "total_steps": 3,                                                                  │
│                                                                                         │
│     "debug_info": {                                                                    │
│       "cache_hit": false,                                                              │
│       "rerank_applied": true,                                                          │
│       "fallback_used": false                                                           │
│     }                                                                                   │
│   }                                                                                     │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 🏛️ SYSTEM STATISTICS

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                              SYSTEM METRICS                                              │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                         │
│   BACKEND                           KNOWLEDGE BASE                                      │
│   ├── API Routes: 199               ├── Total Documents: 53,757+                       │
│   ├── Modules: 298                  ├── Collections: 15+                               │
│   ├── Services: 79                  ├── KBLI Codes: 8,886                              │
│   └── Agents: 5                     ├── Legal Docs: 5,041                              │
│                                     ├── Visa Docs: 1,612                               │
│   PERFORMANCE                       └── Tax Docs: 895                                  │
│   ├── Avg Response: 2-3s                                                               │
│   ├── Cache Hit Rate: ~40%          MODELS                                             │
│   ├── Verification Rate: 95%        ├── Primary: Gemini 2.5 Flash                     │
│   └── Max ReAct Steps: 5            ├── Embeddings: text-embedding-3-small (1536D)    │
│                                     └── Reranker: Ze-Rank 2                            │
│   INFRASTRUCTURE                                                                        │
│   ├── Deploy: Fly.io (Singapore)                                                       │
│   ├── Vector DB: Qdrant Cloud                                                          │
│   ├── Database: PostgreSQL (Fly)                                                       │
│   └── Cache: Redis                                                                      │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

---

*Generated: 2025-12-23 | ZANTARA RAG System v5.4*
