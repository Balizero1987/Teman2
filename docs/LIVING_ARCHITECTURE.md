# LIVING ARCHITECTURE

*Auto-generated by The Scribe on 2026-01-06 19:45:18*

> **Note:** This document is automatically updated. Do not edit manually.

---

## Table of Contents

- [API Endpoints](#api-endpoints)
- [Modules](#modules)
- [Services](#services)
- [Agents](#agents)

---

## API Endpoints

### 

#### `GET /`

Root endpoint - health check

**File:** `app/routers/root_endpoints.py`

---

#### `GET /api/csrf-token`

Generate CSRF token and session ID for frontend security.
Returns token in both JSON body and response headers.

**File:** `app/routers/root_endpoints.py`

---

#### `GET /api/dashboard/stats`

Provide real-time stats for the Mission Control Dashboard.

PRODUCTION: Returns actual statistics from database and services.

**File:** `app/routers/root_endpoints.py`

---

#### `GET /api/intel/critical`

Get critical impact items

**File:** `app/routers/intel.py`

---

#### `GET /api/intel/metrics`

Get real-time system metrics for System Pulse dashboard

**File:** `app/routers/intel.py`

---

#### `GET /api/intel/staging/pending`

List items pending approval in staging area

**File:** `app/routers/intel.py`

---

#### `GET /api/intel/staging/preview/{type}/{item_id}`

Get full content of a staging item

**File:** `app/routers/intel.py`

---

#### `GET /api/intel/stats/{collection}`

Get statistics for a specific intel collection

**File:** `app/routers/intel.py`

---

#### `GET /api/intel/trends`

Get trending topics and keywords

**File:** `app/routers/intel.py`

---

#### `GET /api/v2/bali-zero/chat-stream`

Streaming chat endpoint using IntelligentRouter for RAG-based responses.

**File:** `app/streaming.py`

---

#### `GET /bali-zero/chat-stream`

Streaming chat endpoint using IntelligentRouter for RAG-based responses.

**File:** `app/streaming.py`

---

#### `POST /api/chat/stream`

Modern POST endpoint for chat streaming (JSON body).
Compatible with frontend Next.js client.

**File:** `app/streaming.py`

---

#### `POST /api/intel/scraper/submit`

Receive article from bali-intel-scraper and save to staging.

This endpoint acts as the bridge between the scraper and Intelligence Center.
Articles are classified as 'visa' or 'news' and saved to the appropriate
staging folder for team approval.

Flow:
1. Scraper POSTs article here
2. Backend classifies type (visa/news)
3. Saves to data/staging/{type}/{item_id}.json
4. Intelligence Center UI shows for manual approval
5. Team votes via Telegram
6. If approved ‚Üí ingested to Qdrant

**File:** `app/routers/intel.py`

---

#### `POST /api/intel/search`

Search intel news with semantic search

**File:** `app/routers/intel.py`

---

#### `POST /api/intel/staging/approve/{type}/{item_id}`

Initiate approval process by sending Telegram notification to team.

Now supports ENRICHED content with AI-generated images!

This endpoint triggers the voting process. The actual ingestion happens
when the team reaches majority (2/3) via Telegram callback.

Request body (optional):
{
    "enriched_data": {...},  # From ArticleEnrichmentService
    "image_path": "/path/to/image.jpg"  # From Gemini image generation
}

**File:** `app/routers/intel.py`

---

#### `POST /api/intel/staging/publish/{type}/{item_id}`

Publish approved item to Qdrant knowledge base and register in anti-duplicate system.

This endpoint:
1. Ingests article to Qdrant (knowledge base)
2. Registers article in anti-duplicate system
3. Archives to published folder

Should be called after team approval (manual or via Telegram).

**File:** `app/routers/intel.py`

---

#### `POST /api/intel/staging/reject/{type}/{item_id}`

Reject item and move to archive

**File:** `app/routers/intel.py`

---

#### `POST /api/intel/store`

Store intel news item in Qdrant

**File:** `app/routers/intel.py`

---

### Audio

#### `POST /audio/speech`

Generate speech from text (TTS). Returns audio/mpeg stream.

**File:** `app/routers/audio.py`

---

#### `POST /audio/transcribe`

Transcribe uploaded audio file to text.

**File:** `app/routers/audio.py`

---

### Collective Memory

#### `GET /api/collective-memory/facts`

Get all promoted collective facts.

Optional: filter by category.

**File:** `app/routers/collective_memory.py`

---

#### `GET /api/collective-memory/stats`

Get collective memory statistics.

**File:** `app/routers/collective_memory.py`

---

#### `POST /api/collective-memory/contribute`

Contribute a fact to collective memory.

When 3+ different users contribute/confirm the same fact,
it becomes "promoted" and is included in AI context for all users.

**File:** `app/routers/collective_memory.py`

---

#### `POST /api/collective-memory/refute`

Refute a collective memory fact.

Decreases confidence. If confidence drops below 0.2, fact is removed.

**File:** `app/routers/collective_memory.py`

---

### Episodic Memory

#### `DELETE /api/episodic-memory/events/{event_id}`

Delete an event from the user's timeline.

Users can only delete their own events.

**File:** `app/routers/episodic_memory.py`

---

#### `GET /api/episodic-memory/context`

Get a formatted context summary for AI prompts.

Returns recent events formatted as markdown for inclusion
in AI system prompts.

**File:** `app/routers/episodic_memory.py`

---

#### `GET /api/episodic-memory/stats`

Get user's episodic memory statistics.

Returns counts by event type and overall stats.

**File:** `app/routers/episodic_memory.py`

---

#### `GET /api/episodic-memory/timeline`

Get the user's event timeline.

Returns events in reverse chronological order (most recent first).
Optional filters:
- event_type: Filter by type (milestone, problem, etc.)
- emotion: Filter by emotional context
- start_date/end_date: Filter by date range
- limit: Maximum number of events (default 20)

**File:** `app/routers/episodic_memory.py`

---

#### `POST /api/episodic-memory/events`

Add an event to the user's episodic memory timeline.

Events track the user's journey through time:
- Milestones achieved
- Problems encountered
- Resolutions found
- Decisions made
- Meetings held
- Deadlines set

**File:** `app/routers/episodic_memory.py`

---

#### `POST /api/episodic-memory/extract`

Automatically extract an event from a message and save it.

Looks for temporal references like:
- "oggi", "today", "yesterday"
- "N giorni fa", "days ago"
- "last week", "settimana scorsa"
- Specific dates: DD/MM, DD/MM/YYYY

If no temporal reference is found, no event is created.

**File:** `app/routers/episodic_memory.py`

---

### Google Drive

#### `GET /api/integrations/google-drive/auth/url`

Get OAuth authorization URL for connecting Google Drive.

Returns URL to redirect user to for Google consent.

**File:** `app/routers/google_drive.py`

---

#### `GET /api/integrations/google-drive/callback`

OAuth callback endpoint.

Google redirects here after user grants consent.

**File:** `app/routers/google_drive.py`

---

#### `GET /api/integrations/google-drive/files`

List files in a folder.

Files are filtered based on user's Google Drive permissions.

**File:** `app/routers/google_drive.py`

---

#### `GET /api/integrations/google-drive/files/{file_id}`

Get file metadata.

**File:** `app/routers/google_drive.py`

---

#### `GET /api/integrations/google-drive/my-folder`

Get current user's personal folder.

Returns the folder matching user's name in the team structure.

**File:** `app/routers/google_drive.py`

---

#### `GET /api/integrations/google-drive/search`

Search files by name.

**File:** `app/routers/google_drive.py`

---

#### `GET /api/integrations/google-drive/status`

Check if user has connected Google Drive.

**File:** `app/routers/google_drive.py`

---

#### `GET /api/integrations/google-drive/system/authorize`

Get OAuth authorization URL for connecting SYSTEM Google Drive.

ADMIN ONLY: Only zero@balizero.com and antonellosiano@gmail.com can authorize.
This connects antonellosiano@gmail.com's 30TB account for all team members.

**File:** `app/routers/google_drive.py`

---

#### `GET /api/integrations/google-drive/system/status`

Check if system-wide Google Drive OAuth is connected.
This token is used by all team members for file operations.

**File:** `app/routers/google_drive.py`

---

#### `POST /api/integrations/google-drive/disconnect`

Disconnect Google Drive for current user.

**File:** `app/routers/google_drive.py`

---

#### `POST /api/integrations/google-drive/system/disconnect`

Disconnect system-wide Google Drive OAuth.

ADMIN ONLY: Only admin emails can disconnect the SYSTEM account.

**File:** `app/routers/google_drive.py`

---

### News

#### `GET /api/news`

List news items with filtering, search, and pagination.

**Response Model:** `NewsListResponse`

**File:** `app/routers/news.py`

---

#### `GET /api/news/categories`

Get available news categories with counts

**File:** `app/routers/news.py`

---

#### `GET /api/news/feed/rss`

Generate RSS feed for news items

**File:** `app/routers/news.py`

---

#### `GET /api/news/{slug}`

Get a single news item by slug and increment view count

**File:** `app/routers/news.py`

---

#### `PATCH /api/news/{news_id}/status`

Update news item status (approve/reject)

**File:** `app/routers/news.py`

---

#### `POST /api/news`

Create a new news item (from scraper or manual)

**File:** `app/routers/news.py`

---

#### `POST /api/news/bulk`

Create multiple news items at once (for scraper batch uploads)

**File:** `app/routers/news.py`

---

#### `POST /api/news/subscribe`

Subscribe to news alerts

**File:** `app/routers/news.py`

---

#### `POST /api/news/unsubscribe`

Unsubscribe from news alerts

**File:** `app/routers/news.py`

---

### Oracle INGEST

#### `GET /api/oracle/collections`

List all available collections

**Returns:**
- List of collection names
- Document counts for each collection

**File:** `app/routers/oracle_ingest.py`

---

#### `POST /api/oracle/ingest`

Bulk ingest documents into Qdrant collection

**Usage:**
```python
import requests

chunks = [
    {
        "content": "### PP-28-2025 - Pasal 1\n\nContent here...",
        "metadata": {
            "law_id": "PP-28-2025",
            "pasal": "1",
            "category": "business_licensing",
            "type": "legal_regulation"
        }
    }
]

response = requests.post(
    "https://nuzantara-rag.fly.dev/api/oracle/ingest",
    json={"collection": "legal_intelligence", "documents": chunks}
)
```

**Rate Limits:**
- Max 1000 documents per request
- Batch processing for large uploads

**Response Model:** `IngestResponse`

**File:** `app/routers/oracle_ingest.py`

---

### Oracle v5.3 - Ultra Hybrid

#### `GET /api/oracle/drive/test`

Test Google Drive integration

**File:** `app/routers/oracle_universal.py`

---

#### `GET /api/oracle/gemini/test`

Test Google Gemini integration

**File:** `app/routers/oracle_universal.py`

---

#### `GET /api/oracle/health`

Health check for Oracle v5.3 services

**File:** `app/routers/oracle_universal.py`

---

#### `GET /api/oracle/user/profile/{user_email}`

Get user profile with localization preferences

**File:** `app/routers/oracle_universal.py`

---

#### `POST /api/oracle/feedback`

Submit user feedback for continuous learning and system improvement

**File:** `app/routers/oracle_universal.py`

---

#### `POST /api/oracle/query`

Ultra Hybrid Oracle Query - v5.3 (Refactored)
Integrates Qdrant search, Google Drive, and Gemini reasoning via OracleService.

**Response Model:** `OracleQueryResponse`

**File:** `app/routers/oracle_universal.py`

---

### Preview

#### `GET /preview/`

List all available previews (dev only)

**File:** `app/routers/preview.py`

---

#### `GET /preview/{article_id}.html`

Serve HTML preview for article.
Used by Telegram messages to show full article with images.

Example: https://nuzantara-rag.fly.dev/preview/19d416944a15.html

**File:** `app/routers/preview.py`

---

#### `POST /preview/upload`

Upload HTML preview from scraper (running locally on Mac).

Called by scraper BEFORE sending Telegram message, so the preview
link is ready when team clicks it.

Example:
    POST /preview/upload
    {
        "article_id": "19d416944a15",
        "html_content": "<html>...</html>"
    }

**File:** `app/routers/preview.py`

---

### Team Drive

#### `DELETE /api/drive/files/{file_id}`

Delete a file or folder (move to trash by default).

**File:** `app/routers/team_drive.py`

---

#### `DELETE /api/drive/files/{file_id}/permissions/{permission_id}`

Remove permission. All authenticated users can manage permissions.

**File:** `app/routers/team_drive.py`

---

#### `GET /api/drive/files`

List files in a folder or search across all shared files.
Files are filtered based on user's folder_access_rules permissions.

- If `folder_id` is provided, lists contents of that folder
- If `q` is provided, searches for files matching the query
- Otherwise, lists root-level folders filtered by permissions

**Response Model:** `FileListResponse`

**File:** `app/routers/team_drive.py`

---

#### `GET /api/drive/files/{file_id}`

Get metadata for a specific file.

**File:** `app/routers/team_drive.py`

---

#### `GET /api/drive/files/{file_id}/download`

Download a file's content.

For Google Docs/Sheets/Slides, exports to PDF/XLSX.
For regular files, downloads the content directly.

**File:** `app/routers/team_drive.py`

---

#### `GET /api/drive/files/{file_id}/permissions`

List permissions for a file/folder.
All authenticated users can view who has access.
Zero is hidden from other users (invisible admin).

**File:** `app/routers/team_drive.py`

---

#### `GET /api/drive/folders/{folder_id}/path`

Get the breadcrumb path to a folder.

**File:** `app/routers/team_drive.py`

---

#### `GET /api/drive/search`

Search for files by name.

**File:** `app/routers/team_drive.py`

---

#### `GET /api/drive/status`

Check if Drive integration is configured and accessible.

Shows OAuth status if connected (30TB quota).

**File:** `app/routers/team_drive.py`

---

#### `PATCH /api/drive/files/{file_id}/move`

Move a file to a different folder.

**Response Model:** `OperationResponse`

**File:** `app/routers/team_drive.py`

---

#### `PATCH /api/drive/files/{file_id}/permissions/{permission_id}`

Update permission role. All authenticated users can manage permissions.

**Response Model:** `PermissionItem`

**File:** `app/routers/team_drive.py`

---

#### `PATCH /api/drive/files/{file_id}/rename`

Rename a file or folder.

**Response Model:** `OperationResponse`

**File:** `app/routers/team_drive.py`

---

#### `POST /api/drive/files/create`

Create a new Google Doc, Sheet, or Slides.

**Response Model:** `OperationResponse`

**File:** `app/routers/team_drive.py`

---

#### `POST /api/drive/files/upload`

Upload a file to Google Drive.

**Response Model:** `OperationResponse`

**File:** `app/routers/team_drive.py`

---

#### `POST /api/drive/files/{file_id}/copy`

Copy a file.

**Response Model:** `OperationResponse`

**File:** `app/routers/team_drive.py`

---

#### `POST /api/drive/files/{file_id}/permissions`

Add permission for a user. All authenticated users can manage permissions.

**Response Model:** `PermissionItem`

**File:** `app/routers/team_drive.py`

---

#### `POST /api/drive/folders`

Create a new folder.

**Response Model:** `OperationResponse`

**File:** `app/routers/team_drive.py`

---

### admin-logs

#### `GET /api/admin/logs/activity`

Get activity logs with filters

Returns:
    Activity logs matching filters

**File:** `app/routers/admin_logs.py`

---

#### `GET /api/admin/logs/api-audit`

Get API audit trail

Returns:
    API calls matching filters

**File:** `app/routers/admin_logs.py`

---

#### `GET /api/admin/logs/interactions`

Get team interactions (chat, WhatsApp, email, calls)

Returns:
    Team interactions matching filters

**File:** `app/routers/admin_logs.py`

---

#### `GET /api/admin/logs/summary/interactions`

Get team interactions summary

Returns:
    Summary of team interactions over specified period

**File:** `app/routers/admin_logs.py`

---

#### `GET /api/admin/logs/summary/today`

Get today's team activity summary

Returns:
    Summary of today's activity by team member

**File:** `app/routers/admin_logs.py`

---

### agentic-functions

#### `GET /api/agents/analytics/summary`

Get comprehensive analytics for all agentic functions

Performance: Cached for 3 minutes (reduces database load)

**File:** `app/routers/agents.py`

---

#### `GET /api/agents/compliance/alerts`

Get upcoming compliance alerts

Args:
    client_id: Filter by client
    severity: Filter by severity
    auto_notify: Automatically send notifications for alerts

**File:** `app/routers/agents.py`

---

#### `GET /api/agents/compliance/client/{client_id}`

Get all compliance items for a client

**File:** `app/routers/agents.py`

---

#### `GET /api/agents/ingestion/status`

Get status of automatic ingestion service

**File:** `app/routers/agents.py`

---

#### `GET /api/agents/journey/{journey_id}`

Get journey details and progress

**File:** `app/routers/agents.py`

---

#### `GET /api/agents/journey/{journey_id}/next-steps`

Get next available steps in the journey

**File:** `app/routers/agents.py`

---

#### `GET /api/agents/knowledge-graph/export`

Export knowledge graph in Neo4j-ready format

Formats:
- neo4j: Cypher queries for Neo4j (.cypher)
- json: JSON format (.json)
- graphml: GraphML format for Gephi/Cytoscape (.graphml)

**File:** `app/routers/agents.py`

---

#### `GET /api/agents/status`

Get status of all 10 agentic functions

Returns:
    Overall system status and capabilities

Performance: Cached for 5 minutes (90% faster on cache hit)

**File:** `app/routers/agents.py`

---

#### `POST /api/agents/compliance/track`

‚ö†Ô∏è AGENT 2: Proactive Compliance Monitor

Track compliance deadlines and get automatic alerts (60/30/7 days before)

Supported types:
- visa_expiry: KITAS, KITAP, passport expiry
- tax_filing: SPT Tahunan, PPh, PPn deadlines
- license_renewal: IMTA, NIB, business permits
- regulatory_change: Law/regulation changes

**File:** `app/routers/agents.py`

---

#### `POST /api/agents/ingestion/run`

ü§ñ AGENT 4: Auto Ingestion Orchestrator

‚ö†Ô∏è PLACEHOLDER ENDPOINT: Service exists but not wired into main_cloud.py
The AutoIngestionOrchestrator service is implemented but not initialized.

Automatically monitor and ingest updates from government sources

Sources:
- https://jdih.kemenkeu.go.id (Tax regulations)
- https://peraturan.bpk.go.id (Legal documents)
- https://jdih.kemendag.go.id (Trade regulations)
- https://ortax.org (Tax news)

**File:** `app/routers/agents.py`

---

#### `POST /api/agents/journey/create`

üéØ AGENT 1: Client Journey Orchestrator

Create a new multi-step client journey with automatic progress tracking

Example journeys:
- pt_pma_setup: Complete PT PMA company setup (7 steps)
- kitas_application: KITAS visa application (5 steps)
- property_purchase: Property purchase process (6 steps)

**File:** `app/routers/agents.py`

---

#### `POST /api/agents/journey/{journey_id}/step/{step_id}/complete`

Mark a journey step as completed

**File:** `app/routers/agents.py`

---

#### `POST /api/agents/knowledge-graph/extract`

üß† AGENT 3: Knowledge Graph Builder

Extract entities and relationships from text to build knowledge graph.
Uses Semantic Extraction (LLM) if available, otherwise Regex patterns.

Entities: Person, Organization, Location, Document, Concept
Relationships: WORKS_FOR, LOCATED_IN, REQUIRES, RELATED_TO, etc.

**File:** `app/routers/agents.py`

---

#### `POST /api/agents/pricing/calculate`

üí∞ AGENT 6: Dynamic Pricing Service

Calculate pricing based on service type, complexity, and urgency

**File:** `app/routers/agents.py`

---

#### `POST /api/agents/research/autonomous`

üî¨ AGENT 7: Autonomous Research Service

Self-directed research agent that iteratively explores Qdrant collections
to answer complex or ambiguous queries without human intervention.

Example: "How to open a crypto company in Indonesia?"
‚Üí Iteration 1: Search kbli_eye ‚Üí "crypto" not in KBLI
‚Üí Iteration 2: Expand to legal_updates ‚Üí finds OJK crypto regulation
‚Üí Iteration 3: Search tax_genius ‚Üí crypto tax treatment
‚Üí Synthesis: Comprehensive answer

Args:
    topic: Research topic/question
    depth: standard (3 iterations), deep (5 iterations)
    sources: Optional list of specific collections to search

**File:** `app/routers/agents.py`

---

#### `POST /api/agents/synthesis/cross-oracle`

üîç AGENT 5: Cross-Oracle Synthesis

Search across multiple Oracle collections and synthesize integrated recommendations.

Example: "I want to open a restaurant in Canggu"
‚Üí Queries: kbli_eye, legal_architect, tax_genius, visa_oracle, property_knowledge
‚Üí Synthesizes: Integrated plan with KBLI code, legal structure, tax obligations, etc.

**File:** `app/routers/agents.py`

---

### agentic-rag

#### `POST /api/agentic-rag/query`

Esegue una query usando il sistema Agentic RAG completo.

**AUTHENTICATION REQUIRED**: This endpoint requires a valid JWT token.
The user_id is extracted from the authenticated user, not from the request body.

**Response Model:** `AgenticQueryResponse`

**File:** `app/routers/agentic_rag.py`

---

#### `POST /api/agentic-rag/stream`

Stream the Agentic RAG process (SSE).

**AUTHENTICATION REQUIRED**: This endpoint requires a valid JWT token.
The user_id is extracted from the authenticated user, not from the request body.

Supports conversation history via:
1. Direct conversation_history from frontend (preferred - works even if DB is down)
2. conversation_id or session_id lookup from database (fallback)

**File:** `app/routers/agentic_rag.py`

---

### analytics

#### `GET /api/analytics/alerts`

Get alert and error statistics

**Response Model:** `AlertStats`

**File:** `app/routers/analytics.py`

---

#### `GET /api/analytics/all`

Get all analytics in one request for initial dashboard load

**Response Model:** `AllAnalytics`

**File:** `app/routers/analytics.py`

---

#### `GET /api/analytics/crm`

Get CRM statistics

**Response Model:** `CRMStats`

**File:** `app/routers/analytics.py`

---

#### `GET /api/analytics/feedback`

Get feedback and quality statistics

**Response Model:** `FeedbackStats`

**File:** `app/routers/analytics.py`

---

#### `GET /api/analytics/llm-usage`

Get detailed LLM token usage and cost statistics.

This endpoint provides:
- Total tokens used (prompt + completion)
- Total cost in USD
- Breakdown by model
- Breakdown by endpoint
- Daily trend data

**Response Model:** `LLMUsageStats`

**File:** `app/routers/analytics.py`

---

#### `GET /api/analytics/overview`

Get overview statistics for the dashboard

**Response Model:** `OverviewStats`

**File:** `app/routers/analytics.py`

---

#### `GET /api/analytics/qdrant`

Get Qdrant vector database statistics

**Response Model:** `QdrantStats`

**File:** `app/routers/analytics.py`

---

#### `GET /api/analytics/rag`

Get RAG pipeline statistics

**Response Model:** `RAGStats`

**File:** `app/routers/analytics.py`

---

#### `GET /api/analytics/system`

Get system health statistics

**Response Model:** `SystemStats`

**File:** `app/routers/analytics.py`

---

#### `GET /api/analytics/team`

Get team productivity statistics

**Response Model:** `TeamStats`

**File:** `app/routers/analytics.py`

---

### authentication

#### `GET /api/auth/check`

Check if current session is valid

**File:** `app/routers/auth.py`

---

#### `GET /api/auth/csrf-token`

Generate CSRF token and session ID for frontend security.
Returns token in both JSON body and response headers.

**File:** `app/routers/auth.py`

---

#### `GET /api/auth/profile`

Get current user profile

**Response Model:** `UserProfile`

**File:** `app/routers/auth.py`

---

#### `POST /api/auth/login`

User login with email and PIN

Returns JWT token and user profile on successful authentication.
Also sets httpOnly cookie with JWT token and CSRF cookie.

**Response Model:** `LoginResponse`

**File:** `app/routers/auth.py`

---

#### `POST /api/auth/logout`

Logout user and clear authentication cookies.

Note: JWT tokens are stateless, so we only clear cookies.
Client should also discard any stored tokens.

**File:** `app/routers/auth.py`

---

#### `POST /api/auth/refresh`

Refresh JWT access token

Generates a new access token for the authenticated user without requiring
re-authentication. The user must provide a valid current token.
Also updates the httpOnly cookie with the new token.

**Response Model:** `LoginResponse`

**File:** `app/routers/auth.py`

---

### autonomous-tier1

#### `GET /api/autonomous-agents/executions`

List recent agent executions

Args:
    limit: Maximum number of executions to return (default: 20)

Returns:
    List of recent executions

**File:** `app/routers/autonomous_agents.py`

---

#### `GET /api/autonomous-agents/executions/{execution_id}`

Get status of a specific agent execution

Args:
    execution_id: Execution ID returned by agent run endpoint

Returns:
    Execution details and result

**Response Model:** `AgentExecutionResponse`

**File:** `app/routers/autonomous_agents.py`

---

#### `GET /api/autonomous-agents/knowledge-graph/extract-sample`

üî¨ Extract KG sample from Qdrant for review (DRY RUN)

Extracts entities and relationships from a sample of chunks
WITHOUT persisting to database. For review before commit.

Returns entities and relationships found for human approval.

**File:** `app/routers/autonomous_agents.py`

---

#### `GET /api/autonomous-agents/scheduler/status`

ü§ñ Get status of the Autonomous Scheduler and all registered tasks

Returns:
    Scheduler status with task details:
    - running: Whether scheduler is active
    - task_count: Number of registered tasks
    - tasks: Details of each task (intervals, run counts, errors)

**File:** `app/routers/autonomous_agents.py`

---

#### `GET /api/autonomous-agents/status`

Get status of all Tier 1 autonomous agents with execution statistics

Returns:
    Agent capabilities, execution statistics, and recent executions
    Format matches frontend AgentStatus interface

**File:** `app/routers/autonomous_agents.py`

---

#### `POST /api/autonomous-agents/client-value-predictor/run`

üí∞ Run Client LTV Predictor & Nurturing Agent

Scores all clients and sends personalized nurturing messages to:
- VIP clients (LTV > 80)
- High-risk clients (LTV < 30 and inactive > 30 days)

Returns:
    Execution status (agent runs in background)

**Response Model:** `AgentExecutionResponse`

**File:** `app/routers/autonomous_agents.py`

---

#### `POST /api/autonomous-agents/conversation-trainer/run`

ü§ñ Run Conversation Quality Trainer Agent

Analyzes high-rated conversations and generates prompt improvements

Args:
    days_back: Number of days to look back for conversations (default: 7)

Returns:
    Execution status (agent runs in background)

**Response Model:** `AgentExecutionResponse`

**File:** `app/routers/autonomous_agents.py`

---

#### `POST /api/autonomous-agents/knowledge-graph-builder/run`

üï∏Ô∏è Run Knowledge Graph Builder Agent

Extracts entities and relationships from conversations and builds knowledge graph

Args:
    days_back: Number of days to look back for conversations (default: 30)
    init_schema: Initialize database schema (default: False)

Returns:
    Execution status (agent runs in background)

**Response Model:** `AgentExecutionResponse`

**File:** `app/routers/autonomous_agents.py`

---

#### `POST /api/autonomous-agents/knowledge-graph/persist-sample`

üíæ Persist KG sample to database (LIVE)

Extracts and persists entities/relationships to PostgreSQL.
Run /extract-sample first to review!

**File:** `app/routers/autonomous_agents.py`

---

#### `POST /api/autonomous-agents/scheduler/task/{task_name}/disable`

‚è∏Ô∏è Disable a scheduled task

Args:
    task_name: Name of the task to disable

**File:** `app/routers/autonomous_agents.py`

---

#### `POST /api/autonomous-agents/scheduler/task/{task_name}/enable`

‚úÖ Enable a scheduled task

Args:
    task_name: Name of the task to enable

**File:** `app/routers/autonomous_agents.py`

---

### blog

#### `POST /api/blog/ask`

Public endpoint for AskZantara widget on blog articles.

Allows visitors to ask questions about article topics.
No authentication required.

**Response Model:** `BlogAskResponse`

**File:** `app/routers/blog_ask.py`

---

### conversations

#### `DELETE /api/bali-zero/conversations/clear`

Clear conversation history for the authenticated user

SECURITY: User identity is extracted from JWT token.

Query params:
- session_id: Optional session filter (if omitted, clears ALL conversations for user)

**File:** `app/routers/conversations.py`

---

#### `DELETE /api/bali-zero/conversations/{conversation_id}`

Delete a single conversation by ID

SECURITY: Only deletes conversation if it belongs to authenticated user.

**File:** `app/routers/conversations.py`

---

#### `GET /api/bali-zero/conversations/history`

Get conversation history for the authenticated user

SECURITY: User identity is extracted from JWT token.

Query params:
- limit: Max number of messages to return (default: 20)
- session_id: Optional session filter

**File:** `app/routers/conversations.py`

---

#### `GET /api/bali-zero/conversations/list`

List all conversations for the authenticated user

SECURITY: User identity is extracted from JWT token.

Query params:
- limit: Max number of conversations to return (default: 20)
- offset: Offset for pagination (default: 0)

Returns list with title (first user message), preview, and message count.

**Response Model:** `ConversationListResponse`

**File:** `app/routers/conversations.py`

---

#### `GET /api/bali-zero/conversations/memory/context`

Get user memory context (profile facts, summary, counters)

SECURITY: User identity is extracted from JWT token.

Returns the user's stored memory facts and context that the AI uses
to personalize responses.

**Response Model:** `UserMemoryContextResponse`

**File:** `app/routers/conversations.py`

---

#### `GET /api/bali-zero/conversations/stats`

Get conversation statistics for the authenticated user

SECURITY: User identity is extracted from JWT token.

**File:** `app/routers/conversations.py`

---

#### `GET /api/bali-zero/conversations/{conversation_id}`

Get a single conversation by ID

SECURITY: Only returns conversation if it belongs to authenticated user.

**Response Model:** `SingleConversationResponse`

**File:** `app/routers/conversations.py`

---

#### `POST /api/bali-zero/conversations/save`

Save conversation messages to PostgreSQL
+ Auto-populate CRM with client/practice data

SECURITY: User identity is extracted from JWT token, not request body.

Body:
{
    "messages": [{"role": "user", "content": "..."}, ...],
    "session_id": "optional-session-id",
    "metadata": {"key": "value"}
}

Returns:
{
    "success": true,
    "conversation_id": 123,
    "messages_saved": 10,
    "user_email": "authenticated-user@example.com",
    "crm": {
        "processed": true,
        "client_id": 42,
        "client_created": false,
        "client_updated": true,
        "practice_id": 15,
        "practice_created": true,
        "interaction_id": 88
    }
}

**File:** `app/routers/conversations.py`

---

### crm-auto

#### `GET /api/crm/auto/stats`

Get AUTO CRM extraction statistics

Returns:
- Total extractions (successful + failed)
- Clients created/updated
- Practices created
- Recent activity (24h, 7d)
- Average extraction confidence
- Top practice types extracted
- Recent extraction examples

Performance: Cached for 5 minutes.

**File:** `app/routers/crm_auto.py`

---

### crm-clients

#### `DELETE /api/crm/clients/{client_id}`

Delete a client (soft delete - marks as inactive)

This doesn't permanently delete the client, just marks them as inactive.

Access Control:
- Admin users: Can delete any client
- Team members: Can only delete clients assigned to them

**File:** `app/routers/crm_clients.py`

---

#### `GET /api/crm/clients/`

List clients with pagination and search.

Access Control:
- Admin users: See ALL clients
- Team members: See only clients assigned to them (assigned_to = email)

FILTERS:
- **status**: Filter by client status
- **assigned_to**: Filter by assigned team member (only works for admin)
- **search**: Search in name, email, phone fields
- **limit**: Max results (default: 50, max: 200)
- **offset**: For pagination

**File:** `app/routers/crm_clients.py`

---

#### `GET /api/crm/clients/by-email/{email}`

Get client by email address

Access Control:
- Admin users: Can view any client
- Team members: Can only view clients assigned to them

**Response Model:** `ClientResponse`

**File:** `app/routers/crm_clients.py`

---

#### `GET /api/crm/clients/metrics/summary`

Get CRM metrics summary for dashboard

**File:** `app/routers/crm_clients.py`

---

#### `GET /api/crm/clients/stats/overview`

Get overall client statistics

Returns counts by status, top assigned team members, etc.

Performance: Cached for 5 minutes to reduce database load.

**File:** `app/routers/crm_clients.py`

---

#### `GET /api/crm/clients/{client_id}`

Get client by ID

Access Control:
- Admin users: Can view any client
- Team members: Can only view clients assigned to them

**Response Model:** `ClientResponse`

**File:** `app/routers/crm_clients.py`

---

#### `GET /api/crm/clients/{client_id}/audit-trail`

Get audit trail for a specific client

**File:** `app/routers/crm_clients.py`

---

#### `GET /api/crm/clients/{client_id}/summary`

Get comprehensive client summary including:
- Basic client info
- All practices (active + completed)
- Recent interactions
- Documents
- Upcoming renewals

**File:** `app/routers/crm_clients.py`

---

#### `PATCH /api/crm/clients/{client_id}`

Update client information

Only provided fields will be updated. Other fields remain unchanged.

Access Control:
- Admin users: Can update any client
- Team members: Can only update clients assigned to them

**Response Model:** `ClientResponse`

**File:** `app/routers/crm_clients.py`

---

#### `POST /api/crm/clients/`

Create a new client

- **full_name**: Client's full name (required)
- **email**: Email address (optional but recommended)
- **phone**: Phone number
- **whatsapp**: WhatsApp number (can be same as phone)
- **nationality**: Client's nationality
- **passport_number**: Passport number
- **assigned_to**: Team member email to assign client to
- **avatar_url**: URL to client avatar image
- **tags**: Array of tags (e.g., ['vip', 'urgent'])

**Response Model:** `ClientResponse`

**File:** `app/routers/crm_clients.py`

---

#### `POST /api/crm/clients/metrics/refresh`

Force refresh of CRM metrics (Admin only)

**File:** `app/routers/crm_clients.py`

---

### crm-enhanced

#### `DELETE /api/crm/clients/{client_id}/documents/{doc_id}`

Archive or delete a document.

**File:** `app/routers/crm_enhanced.py`

---

#### `DELETE /api/crm/clients/{client_id}/family/{member_id}`

Delete a family member.

**File:** `app/routers/crm_enhanced.py`

---

#### `GET /api/crm/clients/{client_id}/documents`

Get all documents for a client, optionally filtered by category.

**File:** `app/routers/crm_enhanced.py`

---

#### `GET /api/crm/clients/{client_id}/family`

Get all family members for a client.

**File:** `app/routers/crm_enhanced.py`

---

#### `GET /api/crm/clients/{client_id}/profile`

Get enhanced client profile with family members, documents, and expiry alerts.

**File:** `app/routers/crm_enhanced.py`

---

#### `GET /api/crm/document-categories`

Get all document categories for dropdowns.

**File:** `app/routers/crm_enhanced.py`

---

#### `GET /api/crm/expiry-alerts`

Get all expiry alerts across all clients (for team dashboard).

**File:** `app/routers/crm_enhanced.py`

---

#### `GET /api/crm/expiry-alerts/summary`

Get summary counts of expiry alerts for dashboard.

**File:** `app/routers/crm_enhanced.py`

---

#### `PATCH /api/crm/clients/{client_id}/documents/{doc_id}`

Update a document.

**File:** `app/routers/crm_enhanced.py`

---

#### `PATCH /api/crm/clients/{client_id}/family/{member_id}`

Update a family member.

**File:** `app/routers/crm_enhanced.py`

---

#### `PATCH /api/crm/clients/{client_id}/profile`

Update client profile fields (avatar, Google Drive folder, etc.)

**File:** `app/routers/crm_enhanced.py`

---

#### `POST /api/crm/clients/{client_id}/documents`

Add a document to a client.

**File:** `app/routers/crm_enhanced.py`

---

#### `POST /api/crm/clients/{client_id}/family`

Add a family member to a client.

**File:** `app/routers/crm_enhanced.py`

---

### crm-interactions

#### `DELETE /api/crm/interactions/interactions/{interaction_id}`

Delete an interaction (soft delete - marks as archived).

**File:** `app/routers/crm_interactions.py`

---

#### `GET /api/crm/interactions/`

List interactions with optional filtering

**File:** `app/routers/crm_interactions.py`

---

#### `GET /api/crm/interactions/client/{client_id}/timeline`

Get complete interaction timeline for a client

**File:** `app/routers/crm_interactions.py`

---

#### `GET /api/crm/interactions/practice/{practice_id}/history`

Get all interactions related to a specific practice

**File:** `app/routers/crm_interactions.py`

---

#### `GET /api/crm/interactions/stats/overview`

Get interaction statistics

- Total interactions
- By type (chat, email, call, etc.)
- By sentiment
- By team member

Performance: Cached for 5 minutes to reduce database load.

**File:** `app/routers/crm_interactions.py`

---

#### `GET /api/crm/interactions/{interaction_id}`

Get full interaction details by ID

**File:** `app/routers/crm_interactions.py`

---

#### `POST /api/crm/interactions/`

Log a new interaction

**Types:**
- chat: Web chat conversation
- email: Email exchange
- whatsapp: WhatsApp message
- call: Phone call
- meeting: In-person or video meeting
- note: Internal note/comment

**Channels:**
- web_chat: ZANTARA chat widget
- gmail: Gmail integration
- whatsapp: WhatsApp Business
- phone: Phone call
- in_person: Face-to-face meeting

**Response Model:** `InteractionResponse`

**File:** `app/routers/crm_interactions.py`

---

#### `POST /api/crm/interactions/from-conversation`

Auto-create interaction record from a chat conversation

This is called automatically when a chat session ends or at intervals

**File:** `app/routers/crm_interactions.py`

---

### crm-portal-integration

#### `GET /api/crm/portal/activity/recent`

Get recent client portal activity.

For dashboard widget showing:
- New messages
- Document uploads
- Login activity

**File:** `app/routers/crm_portal_integration.py`

---

#### `GET /api/crm/portal/clients/{client_id}/messages`

Get message thread for a client (team view).

Same messages as client sees, but from team perspective.

**File:** `app/routers/crm_portal_integration.py`

---

#### `GET /api/crm/portal/clients/{client_id}/preview`

Get client's portal view data (for "View as Client" feature).

Returns the same data the client would see in their portal dashboard.

**File:** `app/routers/crm_portal_integration.py`

---

#### `GET /api/crm/portal/clients/{client_id}/status`

Check portal status for a client.

Returns:
- Whether client has portal access
- Portal user details if exists
- Pending invitation status

**File:** `app/routers/crm_portal_integration.py`

---

#### `GET /api/crm/portal/messages/unread-count`

Get count of unread messages from all clients.

For header notification badge.

**File:** `app/routers/crm_portal_integration.py`

---

#### `POST /api/crm/portal/clients/{client_id}/invite`

Send portal invitation to a client from CRM.

If email not provided, uses client's email from the clients table.

**File:** `app/routers/crm_portal_integration.py`

---

#### `POST /api/crm/portal/clients/{client_id}/messages`

Send a message to a client (team ‚Üí client).

**File:** `app/routers/crm_portal_integration.py`

---

#### `POST /api/crm/portal/clients/{client_id}/messages/{message_id}/read`

Mark a client message as read (team reading client's message).

**File:** `app/routers/crm_portal_integration.py`

---

### crm-practices

#### `DELETE /api/crm/practices/{practice_id}`

Delete a practice (soft delete - marks as cancelled).

Access Control:
- Admin users: Can delete any practice
- Team members: Can only delete practices for clients they are the Lead of

The practice is marked as 'cancelled' and not permanently deleted.

**File:** `app/routers/crm_practices.py`

---

#### `GET /api/crm/practices/`

List practices with optional filtering.

Access Control:
- Admin users (zero@balizero.com, role=admin): See ALL practices
- Team members: See only practices where they are the Lead (client.assigned_to = user email)

Returns practices with client and practice type information joined

**File:** `app/routers/crm_practices.py`

---

#### `GET /api/crm/practices/active`

Get all active practices (in progress, not completed/cancelled)

Optionally filter by assigned team member

**File:** `app/routers/crm_practices.py`

---

#### `GET /api/crm/practices/renewals/upcoming`

Get practices with upcoming renewal dates

Default: next 90 days

**File:** `app/routers/crm_practices.py`

---

#### `GET /api/crm/practices/stats/overview`

Get overall practice statistics

- Counts by status
- Counts by practice type
- Revenue metrics

Performance: Cached for 5 minutes to reduce database load.

**File:** `app/routers/crm_practices.py`

---

#### `GET /api/crm/practices/{practice_id}`

Get practice details by ID with full client and type info.

Access Control:
- Admin users: Can view any practice
- Team members: Can only view practices where they are the Lead

**File:** `app/routers/crm_practices.py`

---

#### `PATCH /api/crm/practices/{practice_id}`

Update practice information.

Access Control:
- Admin users: Can update any practice
- Team members: Can only update practices where they are the Lead

Common status values:
- inquiry
- quotation_sent
- payment_pending
- in_progress
- waiting_documents
- submitted_to_gov
- approved
- completed
- cancelled

**File:** `app/routers/crm_practices.py`

---

#### `POST /api/crm/practices/`

Create a new practice for a client

- **client_id**: ID of the client
- **practice_type_code**: Practice type code (retrieved from database)
- **status**: Initial status (default: 'inquiry')
- **quoted_price**: Price quoted to client
- **assigned_to**: Team member email to handle this

**Response Model:** `PracticeResponse`

**File:** `app/routers/crm_practices.py`

---

#### `POST /api/crm/practices/{practice_id}/documents/add`

Add a document to a practice

- **document_name**: Name/type of document (e.g., "Passport Copy")
- **drive_file_id**: Google Drive file ID
- **uploaded_by**: Email of person uploading

**File:** `app/routers/crm_practices.py`

---

### crm-shared-memory

#### `GET /api/crm/shared-memory/client/{client_id}/full-context`

Get complete context for a client
Everything the AI needs to know about this client

Returns:
- Client info
- All practices (active + completed)
- Recent interactions (last 20)
- Upcoming renewals
- Action items

**File:** `app/routers/crm_shared_memory.py`

---

#### `GET /api/crm/shared-memory/search`

Natural language search across CRM data

Examples:
- "clients with KITAS expiring soon"
- "active practices for John Smith"
- "recent interactions with antonello@balizero.com"
- "urgent practices"
- "PT PMA practices in progress"

Returns relevant results from clients, practices, and interactions

**File:** `app/routers/crm_shared_memory.py`

---

#### `GET /api/crm/shared-memory/team-overview`

Get team-wide CRM overview

Perfect for dashboard or team queries like:
- "How many active practices do we have?"
- "What's our workload distribution?"
- "Recent activity summary"

Performance: Cached for 5 minutes to reduce database load.

**File:** `app/routers/crm_shared_memory.py`

---

#### `GET /api/crm/shared-memory/upcoming-renewals`

Get all practices with upcoming renewal dates

Default: next 90 days

Performance: Cached for 10 minutes to reduce database load.

**File:** `app/routers/crm_shared_memory.py`

---

### dashboard

#### `GET /api/dashboard/neural-pulse`

Get real-time AI status metrics (Neural Pulse).

**File:** `app/routers/dashboard_summary.py`

---

#### `GET /api/dashboard/summary`

Get aggregated dashboard data in a single call.

Replaces 7 separate API calls with 1 optimized call.

**File:** `app/routers/dashboard_summary.py`

---

### debug

#### `DELETE /api/debug/traces`

Clear all stored traces.

Returns:
    Confirmation message

**File:** `app/routers/debug.py`

---

#### `GET /api/debug/db/queries/analyze`

Analyze database query patterns.

Returns:
    Query pattern analysis

**File:** `app/routers/debug.py`

---

#### `GET /api/debug/db/queries/recent`

Get recent database queries.

Args:
    limit: Maximum number of queries to return

Returns:
    Recent queries list

**File:** `app/routers/debug.py`

---

#### `GET /api/debug/db/queries/slow`

Get slow database queries.

Args:
    limit: Maximum number of queries to return

Returns:
    Slow queries list

**File:** `app/routers/debug.py`

---

#### `GET /api/debug/logs`

Get filtered logs.

Note: This is a placeholder. In production, you would integrate with
a logging service like CloudWatch, ELK, or similar.

Args:
    module: Optional module name filter
    level: Optional log level filter
    limit: Maximum number of logs

Returns:
    Logs data

**File:** `app/routers/debug.py`

---

#### `GET /api/debug/parent-documents-public/{document_id}`

Get parent documents (BAB) from PostgreSQL for a legal document.
PUBLIC endpoint for testing - NO AUTH REQUIRED.

Args:
    document_id: Document ID (e.g. "PP_31_2013")

Returns:
    List of BAB (chapters) with metadata

**File:** `app/routers/debug.py`

---

#### `GET /api/debug/parent-documents/{document_id}/{bab_id}/text`

Get full text of a specific BAB from PostgreSQL.

Args:
    document_id: Document ID
    bab_id: BAB ID (e.g. "PP_31_2013_BAB_III")

Returns:
    Full text of the BAB

**File:** `app/routers/debug.py`

---

#### `GET /api/debug/postgres/connection`

Test PostgreSQL connection and get connection info.

Args:
    request: FastAPI request (to access app.state for pool)

Returns:
    Connection information and status

**File:** `app/routers/debug.py`

---

#### `GET /api/debug/postgres/performance/connections`

Get connection statistics.

Returns:
    Connection statistics

**File:** `app/routers/debug.py`

---

#### `GET /api/debug/postgres/performance/locks`

Get active locks in the database.

Returns:
    Active locks list

**File:** `app/routers/debug.py`

---

#### `GET /api/debug/postgres/performance/slow-queries`

Get slow queries from pg_stat_statements (if available).

Args:
    limit: Maximum number of queries to return

Returns:
    Slow queries list

**File:** `app/routers/debug.py`

---

#### `GET /api/debug/postgres/schema/indexes`

Get list of all indexes.

Args:
    table_name: Optional table name to filter indexes

Returns:
    List of indexes

**File:** `app/routers/debug.py`

---

#### `GET /api/debug/postgres/schema/table/{table_name}`

Get detailed information about a table.

Args:
    table_name: Table name
    schema: Schema name (default: public)

Returns:
    Table details including columns, indexes, foreign keys, constraints

**File:** `app/routers/debug.py`

---

#### `GET /api/debug/postgres/schema/tables`

Get list of all tables in a schema.

Args:
    schema: Schema name (default: public)

Returns:
    List of tables

**File:** `app/routers/debug.py`

---

#### `GET /api/debug/postgres/stats/database`

Get global database statistics.

Returns:
    Database statistics

**File:** `app/routers/debug.py`

---

#### `GET /api/debug/postgres/stats/tables`

Get statistics for tables (row counts, sizes, indexes).

Args:
    table_name: Optional table name to filter stats

Returns:
    Table statistics

**File:** `app/routers/debug.py`

---

#### `GET /api/debug/qdrant/collection/{collection_name}/stats`

Get detailed statistics for a Qdrant collection.

Args:
    collection_name: Collection name

Returns:
    Collection statistics

**File:** `app/routers/debug.py`

---

#### `GET /api/debug/qdrant/collections/health`

Get health status of all Qdrant collections.

Returns:
    Collections health status

**File:** `app/routers/debug.py`

---

#### `GET /api/debug/rag/pipeline/{correlation_id}`

Get RAG pipeline trace for a correlation ID.

Note: This requires RAG pipeline to use RAGPipelineDebugger.

Args:
    correlation_id: Correlation ID

Returns:
    RAG pipeline trace

**File:** `app/routers/debug.py`

---

#### `GET /api/debug/request/{request_id}`

Get trace for a specific request.

Args:
    request_id: Request ID or correlation ID

Returns:
    Trace data

**File:** `app/routers/debug.py`

---

#### `GET /api/v1/debug/sentry-test`

Trigger a test error for Sentry monitoring verification.
This endpoint intentionally raises an exception to test Sentry integration.

SECURITY: Requires authentication to prevent abuse.

**File:** `app/routers/debug.py`

---

#### `GET /api/debug/services`

Get status of all services.

Args:
    request: FastAPI request

Returns:
    Services status

**File:** `app/routers/debug.py`

---

#### `GET /api/debug/state`

Get internal application state.

Args:
    request: FastAPI request

Returns:
    Application state information

**File:** `app/routers/debug.py`

---

#### `GET /api/debug/traces/recent`

Get recent request traces.

Args:
    limit: Maximum number of traces to return

Returns:
    Recent traces

**File:** `app/routers/debug.py`

---

#### `POST /api/debug/postgres/query`

Execute a read-only query safely.

Args:
    query_request: Query request with SQL and limit
    request: FastAPI request (to access app.state for pool)

Returns:
    Query results

**File:** `app/routers/debug.py`

---

#### `POST /api/debug/profile`

Run performance profiling analysis.

Note: This integrates with the existing performance_profiler.py script.
For full analysis, use the script directly: python scripts/performance_profiler.py

Returns:
    Profiling results summary

**File:** `app/routers/debug.py`

---

### feedback

#### `GET /api/v2/feedback/ratings/{session_id}`

Get rating for a specific conversation session

Args:
    session_id: Session ID of the conversation (UUID)
    req: FastAPI request object
    db_pool: Database connection pool

Returns:
    Rating data if found, 404 if not found

**Response Model:** `ConversationRatingResponse`

**File:** `app/routers/feedback.py`

---

#### `GET /api/v2/feedback/stats`

Get feedback statistics (Admin only - mock for now)

Returns:
    Statistics about review queue and feedback

**Response Model:** `ReviewQueueStatsResponse`

**File:** `app/routers/feedback.py`

---

#### `POST /api/v2/feedback/`

Submit conversation rating and feedback

CRITICAL LOGIC:
- If rating <= 2 OR correction_text is NOT empty -> Creates entry in review_queue with status 'pending'
- All feedback is saved to conversation_ratings table

Args:
    request: Rating request with session_id, rating, and optional feedback/correction
    req: FastAPI request object (for accessing user info)
    db_pool: Database connection pool

Returns:
    Success response with optional review_queue_id if created

**Response Model:** `FeedbackResponse`

**File:** `app/routers/feedback.py`

---

### handlers

#### `GET /api/handlers/category/{category}`

Get all handlers in a specific category

**File:** `app/routers/handlers.py`

---

#### `GET /api/handlers/list`

Returns complete registry of all available handlers
This is the master catalog that ZANTARA uses to see all available tools

**File:** `app/routers/handlers.py`

---

#### `GET /api/handlers/search`

Search handlers by name, path, or description

**File:** `app/routers/handlers.py`

---

### health

#### `GET /health`

System health check - Non-blocking during startup.

Returns "initializing" immediately if service not ready.
Prevents container crashes during warmup by not creating heavy objects.

**Response Model:** `HealthResponse`

**File:** `app/routers/health.py`

---

#### `GET /health/`

System health check - Non-blocking during startup.

Returns "initializing" immediately if service not ready.
Prevents container crashes during warmup by not creating heavy objects.

**Response Model:** `HealthResponse`

**File:** `app/routers/health.py`

---

#### `GET /health/detailed`

Detailed health check showing all service statuses.

Returns comprehensive information about each service for debugging
and monitoring purposes. Includes:
- Individual service status (healthy/degraded/unavailable)
- Error messages for failed services
- Database connectivity check
- Overall system health assessment

Returns:
    dict: Detailed health status with per-service breakdown

**File:** `app/routers/health.py`

---

#### `GET /health/live`

Kubernetes-style liveness probe.

Returns 200 if the application is running (even if not fully ready).
Used by orchestrators to determine if instance needs restart.

Returns:
    dict: Liveness status

**File:** `app/routers/health.py`

---

#### `GET /health/metrics/qdrant`

Qdrant operation metrics for monitoring performance.

Returns metrics including:
- Search operation counts and average latency
- Upsert operation counts and average latency
- Document counts processed
- Retry counts
- Error counts

**File:** `app/routers/health.py`

---

#### `GET /health/ready`

Kubernetes-style readiness probe.

Returns 200 only if critical services are ready to handle traffic.
Used by load balancers to determine if instance should receive traffic.

Returns:
    dict: Readiness status with critical service check

**File:** `app/routers/health.py`

---

### identity

#### `POST /team/login`

Team member login endpoint

Replicates the exact behavior of Node.js /api/auth/team/login endpoint.

- Validates email and PIN format
- Authenticates user against database
- Generates JWT token (7 days expiry)
- Sets httpOnly cookie with JWT token
- Returns user data and permissions

Returns:
    LoginResponse with JWT token and user data

**Response Model:** `LoginResponse`

**File:** `app/modules/identity/router.py`

---

### image

#### `POST /api/v1/image/generate`

Generate images using Google Imagen API

Args:
    request: Image generation request with prompt and parameters

Returns:
    ImageGenerationResponse with generated images or error

**Response Model:** `ImageGenerationResponse`

**File:** `app/routers/image_generation.py`

---

### ingestion

#### `GET /api/ingest/stats`

Get current database statistics.

Returns total documents, tier distribution, and collection info.

**File:** `app/routers/ingest.py`

---

#### `POST /api/ingest/batch`

Process all books in a directory.

- **directory_path**: Path to directory containing books
- **file_patterns**: File patterns to match (default: ["*.pdf", "*.epub"])
- **skip_existing**: Skip books already in database

**Response Model:** `BatchIngestionResponse`

**File:** `app/routers/ingest.py`

---

#### `POST /api/ingest/file`

Ingest a book from local file path.

- **file_path**: Path to PDF or EPUB file
- **title**: Optional book title
- **author**: Optional author name
- **tier_override**: Optional manual tier classification

**Response Model:** `BookIngestionResponse`

**File:** `app/routers/ingest.py`

---

#### `POST /api/ingest/upload`

Upload and ingest a single book.

- **file**: PDF or EPUB file
- **title**: Optional book title (auto-detected if not provided)
- **author**: Optional author name
- **tier_override**: Optional manual tier (S/A/B/C/D)

**Response Model:** `BookIngestionResponse`

**File:** `app/routers/ingest.py`

---

### knowledge

#### `GET /api/search/debug/parent-documents/{document_id}`

DEBUG endpoint: Get parent documents (BAB) from PostgreSQL for a document

**File:** `app/modules/knowledge/router.py`

---

#### `GET /api/search/health`

Quick health check for search service

**File:** `app/modules/knowledge/router.py`

---

#### `OPTIONS /api/search/`

Explicit OPTIONS handler for CORS preflight requests.
Fix for "Method Not Allowed" - ensures preflight requests succeed.

**File:** `app/modules/knowledge/router.py`

---

#### `POST /api/search`

Semantic search with tier-based access control.

- **query**: Search query text
- **level**: User access level (0-3)
- **limit**: Maximum results (1-50, default 5)
- **tier_filter**: Optional specific tier filter

Returns relevant book chunks filtered by user's access level.

REFACTORED: Now uses SearchService (canonical retriever) instead of KnowledgeService singleton.
This ensures consistent RAG pipeline across chat agentic and /api/search endpoints.

**Response Model:** `SearchResponse`

**File:** `app/modules/knowledge/router.py`

---

#### `POST /api/search/`

Semantic search with tier-based access control.

- **query**: Search query text
- **level**: User access level (0-3)
- **limit**: Maximum results (1-50, default 5)
- **tier_filter**: Optional specific tier filter

Returns relevant book chunks filtered by user's access level.

REFACTORED: Now uses SearchService (canonical retriever) instead of KnowledgeService singleton.
This ensures consistent RAG pipeline across chat agentic and /api/search endpoints.

**Response Model:** `SearchResponse`

**File:** `app/modules/knowledge/router.py`

---

### knowledge-visa

#### `GET /api/knowledge/visa/`

List all visa types, optionally filtered by category.

Categories: KITAS, KITAP, Tourist, Business, Social

**Response Model:** `VisaTypeListResponse`

**File:** `app/routers/knowledge_visa.py`

---

#### `GET /api/knowledge/visa/code/{code}`

Get a specific visa type by code (e.g., 'C316', 'KITAS-INVESTOR')

**Response Model:** `VisaTypeResponse`

**File:** `app/routers/knowledge_visa.py`

---

#### `GET /api/knowledge/visa/{visa_id}`

Get a specific visa type by ID

**Response Model:** `VisaTypeResponse`

**File:** `app/routers/knowledge_visa.py`

---

#### `POST /api/knowledge/visa/`

Create a new visa type (admin only)

**Response Model:** `VisaTypeResponse`

**File:** `app/routers/knowledge_visa.py`

---

#### `PUT /api/knowledge/visa/{visa_id}`

Update a visa type by ID

**Response Model:** `VisaTypeResponse`

**File:** `app/routers/knowledge_visa.py`

---

### legal-ingestion

#### `GET /api/legal/collections/stats`

Get statistics for legal document collection.

Args:
    collection_name: Collection name to query

Returns:
    Collection statistics

**File:** `app/routers/legal_ingest.py`

---

#### `GET /api/legal/parent-documents/{document_id}`

Get parent documents (BAB/chapters) from PostgreSQL for a legal document.
PUBLIC endpoint - no auth required.

Args:
    document_id: Document ID (e.g. "PP_31_2013")

Returns:
    List of BAB with metadata

**File:** `app/routers/legal_ingest.py`

---

#### `GET /api/legal/parent-documents/{document_id}/{bab_id}/text`

Get full text of a specific BAB from PostgreSQL.
PUBLIC endpoint - no auth required.

Args:
    document_id: Document ID
    bab_id: BAB ID (e.g. "PP_31_2013_BAB_III")

Returns:
    Full text of the BAB

**File:** `app/routers/legal_ingest.py`

---

#### `POST /api/legal/ingest`

Ingest a single legal document through the specialized pipeline.

Pipeline stages:
1. Clean: Remove headers/footers/noise
2. Extract Metadata: Type, number, year, topic
3. Parse Structure: BAB, Pasal, Ayat hierarchy
4. Chunk: Pasal-aware chunking with context injection
5. Embed & Store: Generate embeddings and store in Qdrant

Args:
    request: Legal ingestion request with file path and options

Returns:
    Ingestion result with metadata and statistics

**Response Model:** `LegalIngestResponse`

**File:** `app/routers/legal_ingest.py`

---

#### `POST /api/legal/ingest-batch`

Ingest multiple legal documents in batch.

Args:
    file_paths: List of file paths to ingest
    collection_name: Override collection name (optional)

Returns:
    Batch ingestion results

**File:** `app/routers/legal_ingest.py`

---

#### `POST /api/legal/parent-documents`

Register a parent document in PostgreSQL.
Used by ingestion scripts to track source documents for chunks.

Args:
    request: Parent document registration request

Returns:
    Registration result

**File:** `app/routers/legal_ingest.py`

---

#### `POST /api/legal/upload`

Upload and ingest a legal document via multipart/form-data.

This endpoint accepts file uploads from remote clients (unlike /ingest which
requires files to exist on the server).

Pipeline stages:
1. Save uploaded file temporarily
2. Clean: Remove headers/footers/noise
3. Extract Metadata: Type, number, year, topic
4. Parse Structure: BAB, Pasal, Ayat hierarchy
5. Chunk: Pasal-aware chunking with context injection
6. Embed & Store: Generate embeddings and store in Qdrant + PostgreSQL
7. Clean up temp file

Args:
    file: PDF file to ingest
    title: Optional document title (auto-extracted if not provided)
    tier: Optional tier override (S, A, B, C, D)
    collection_name: Optional collection name override

Returns:
    Ingestion result with metadata and statistics

**Response Model:** `LegalIngestResponse`

**File:** `app/routers/legal_ingest.py`

---

### media

#### `POST /media/generate-image`

Generate an image from a text prompt using pollinations.ai fallback.

This endpoint always succeeds if prompt is valid, returning a pollinations.ai URL.
No API key required.

**File:** `app/routers/media.py`

---

#### `POST /media/upload`

Upload a file (image, audio, doc) to the server.
Returns the URL/path to the file.

**File:** `app/routers/media.py`

---

### memory

#### `DELETE /api/memory/{memory_id}`

Delete memory from vector store

**File:** `app/routers/memory_vector.py`

---

#### `GET /api/memory/health`

Health check for memory vector service

**File:** `app/routers/memory_vector.py`

---

#### `GET /api/memory/stats`

Get memory collection statistics

**File:** `app/routers/memory_vector.py`

---

#### `POST /api/memory/embed`

Generate embedding for text.
Uses sentence-transformers (FREE, local) by default.

**Response Model:** `EmbedResponse`

**File:** `app/routers/memory_vector.py`

---

#### `POST /api/memory/init`

Reinitialize the semantic memory collection after deployments or resets.

**Response Model:** `InitResponse`

**File:** `app/routers/memory_vector.py`

---

#### `POST /api/memory/search`

Semantic search across all memories using vector similarity.

Supports metadata filtering:
- userId: Filter by specific user
- entities: Filter by entity (use {"entities": {"$contains": "zero"}})

**Response Model:** `MemorySearchResponse`

**File:** `app/routers/memory_vector.py`

---

#### `POST /api/memory/similar`

Find memories similar to a given memory.
Uses the stored memory's embedding to find neighbors.

**Response Model:** `MemorySearchResponse`

**File:** `app/routers/memory_vector.py`

---

#### `POST /api/memory/store`

Store memory in Qdrant for semantic search.

Metadata should include:
- userId: User ID
- type: Memory type (profile, expertise, event, etc)
- timestamp: ISO timestamp
- entities: Comma-separated entities

**File:** `app/routers/memory_vector.py`

---

### newsletter

#### `GET /api/blog/newsletter/subscribers`

List newsletter subscribers (admin endpoint).

**File:** `app/routers/newsletter.py`

---

#### `PATCH /api/blog/newsletter/preferences`

Update newsletter preferences.

**File:** `app/routers/newsletter.py`

---

#### `POST /api/blog/newsletter/confirm`

Confirm a newsletter subscription using the token from email.

**File:** `app/routers/newsletter.py`

---

#### `POST /api/blog/newsletter/log`

Log a newsletter send event (admin endpoint).

**File:** `app/routers/newsletter.py`

---

#### `POST /api/blog/newsletter/subscribe`

Subscribe to the newsletter.
Creates a new subscriber and sends confirmation email.

**Response Model:** `SubscribeResponse`

**File:** `app/routers/newsletter.py`

---

#### `POST /api/blog/newsletter/unsubscribe`

Unsubscribe from the newsletter.

**File:** `app/routers/newsletter.py`

---

### nusantara-health

#### `GET /api/nusantara/health`

Get system health visualized as Nusantara archipelago.
Each major system component is mapped to an Indonesian island.

**Response Model:** `NusantaraHealth`

**File:** `app/routers/nusantara_health.py`

---

### performance

#### `GET /api/performance/cache/stats`

Get cache statistics

**File:** `app/routers/performance.py`

---

#### `GET /api/performance/metrics`

Get performance metrics

**File:** `app/routers/performance.py`

---

#### `POST /api/performance/clear-cache`

Clear all caches

**File:** `app/routers/performance.py`

---

#### `POST /api/performance/clear-cache/embedding`

Clear embedding cache only

**File:** `app/routers/performance.py`

---

#### `POST /api/performance/clear-cache/search`

Clear search cache only

**File:** `app/routers/performance.py`

---

### portal

#### `GET /api/portal/companies`

Get list of client's companies.

For multi-company support - returns all linked companies.

**File:** `app/routers/portal.py`

---

#### `GET /api/portal/company/{company_id}`

Get detailed company information.

Returns:
- Company profile
- License status
- Compliance calendar
- Related documents

**File:** `app/routers/portal.py`

---

#### `GET /api/portal/dashboard`

Get client dashboard overview.

Returns summary of:
- Active visa status
- Company status
- Tax status
- Pending documents
- Unread messages
- Required actions

**File:** `app/routers/portal.py`

---

#### `GET /api/portal/documents`

Get client's documents.

Only returns client-visible documents.
Optional filter by document type.

**File:** `app/routers/portal.py`

---

#### `GET /api/portal/messages`

Get message thread (polling endpoint).

Returns messages with pagination.
Frontend polls this endpoint every 30s.

**File:** `app/routers/portal.py`

---

#### `GET /api/portal/profile`

Get client profile information.

**File:** `app/routers/portal.py`

---

#### `GET /api/portal/settings`

Get client preferences/settings.

**File:** `app/routers/portal.py`

---

#### `GET /api/portal/taxes`

Get tax overview and calendar.

Returns:
- Tax obligations status
- Upcoming deadlines
- Tax history

**File:** `app/routers/portal.py`

---

#### `GET /api/portal/visa`

Get visa and immigration status.

Returns:
- Current visa details
- Visa history
- Immigration documents
- Renewal warnings

**File:** `app/routers/portal.py`

---

#### `PATCH /api/portal/settings`

Update client preferences/settings.

**File:** `app/routers/portal.py`

---

#### `POST /api/portal/company/{company_id}/select`

Set primary company for dashboard context.

**File:** `app/routers/portal.py`

---

#### `POST /api/portal/documents/upload`

Upload a document for the client.

Accepts multipart form data with:
- file: The document file
- document_type: Type of document (passport, nib, etc.)
- practice_id: Optional practice to link to

**File:** `app/routers/portal.py`

---

#### `POST /api/portal/messages`

Send a message to the team.

**File:** `app/routers/portal.py`

---

#### `POST /api/portal/messages/{message_id}/read`

Mark a message as read.

**File:** `app/routers/portal.py`

---

### portal-invite

#### `GET /api/portal/invite/client/{client_id}`

Get all invitations for a client (team member action).

Returns invitation history with status (pending/used/expired).

**File:** `app/routers/portal_invite.py`

---

#### `GET /api/portal/invite/validate/{token}`

Validate invitation token (public endpoint).

Called when client clicks invite link. Returns client info if valid.

**File:** `app/routers/portal_invite.py`

---

#### `POST /api/portal/invite/complete`

Complete client registration by setting PIN (public endpoint).

Called after client validates token and sets their PIN.
Creates user account and returns login redirect.

**File:** `app/routers/portal_invite.py`

---

#### `POST /api/portal/invite/resend/{client_id}`

Resend invitation to a client (creates new token).

**File:** `app/routers/portal_invite.py`

---

#### `POST /api/portal/invite/send`

Send invitation to a client (team member action).

Requires team authentication. Creates invite token and sends email via Zoho.

**File:** `app/routers/portal_invite.py`

---

### public

#### `GET /api/public/bab/{document_id}`

Get BAB (Buku Acuan Bali) document by ID.

SECURITY: Requires authentication. Public prefix is for API organization only.

**File:** `app/modules/knowledge/router.py`

---

### sessions

#### `DELETE /api/sessions/{session_id}`

Delete a session

**File:** `app/routers/session.py`

---

#### `GET /api/sessions/analytics/overview`

Get analytics about all sessions

**File:** `app/routers/session.py`

---

#### `GET /api/sessions/health`

Health check for session service

**File:** `app/routers/session.py`

---

#### `GET /api/sessions/{session_id}`

Get conversation history for a session

**File:** `app/routers/session.py`

---

#### `GET /api/sessions/{session_id}/export`

Export session conversation

**File:** `app/routers/session.py`

---

#### `GET /api/sessions/{session_id}/info`

Get session metadata

**File:** `app/routers/session.py`

---

#### `POST /api/sessions/cleanup`

Cleanup expired sessions (no-op, Redis handles automatically)

**File:** `app/routers/session.py`

---

#### `POST /api/sessions/create`

Create a new conversation session

**File:** `app/routers/session.py`

---

#### `POST /api/sessions/{session_id}/extend`

Extend session TTL

**File:** `app/routers/session.py`

---

#### `POST /api/sessions/{session_id}/extend-custom`

Extend session TTL to custom duration

**File:** `app/routers/session.py`

---

#### `PUT /api/sessions/{session_id}`

Update conversation history for a session

**File:** `app/routers/session.py`

---

#### `PUT /api/sessions/{session_id}/ttl`

Update session with custom TTL

**File:** `app/routers/session.py`

---

### system-observability

#### `GET /api/admin/postgres/data`

Get raw data from a table (ADMIN ONLY)

**File:** `app/routers/system_observability.py`

---

#### `GET /api/admin/postgres/tables`

List all public tables in PostgreSQL (ADMIN ONLY)

**File:** `app/routers/system_observability.py`

---

#### `GET /api/admin/qdrant/collections`

List Qdrant collections with stats (ADMIN ONLY)

**File:** `app/routers/system_observability.py`

---

#### `GET /api/admin/qdrant/points`

Browse Qdrant points (ADMIN ONLY)

**File:** `app/routers/system_observability.py`

---

#### `GET /api/admin/system-health`

Get comprehensive system health report (ADMIN ONLY).

Aggregates status from:
- PostgreSQL (Connectivity + Latency)
- Qdrant (Vector DB Health)
- Redis (Cache Status)
- API (Self-check)
- System Metrics (CPU, RAM, Disk, Uptime)

**File:** `app/routers/system_observability.py`

---

### team

#### `GET /api/team/members`

Get list of team members visible to the current user.

Visibility rules:
1. User-specific visibility rules (team_member_visibility_rules table)
2. Department-based visibility (all users in same department)
3. Board/Founders see everyone

**File:** `app/routers/team.py`

---

### team-activity

#### `GET /api/team/activity/monthly`

Get monthly work summary (ADMIN ONLY)

Returns total hours, days worked, and averages for each team member.

**File:** `app/routers/team_activity.py`

---

#### `GET /api/team/activity/weekly`

Get weekly work summary (ADMIN ONLY)

Returns total hours, days worked, and averages for each team member.

**File:** `app/routers/team_activity.py`

---

#### `GET /api/team/export`

Export timesheet data (ADMIN ONLY)

Returns CSV file with all work hours in the specified date range.

**File:** `app/routers/team_activity.py`

---

#### `GET /api/team/health`

Health check for team activity service

**File:** `app/routers/team_activity.py`

---

#### `GET /api/team/hours`

Get work hours for a specific date (ADMIN ONLY)

Returns all team members' work hours for the specified date.

**File:** `app/routers/team_activity.py`

---

#### `GET /api/team/my-status`

Get my current work status

Returns:
- Current online/offline status
- Today's hours worked
- This week's summary

**Response Model:** `UserStatusResponse`

**File:** `app/routers/team_activity.py`

---

#### `GET /api/team/status`

Get current online status of all team members (ADMIN ONLY)

Shows who is currently clocked in and who is offline.

**File:** `app/routers/team_activity.py`

---

#### `POST /api/team/clock-in`

Clock in for work day

Team members use this to start their work day.
One clock-in per day allowed.

**Response Model:** `ClockResponse`

**File:** `app/routers/team_activity.py`

---

#### `POST /api/team/clock-out`

Clock out for work day

Team members use this to end their work day.
Must be clocked in first.

**Response Model:** `ClockResponse`

**File:** `app/routers/team_activity.py`

---

### team-analytics

#### `GET /api/team-analytics/burnout`

Detect early warning signs of burnout

**File:** `app/routers/team_analytics.py`

---

#### `GET /api/team-analytics/optimal-hours`

Identify most productive time windows

**File:** `app/routers/team_analytics.py`

---

#### `GET /api/team-analytics/patterns`

Analyze work hour patterns and habits

**File:** `app/routers/team_analytics.py`

---

#### `GET /api/team-analytics/productivity`

Calculate productivity scores for team members

**File:** `app/routers/team_analytics.py`

---

#### `GET /api/team-analytics/team-insights`

Generate comprehensive team collaboration insights

**File:** `app/routers/team_analytics.py`

---

#### `GET /api/team-analytics/trends/{user_email}`

Analyze performance trends over time

**File:** `app/routers/team_analytics.py`

---

#### `GET /api/team-analytics/workload-balance`

Analyze workload distribution across team

**File:** `app/routers/team_analytics.py`

---

### telegram

#### `DELETE /api/telegram/webhook`

Remove Telegram webhook.

**File:** `app/routers/telegram.py`

---

#### `GET /api/telegram/bot-info`

Get bot information.

**File:** `app/routers/telegram.py`

---

#### `GET /api/telegram/webhook-info`

Get current webhook configuration.

**File:** `app/routers/telegram.py`

---

#### `POST /api/telegram/setup-webhook`

Set up Telegram webhook.

If webhook_url is not provided, uses default Fly.io URL.

**File:** `app/routers/telegram.py`

---

#### `POST /api/telegram/webhook`

Telegram webhook endpoint.

Receives updates from Telegram and processes messages using RAG.

**File:** `app/routers/telegram.py`

---

### voice

#### `OPTIONS /api/voice/elevenlabs`

CORS preflight for ElevenLabs webhook.

**File:** `app/routers/voice.py`

---

#### `POST /api/voice/elevenlabs`

ElevenLabs Conversational AI webhook.

PUBLIC endpoint - no auth required for ElevenLabs to call.
Returns: {"result": "text response"}

**File:** `app/routers/voice.py`

---

#### `POST /api/voice/query`

Fast voice query endpoint.

Optimized for speed:
- Direct vector search (no agentic reasoning)
- Fast LLM (GPT-4o-mini)
- Short responses (2-3 sentences)

Expected latency: 5-8 seconds (vs 40s for agentic)

**Response Model:** `VoiceQueryResponse`

**File:** `app/routers/voice.py`

---

### zoho-email

#### `DELETE /api/integrations/zoho/disconnect`

Disconnect Zoho account and remove tokens.

Revokes OAuth tokens and clears all stored data.

**File:** `app/routers/zoho_email.py`

---

#### `DELETE /api/integrations/zoho/emails`

Move emails to trash.

Supports bulk deletion of multiple messages.

**File:** `app/routers/zoho_email.py`

---

#### `GET /api/integrations/zoho/auth/url`

Get Zoho OAuth authorization URL.

Returns URL to redirect user to Zoho login page.
The state parameter includes user_id for CSRF protection.

**File:** `app/routers/zoho_email.py`

---

#### `GET /api/integrations/zoho/callback`

OAuth callback handler.

Exchanges authorization code for tokens and stores them.
Redirects to /email page with success or error status.

**File:** `app/routers/zoho_email.py`

---

#### `GET /api/integrations/zoho/emails`

List emails in a folder with pagination and filtering.

Returns emails with pagination info.

**File:** `app/routers/zoho_email.py`

---

#### `GET /api/integrations/zoho/emails/search`

Search emails across all folders.

Returns matching emails.

**File:** `app/routers/zoho_email.py`

---

#### `GET /api/integrations/zoho/emails/{message_id}`

Get full email content.

Returns complete email with body and attachments.
Automatically marks the email as read.

**File:** `app/routers/zoho_email.py`

---

#### `GET /api/integrations/zoho/emails/{message_id}/attachments/{attachment_id}`

Download email attachment.

Returns attachment content as binary stream.

**File:** `app/routers/zoho_email.py`

---

#### `GET /api/integrations/zoho/folders`

List all email folders.

Returns object with folders list and unread counts.

**File:** `app/routers/zoho_email.py`

---

#### `GET /api/integrations/zoho/status`

Check if user has connected Zoho account.

Returns connection status with email and expiry information.

**Response Model:** `ConnectionStatusResponse`

**File:** `app/routers/zoho_email.py`

---

#### `GET /api/integrations/zoho/unread-count`

Get total unread email count.

Useful for displaying badge in navigation.

**File:** `app/routers/zoho_email.py`

---

#### `OPTIONS /api/integrations/zoho/emails`

Handle OPTIONS requests for DELETE /emails endpoint.

**File:** `app/routers/zoho_email.py`

---

#### `PATCH /api/integrations/zoho/emails/mark-read`

Mark emails as read or unread.

Supports bulk operation on multiple messages.

**File:** `app/routers/zoho_email.py`

---

#### `PATCH /api/integrations/zoho/emails/{message_id}/flag`

Flag or unflag an email.

**File:** `app/routers/zoho_email.py`

---

#### `POST /api/integrations/zoho/attachments`

Upload an attachment.
Expects multipart/form-data.

**File:** `app/routers/zoho_email.py`

---

#### `POST /api/integrations/zoho/drafts`

Save an email as draft.

**File:** `app/routers/zoho_email.py`

---

#### `POST /api/integrations/zoho/emails`

Send a new email.

Supports HTML content, CC/BCC, and attachments.

**File:** `app/routers/zoho_email.py`

---

#### `POST /api/integrations/zoho/emails/delete`

Move emails to trash (POST variant for better proxy compatibility).

Supports bulk deletion of multiple messages.

**File:** `app/routers/zoho_email.py`

---

#### `POST /api/integrations/zoho/emails/{message_id}/forward`

Forward an email.

Optionally add additional content to forwarded message.

**File:** `app/routers/zoho_email.py`

---

#### `POST /api/integrations/zoho/emails/{message_id}/reply`

Reply to an email.

Supports reply to sender only or reply all.

**File:** `app/routers/zoho_email.py`

---

## Modules

### Agents

#### `agents.__init__`

Agents Module - Autonomous Agent Framework
Contains agent implementations for conversation training, client prediction,
and knowledge graph building.

#### `agents.agents.__init__`

Agents Submodule - Individual Agent Implementations
Contains the core agent classes for different autonomous functions.

#### `agents.agents.client_value_predictor`

üí∞ CLIENT LIFETIME VALUE PREDICTOR
Predicts high-value clients and automatically nurtures them

Refactored to use modular services:
- ClientScoringService: Calculate LTV scores
- ClientSegmentationService: Segment clients and calculate risk
- NurturingMessageService: Generate personalized messages
- WhatsAppNotificationService: Send messages via Twilio

#### `agents.agents.conversation_trainer`

ü§ñ AUTONOMOUS CONVERSATION TRAINER
Learns from successful conversations and improves prompts automatically

#### `agents.agents.knowledge_graph_builder`

üï∏Ô∏è KNOWLEDGE GRAPH AUTO-BUILDER
Automatically builds and maintains a knowledge graph from all data sources

Refactored to use modular services:
- KnowledgeGraphSchema: Manage database schema
- EntityExtractor: Extract entities from text using AI
- RelationshipExtractor: Extract relationships between entities using AI
- KnowledgeGraphRepository: Database operations for entities and relationships

#### `agents.agents.schemas`

Pydantic schemas for agent input validation

#### `agents.agents.test_guardian`

üõ°Ô∏è AUTONOMOUS TEST GUARDIAN (v2026.1)
Part of Nuzantara Intelligent Business OS.

This agent operates as a specialized QA Engineer that:
1. Analyzes Codebase Coverage autonomously
2. Identifies critical gaps (files < 99% coverage)
3. Reads Context (imports & dependencies) to understand logic
4. Generates Robust Tests using LLM (Cloud or Local)
5. Self-Heals (runs -> fails -> fixes -> runs -> passes)
6. Commits changes to a dedicated branch

Usage:
    python -m backend.agents.agents.test_guardian --mode=auto --provider=gemini

#### `agents.services.__init__`

Agent Services - Modular services extracted from God Objects

Services:
- Client Scoring & Segmentation
- Nurturing & Notifications
- Knowledge Graph Operations

#### `agents.services.client_scoring`

Client Scoring Service

Responsibility: Calculate client lifetime value (LTV) scores from database data.

#### `agents.services.client_segmentation`

Client Segmentation Service

Responsibility: Segment clients and calculate risk levels based on LTV scores.

#### `agents.services.kg_extractors`

Knowledge Graph Extractors

Responsibility: Extract entities and relationships from text using AI.

#### `agents.services.kg_repository`

Knowledge Graph Repository

Responsibility: Database operations for knowledge graph (entities, relationships, queries).

UPDATED 2025-12-31: Migrated from legacy kg_entities/kg_relationships to kg_nodes/kg_edges schema.

#### `agents.services.kg_schema`

Knowledge Graph Schema Service

Responsibility: Manage knowledge graph database schema.

Updated Dec 2025 to use unified schema (kg_nodes/kg_edges).
Tables are created via migrations (028, 029), this service
just verifies they exist.

#### `agents.services.nurturing_message`

Nurturing Message Service

Responsibility: Generate personalized nurturing messages using AI.

#### `agents.services.whatsapp_notification`

WhatsApp Notification Service

Responsibility: Send WhatsApp messages via Twilio.

### App

#### `app.__init__`

ZANTARA RAG System - FastAPI Application

#### `app.auth.__init__`

Unified Authentication Module
Consolidates auth validation logic from multiple files

#### `app.auth.validation`

Unified Authentication Validation Module
Consolidates auth validation logic from main_cloud.py, hybrid_auth.py, and auth.py

This module provides a single source of truth for authentication validation,
eliminating code duplication across the codebase.

#### `app.core.__init__`

NUZANTARA PRIME - Core Module
Centralized configuration and core utilities

#### `app.core.circuit_breaker`

Circuit Breaker Pattern Implementation

Prevents cascading failures by stopping requests to failing services
and allowing them to recover.

#### `app.core.config`

NUZANTARA PRIME - Centralized Configuration
All environment variables centralized using pydantic-settings

#### `app.core.constants`

NUZANTARA PRIME - Application Constants
Centralized constants to replace magic numbers throughout the codebase

#### `app.core.error_classification`

Error Classification System

Provides standardized error classification (transient vs permanent) and
error handling utilities for the NUZANTARA platform.

#### `app.core.intel_approvers`

Intelligence Center - Telegram Approval Teams Configuration

Defines who receives Telegram notifications for approval voting.

#### `app.core.service_health`

ZANTARA RAG - Service Health Registry

Provides centralized tracking of service health status for fail-fast behavior
and health-based degradation in production environments.

#### `app.decorators.auth`

Authentication Decorators
Provides decorators for endpoint security classification and access control

#### `app.dependencies`

FastAPI Dependency Injection

Centralized dependencies for all routers to avoid circular imports.
Provides fail-fast behavior with clear error messages for service unavailability.

ARCHITECTURE:
- Services are initialized in app.setup.service_initializer::initialize_services()
- Services are stored in app.state (FastAPI standard)
- This module provides getter functions that routers can use via Depends()

PATTERN:
- All dependencies use Request object to access app.state
- This allows easy mocking in tests
- Fail-fast: raises HTTPException if service not initialized

See: app.setup.service_initializer::initialize_services() for initialization logic
Note: main_cloud.py still exports initialize_services() for backward compatibility

#### `app.feature_flags`

ZANTARA Feature Flags
Control experimental and optional features via environment variables

#### `app.lifecycle.__init__`

Lifecycle Management Module

Handles startup and shutdown lifecycle events for FastAPI application.

#### `app.lifecycle.shutdown`

Shutdown Lifecycle Handlers

Handles application shutdown events.

#### `app.lifecycle.startup`

Startup Lifecycle Handlers

Handles application startup events.

#### `app.main_cloud`

FastAPI entrypoint for the ZANTARA RAG backend.

This module serves as the minimal entry point for uvicorn.
All application setup is delegated to app.setup.app_factory.create_app().

Run via: uvicorn app.main_cloud:app --host 0.0.0.0 --port 8080

BACKWARD COMPATIBILITY:
- Exports app, initialize_services, initialize_plugins, on_startup, on_shutdown
- Exports utility functions: _parse_history, _allowed_origins, _safe_endpoint_label
- All exports maintain backward compatibility with existing tests and code

#### `app.metrics`

Enhanced Prometheus Metrics for ZANTARA-PERFECT-100
Provides detailed system monitoring and performance tracking

#### `app.models`

ZANTARA RAG - Pydantic Models

#### `app.models.feedback`

NUZANTARA PRIME - Feedback Module Data Layer
SQLModel models for conversation ratings and review queue

#### `app.modules.crm.__init__`

NUZANTARA PRIME - CRM Module
Client, Practice, and Interaction management

#### `app.modules.crm.models`

NUZANTARA PRIME - CRM Module Data Layer
SQLModel models for CRM system (clients, practices, interactions)

#### `app.modules.identity.__init__`

NUZANTARA PRIME - Identity Module
Authentication, Users, and Sessions management

#### `app.modules.identity.models`

NUZANTARA PRIME - Identity Module Data Layer
SQLModel models mapping to existing Node.js backend tables

#### `app.modules.identity.router`

NUZANTARA PRIME - Identity Router
HTTP API endpoints for authentication

#### `app.modules.identity.service`

NUZANTARA PRIME - Identity Service
Business logic for authentication and user management

#### `app.modules.knowledge.__init__`

NUZANTARA PRIME - Knowledge Module
RAG, Search, and Vector Database Interface

#### `app.modules.knowledge.router`

NUZANTARA PRIME - Knowledge Router
HTTP interface for RAG/Search operations

REFACTORED: Now uses SearchService (canonical retriever) instead of KnowledgeService singleton.
This eliminates duplicate RAG pipelines and cache collisions.

#### `app.modules.knowledge.service`

NUZANTARA PRIME - Knowledge Service
Business logic for RAG, Search, and Vector Database operations

DEPRECATED: This service is deprecated in favor of SearchService (canonical retriever).
It is kept only as a fallback for test/local boot scenarios where SearchService may not be initialized.

Migration path:
- Use SearchService from app.state.search_service (injected in main_cloud.py)
- For /api/search endpoint, use get_search_service(request) helper in router.py

#### `app.routers.admin_logs`

Admin Logs Router
Endpoints for querying team activity logs, interactions, and audit trail

Requires ADMIN_API_KEY for access

#### `app.routers.agentic_rag`

Agentic RAG API Router

#### `app.routers.agents`

ZANTARA Agentic Functions Router
Exposes all 10 advanced agentic capabilities as REST API endpoints

Phase 1-2: Foundation Agents (6)
Phase 3: Orchestration Agents (2)
Phase 4: Advanced Intelligence (1)
Phase 5: Automation (1)

Performance Optimizations:
- Redis caching (5 min TTL for status endpoints)
- Rate limiting (prevents abuse)
- Request deduplication

SECURITY: All endpoints require authentication (added 2025-12-03)

#### `app.routers.analytics`

Analytics Router
Provides comprehensive analytics endpoints for the Founder dashboard.
Access restricted to zero@balizero.com only.

#### `app.routers.auth`

JWT Authentication Router
Real email+PIN authentication using bcrypt and JWT tokens

#### `app.routers.autonomous_agents`

TIER 1 AUTONOMOUS AGENTS - HTTP Endpoints
Provides HTTP API for orchestrator to trigger autonomous agents

Agents:
1. Conversation Quality Trainer
2. Client LTV Predictor & Nurturing
3. Knowledge Graph Builder

#### `app.routers.blog_ask`

Blog Ask Router - AskZantara widget endpoint for public blog articles

#### `app.routers.collective_memory`

Collective Memory API Router
Endpoints for managing shared knowledge across users

#### `app.routers.conversations`

ZANTARA Conversations Router
Endpoints for persistent conversation history with PostgreSQL
+ Auto-CRM population from conversations

SECURITY: All endpoints require JWT authentication (added 2025-12-03)
User identity is taken from JWT token, NOT from request parameters.

Refactored: Migrated to asyncpg with connection pooling (2025-12-07)

#### `app.routers.crm_auto`

ZANTARA CRM - Auto-CRM Statistics Router
Endpoints for AUTO CRM extraction statistics and monitoring

#### `app.routers.crm_clients`

ZANTARA CRM - Clients Management Router
Endpoints for managing client data (anagrafica clienti)

Refactored: Migrated to asyncpg with connection pooling (2025-12-07)

#### `app.routers.crm_enhanced`

CRM Enhanced Routes - Family Members, Documents, Expiry Alerts

Provides endpoints for:
- Client family members (spouse, children)
- Document management with categories
- Expiry alerts with color indicators

#### `app.routers.crm_interactions`

ZANTARA CRM - Interactions Tracking Router
Endpoints for logging and retrieving team-client interactions

Refactored: Migrated to asyncpg with connection pooling (2025-12-07)

#### `app.routers.crm_portal_integration`

ZANTARA CRM - Portal Integration Router

Team-side endpoints for Portal interaction:
- Check client portal status
- Send portal invites from CRM
- Preview client's portal view
- Get unread messages count
- Send messages to clients

This creates the "intradinamici" connection between Team and Portal.

Created: 2025-12-30

#### `app.routers.crm_practices`

ZANTARA CRM - Practices Management Router
Endpoints for managing practices (KITAS, PT PMA, Visas, etc.)

Refactored: Migrated to asyncpg with connection pooling (2025-12-07)

#### `app.routers.crm_shared_memory`

ZANTARA CRM - Shared Memory Router
Team-wide memory access for AI and team members
Enables queries like "clients with upcoming renewals", "active practices for John Smith", etc.

Refactored: Migrated to asyncpg with connection pooling (2025-12-07)

#### `app.routers.dashboard_summary`

Dashboard Summary Router

Aggregated endpoint for dashboard data to reduce API calls.
Replaces 7 separate calls with 1 optimized call.

#### `app.routers.debug`

Debug Router
Provides debug endpoints for troubleshooting and monitoring

#### `app.routers.episodic_memory`

Episodic Memory API Router
Endpoints for managing user timeline events and experiences

#### `app.routers.feedback`

Feedback Router - P1 Implementation
Handles conversation ratings, feedback collection, and review queue management

#### `app.routers.google_drive`

Google Drive API Router

Handles OAuth flow and file operations for Google Drive integration.

#### `app.routers.handlers`

Handlers Registry Endpoint
Auto-discovers and exposes all available handlers/tools for ZANTARA

#### `app.routers.health`

ZANTARA RAG - Health Check Router

Provides health check endpoints for monitoring service status:
- /health - Basic health check for load balancers
- /health/detailed - Comprehensive service status for debugging

#### `app.routers.image_generation`

Image Generation Router - Handles image generation requests

#### `app.routers.ingest`

ZANTARA RAG - Ingestion Router
Book ingestion endpoints

#### `app.routers.intel`

Intel News API - Search and manage Bali intelligence news

#### `app.routers.knowledge_visa`

Knowledge Base - Visa Types Router
Professional visa cards for Bali Zero

Provides endpoints for:
- Listing all visa types
- Getting individual visa details
- Filtering by category

#### `app.routers.legal_ingest`

Legal Document Ingestion Router
API endpoints for Indonesian legal document ingestion pipeline

#### `app.routers.memory_vector`

ZANTARA RAG - Memory Vector Router
Semantic memory storage and search using Qdrant
Complements Firestore-based memory system with vector search capabilities

#### `app.routers.news`

News Router - API endpoints for Intel Feed news system
Handles CRUD operations, search, and subscriptions

#### `app.routers.newsletter`

Newsletter Router
Handles newsletter subscriptions for Bali Zero Insights blog

Endpoints:
- POST /api/blog/newsletter/subscribe - Subscribe to newsletter
- POST /api/blog/newsletter/confirm - Confirm subscription
- POST /api/blog/newsletter/unsubscribe - Unsubscribe
- PATCH /api/blog/newsletter/preferences - Update preferences
- GET /api/blog/newsletter/subscribers - List subscribers (admin)

#### `app.routers.nusantara_health`

ZANTARA - Nusantara Health Map Router
System health visualization as Indonesian archipelago

#### `app.routers.oracle_ingest`

ORACLE INGEST API Router
Endpoint per caricare massivamente documenti legali su Qdrant

POST /api/oracle/ingest - Bulk upload di chunks con embeddings

#### `app.routers.oracle_universal`

=======================================
ZANTARA v5.3 (Ultra Hybrid) - Universal Oracle API
=======================================

Author: Senior DevOps Engineer & Database Administrator
Version: 5.3.1 (Refactored)
Production Status: READY
Description:
Production-ready hybrid RAG system integrating:
- Qdrant Vector Database (Semantic Search)
- Google Drive Integration (PDF Document Repository)
- Google Gemini 3 Flash Preview (Reasoning Engine)
- User Identity & Localization System (PostgreSQL)
- Multimodal Capabilities (Text + Audio)
- Comprehensive Error Handling & Logging

Language Protocol:
- Source Code & Logs: ENGLISH (Standard)
- Knowledge Base: Bahasa Indonesia (Indonesian Laws)
- WebApp UI: ENGLISH
- AI Responses: User's preferred language (from users.meta_json.language)

#### `app.routers.performance`

Performance Optimization API Router
Exposes PerformanceMonitor and cache management via REST API endpoints

#### `app.routers.portal`

ZANTARA Client Portal - Main Router

Client-facing portal endpoints for:
- Dashboard overview
- Visa & Immigration status
- Company & Licenses
- Tax overview
- Documents
- Messages
- Settings/Preferences

All endpoints require client authentication (role='client').

Created: 2025-12-30

#### `app.routers.portal_invite`

ZANTARA Client Portal - Invitation Flow Router

Handles client invitation and registration:
1. Team sends invite ‚Üí client receives email with link
2. Client clicks link ‚Üí validates token
3. Client sets PIN ‚Üí registration complete

Created: 2025-12-30

#### `app.routers.preview`

Preview Router - Serve HTML previews for Telegram approval articles

#### `app.routers.root_endpoints`

Root Endpoints Router
Handles root-level endpoints like /, /api/csrf-token, /api/dashboard/stats

#### `app.routers.session`

Session Management API Router
Exposes SessionService functionality via REST API endpoints

#### `app.routers.system_observability`

System Observability API Router
Exposes real-time health checks and system metrics for the Admin "Control Room" Dashboard.

#### `app.routers.team`

Team Management Router
Handles team member listing with visibility rules

#### `app.routers.team_activity`

Team Activity API Router
Endpoints for team timesheet and activity tracking

#### `app.routers.team_analytics`

Team Analytics API Router
Exposes TeamAnalyticsService functionality via REST API endpoints

#### `app.routers.team_drive`

Team Drive API Router

Provides Google Drive file access for authenticated team members.
Uses Service Account authentication - no individual OAuth needed.

Team members with Zoho email can access shared Drive files through Zantara.
Files are filtered based on user's department:
- Setup Team: Legal, Immigration, Visa folders
- Tax Department: Tax, Finance folders
- Marketing: Marketing, Content folders
- Board: All folders

#### `app.routers.telegram`

Telegram Bot Webhook Router for Zantara
Handles incoming Telegram messages and responds using the RAG system.

#### `app.routers.voice`

Voice-Optimized RAG Endpoint

Fast, simple endpoint for voice assistants.
Skips complex agentic reasoning for speed.

Pipeline: Query ‚Üí Vector Search ‚Üí Fast LLM ‚Üí Response (~5-8s instead of 40s)

#### `app.routers.websocket`

WebSocket Router & Connection Manager
Handles real-time notifications via Redis Pub/Sub
Replaces Node.js websocket.ts

#### `app.routers.zoho_email`

Zoho Email Integration Router

OAuth flow and email operations endpoints for Zoho Mail integration.

Endpoints:
- OAuth: /auth/url, /callback, /status, /disconnect
- Folders: /folders
- Emails: /emails (list, get, send, reply, forward, mark, flag, delete)
- Attachments: /emails/{id}/attachments/{aid}

#### `app.schemas.feedback`

NUZANTARA PRIME - Feedback Module Schemas
Pydantic schemas for conversation ratings and review queue API

#### `app.services.api_key_auth`

API Key Authentication Service
Provides simple API key validation to bypass database dependency for testing

#### `app.services.audio_service`

Audio Service with Hybrid Provider Strategy

Priority:
1. Pollinations.ai (FREE, no API key)
2. OpenAI (fallback, requires API key)

This provides cost savings when Pollinations works,
with reliable fallback to OpenAI when needed.

#### `app.services.crm.audit_logger`

CRM Audit Logging System
Tracks all state changes with user attribution and timestamps

#### `app.services.crm.metrics`

CRM Metrics System - Business Operations KPIs
Tracks: active_clients_count, application_processing_time, and more

#### `app.services.metrics_pusher`

Grafana Cloud Metrics Pusher

Pushes Prometheus metrics to Grafana Cloud using the remote_write API.
This enables metrics visualization in Grafana Cloud dashboards.

Author: ZANTARA Development Team
Date: 2026-01-01

#### `app.setup.__init__`

Application Setup Module

Centralizes all application setup logic including:
- Sentry configuration
- CORS configuration
- Observability setup (Prometheus, OpenTelemetry)
- Middleware registration
- Service initialization
- Plugin initialization
- Router registration
- Application factory

#### `app.setup.app_factory`

FastAPI Application Factory

Creates and configures FastAPI application instance with all middleware,
routers, and lifecycle handlers.

#### `app.setup.cors_config`

CORS Configuration Module

Handles CORS middleware configuration for FastAPI application.

#### `app.setup.exception_handlers`

Exception Handlers for FastAPI Application

Provides global exception handlers to ensure proper error serialization
and prevent TypeError when serializing HTTPException with non-serializable objects.

#### `app.setup.middleware_config`

Middleware Configuration Module

Handles registration of all middleware components for FastAPI application.

#### `app.setup.observability`

Observability Configuration Module

Handles Prometheus metrics and OpenTelemetry tracing setup.
Supports both local Jaeger (gRPC) and Grafana Cloud (HTTP with auth).

#### `app.setup.plugin_initializer`

Plugin Initialization Module

Handles initialization of plugin system by discovering and registering all plugins.

Plugins are auto-discovered from the plugins/ directory and registered
in the global PluginRegistry.

#### `app.setup.router_registration`

Router Registration Module
Centralizes all router inclusion logic

#### `app.setup.sentry_config`

Sentry Configuration Module

Handles Sentry initialization for error monitoring.
Avoids initializing during tests unless explicitly desired.

#### `app.setup.service_initializer`

Service Initialization Module

Handles initialization of all ZANTARA RAG services with fail-fast for critical services.

Critical services (SearchService, ZantaraAIClient) must initialize successfully.
If any critical service fails, the application will raise RuntimeError to prevent starting in a broken state.

# Cache bust: 2026-01-01 15:38 UTC - Fixed _init_rag_components function definition

Non-critical services will log errors and continue with degraded functionality.

#### `app.streaming`

Streaming endpoints extracted from main_cloud to keep entrypoint slim.

#### `app.utils.cookie_auth`

Cookie-based authentication utilities for httpOnly JWT tokens.

This module provides secure cookie management for authentication:
- httpOnly JWT cookie (prevents XSS token theft)
- CSRF cookie (readable by JS for double-submit pattern)
- Environment-aware domain configuration

#### `app.utils.crm_utils`

CRM Utilities - RBAC and Shared Business Logic

#### `app.utils.db_debugger`

Database Query Debugger
Logs PostgreSQL queries with timing and identifies performance issues

#### `app.utils.debug_context`

Debug Context Manager
Provides context manager for enabling debug mode on-demand for specific requests

#### `app.utils.error_handlers`

Standardized error handling utilities for routers.

Provides consistent error handling across all API endpoints.

#### `app.utils.logging_utils`

Standardized logging utilities for routers.

Provides consistent logging patterns across all API endpoints.

#### `app.utils.postgres_debugger`

PostgreSQL Debugger Utility
Provides comprehensive debugging capabilities for PostgreSQL database.

#### `app.utils.qdrant_debugger`

Qdrant Debugger
Extended debugger for Qdrant collections with health analysis and query performance

#### `app.utils.rag_debugger`

RAG Pipeline Debugger
Traces RAG pipeline execution: query ‚Üí embedding ‚Üí search ‚Üí rerank ‚Üí context ‚Üí response

#### `app.utils.state_helpers`

State Helpers Module
Provides type-safe access to app.state and request.state attributes

#### `app.utils.tracing`

OpenTelemetry Tracing Utilities
Provides utilities for distributed tracing with OpenTelemetry/Jaeger

### Cli

#### `cli.__init__`

NUZANTARA PRIME - CLI Module

Unified command-line interfaces for:
- Ingestion operations
- Migration management
- Health checks

#### `cli.ingestion_cli`

NUZANTARA PRIME - Unified Ingestion CLI

Provides a single command-line interface for all ingestion operations.
Replaces fragmented ingestion scripts.

Usage:
    python -m cli.ingestion_cli ingest team-members
    python -m cli.ingestion_cli ingest conversations --source /path/to/data
    python -m cli.ingestion_cli ingest laws --file /path/to/law.pdf
    python -m cli.ingestion_cli list

### Core

#### `core.__init__`

ZANTARA RAG - Core Components

#### `core.bm25_vectorizer`

NUZANTARA RAG - BM25 Sparse Vectorizer
Generates BM25 sparse vectors for hybrid search with Qdrant.
Uses hash-based token IDs for vocabulary-free operation.

#### `core.cache`

Redis Caching Layer for ZANTARA
Provides intelligent caching for expensive operations

Features:
- TTL-based expiration
- Automatic key generation
- Cache invalidation
- Hit/miss metrics

#### `core.chunker`

Minimal Chunker stub for tests.

#### `core.embeddings`

ZANTARA RAG - Embeddings Generation
Supports both OpenAI and Sentence Transformers

#### `core.legal.__init__`

Legal Document Processing Module
Specialized pipeline for Indonesian legal documents (UU, PP, Keppres, etc.)

#### `core.legal.chunker`

Legal Document Chunker - Stage 4: The Butcher
Pasal-aware semantic chunking with context injection

#### `core.legal.cleaner`

Legal Document Cleaner - Stage 1: The Washer
Removes non-content artifacts from Indonesian legal documents

#### `core.legal.constants`

Constants for Indonesian Legal Document Processing
Regex patterns, keywords, and structure markers

#### `core.legal.hierarchical_indexer`

Hierarchical Document Indexer
Crea relazioni parent-child per retrieval gerarchico

#### `core.legal.metadata_extractor`

Legal Metadata Extractor - Stage 2: The Librarian
Extracts structured metadata from Indonesian legal documents

#### `core.legal.quality_validators`

Quality Validation Utilities
Functions for OCR quality assessment and ayat validation

#### `core.legal.structure_parser`

Legal Structure Parser - Stage 3: The Architect
Recognizes hierarchical structure of Indonesian legal documents

#### `core.parsers`

ZANTARA RAG - Document Parsers
Extract text from PDF and EPUB files

#### `core.plugins.__init__`

ZANTARA Unified Plugin Architecture

This module provides the core plugin system for ZANTARA, enabling:
- Standardized plugin interfaces
- Plugin discovery and registration
- Lifecycle management
- Performance monitoring
- Caching and rate limiting

#### `core.plugins.executor`

Plugin Executor

Executes plugins with performance monitoring, caching, rate limiting, and error handling.

#### `core.plugins.plugin`

Core Plugin Base Classes

Defines the base plugin interface that all ZANTARA plugins must implement.

#### `core.plugins.registry`

Plugin Registry

Central registry for all plugins. Handles loading, discovery, versioning, and lifecycle.

#### `core.qdrant_db`

ZANTARA RAG - Vector Database (Qdrant)
Async Qdrant client wrapper for embeddings storage and retrieval
# Cache bust: 2026-01-01 15:20 UTC

Uses httpx for async HTTP requests with connection pooling.
All operations are async to avoid blocking the event loop.

#### `core.reranker`

ZANTARA RAG - Semantic Re-ranker (Ze-Rank 2 API)
Implements external API-based re-ranking for high-precision retrieval without local CPU load.

### Data

#### `data.team_members`

ZANTARA Team Members Database

Importato dal JSON originale per uso programmatico

### Db

#### `db.__init__`

NUZANTARA PRIME - Database Module

#### `db.migrate`

NUZANTARA PRIME - Migration CLI Tool
Centralized tool for managing database migrations

#### `db.migration_base`

NUZANTARA PRIME - Base Migration Framework
Provides base classes and utilities for database migrations

#### `db.migration_manager`

NUZANTARA PRIME - Migration Manager
Centralized migration management system

### Llm

#### `llm.__init__`

LLM clients for ZANTARA AI

#### `llm.base`

LLM Provider Base Classes

Defines the abstract interface for unified LLM provider access.
All LLM providers (Gemini, OpenRouter, DeepSeek, Vertex) implement this interface.

#### `llm.client`

Unified LLM Client

Provides a single interface to multiple LLM providers with automatic fallback.

#### `llm.fallback_messages`

Fallback Messages - Localized error messages

Centralized fallback messages for error scenarios.

#### `llm.genai_client`

Google GenAI Client Wrapper

Unified client for Google's new GenAI SDK (google-genai).
Replaces the deprecated google-generativeai package.

This module provides:
- Centralized client management with connection pooling
- Async support via client.aio
- Streaming support
- Chat session management
- Backward-compatible interface for migration

Usage:
    from llm.genai_client import get_genai_client, GenAIClient

    client = get_genai_client()
    response = await client.generate_content("Hello!")

    # Or streaming:
    async for chunk in client.generate_content_stream("Hello!"):
        # Process chunk
        pass

Author: Nuzantara Team
Date: 2025-12-23

#### `llm.prompt_manager`

Prompt Manager - Handles system prompt loading and building

Separated from ZantaraAIClient to follow Single Responsibility Principle.

#### `llm.provider_registry`

LLM Provider Registry

Centralized registry for LLM providers with factory functions.

#### `llm.providers.__init__`

LLM Provider Adapters

Unified adapters for all LLM providers, implementing the LLMProvider interface.

#### `llm.providers.deepseek`

DeepSeek LLM Provider

Wraps the existing DeepSeekClient to implement the LLMProvider interface.

#### `llm.providers.gemini`

Gemini LLM Provider

Wraps the existing GeminiJakselService to implement the LLMProvider interface.

#### `llm.providers.openrouter`

OpenRouter LLM Provider

Wraps the existing OpenRouterClient to implement the LLMProvider interface.

#### `llm.providers.vertex`

Vertex AI LLM Provider

Wraps the existing VertexAIService to implement the LLMProvider interface.
Note: VertexAIService is sync-only, so we wrap it accordingly.

#### `llm.retry_handler`

Retry Handler - Centralized retry logic with exponential backoff

Separated from ZantaraAIClient to follow Single Responsibility Principle.

#### `llm.token_estimator`

Token Estimator - Accurate token counting for cost tracking

Uses tiktoken for accurate token estimation instead of approximations.

#### `llm.zantara_ai_client`

ZANTARA AI Client - Primary engine for all conversational AI

AI Models Architecture:
- PRIMARY: Google Gemini 2.0 Flash (production)

Configuration:
- GOOGLE_API_KEY: API key for Gemini (primary)

UPDATED 2025-12-23:
- Migrated to new google-genai SDK (replaced deprecated google-generativeai)
- Using genai_client.py wrapper for centralized client management
- Improved async support with client.aio

### Middleware

#### `middleware.activity_logging`

Activity Logging Middleware
Automatically logs all HTTP requests for audit trail and analytics

Features:
- Logs every API call (method, endpoint, user, response time)
- Captures request/response details
- Tracks user sessions
- Performance monitoring
- Error tracking

#### `middleware.error_monitoring`

Error Monitoring Middleware
Captures 4xx/5xx HTTP errors and sends alerts

#### `middleware.hybrid_auth`

Hybrid Authentication Middleware - Fail-Closed Implementation
Combines API Key, Cookie JWT, and Header JWT authentication for flexible access control.

Authentication Priority:
1. API Key (X-API-Key header) - for service-to-service communication
2. Cookie JWT (nz_access_token) - for browser clients with httpOnly cookies
3. Header JWT (Authorization: Bearer) - backward compatibility

SECURITY POLICY: Fail-Closed - any authentication system error denies access

#### `middleware.rate_limiter`

Rate Limiting Middleware for ZANTARA
Prevents API abuse and ensures fair usage

Features:
- IP-based rate limiting
- User-based rate limiting
- Configurable limits per endpoint
- Redis-backed for distributed systems

#### `middleware.request_tracing`

Request Tracing Middleware
Provides end-to-end request tracing with correlation IDs

### Migrations

#### `migrations.001_fix_missing_tables`

Migration: Fix missing PostgreSQL tables
Date: 2025-10-19
Purpose: Create cultural_knowledge, query_clusters tables and fix memory_facts.id

#### `migrations.apply_migration_007`

One-time script to apply migration 007 via Fly.io

#### `migrations.apply_migration_010`

One-time script to apply migration 010 via Fly.io or local
Migration: Fix team_members schema alignment

#### `migrations.apply_migration_012`

Apply Migration 012: Fix Production Schema Issues
Adds missing conversation_id column to interactions table

#### `migrations.apply_migration_013`

Apply Migration 013: Agentic RAG Tables
Creates tables for Parent-Child Retrieval and Golden Router

#### `migrations.apply_migration_014`

Apply Migration 014: Knowledge Graph Tables
Creates tables for Knowledge Graph

#### `migrations.apply_migration_015`

Apply Migration 015: Add Drive Columns

#### `migrations.apply_migration_028`

Apply Migration 028: Knowledge Graph Schema

#### `migrations.apply_migration_029`

Apply Migration 029: Knowledge Graph Source Chunks

#### `migrations.apply_migration_031`

Apply Migration 031: Client Portal Schema

#### `migrations.apply_migration_032`

Apply migration 032: Drop legacy KG tables

Usage:
    python -m backend.migrations.apply_migration_032

Or on Fly.io:
    fly ssh console -a nuzantara-rag -C "cd /app && python -m backend.migrations.apply_migration_032"

#### `migrations.crm_audit_migration`

CRM Database Migration - Add Audit Logging Support
Creates tables and indexes for comprehensive audit trails

#### `migrations.migrate_crm_schema`

Apply CRM System Schema Migration
Connects to Fly.io PostgreSQL and applies migration 007

#### `migrations.migration_001`

Migration 001: Fix missing PostgreSQL tables
Creates cultural_knowledge and query_clusters tables, fixes memory_facts.id

#### `migrations.migration_007`

Migration 007: CRM System Schema
Creates tables for CRM system (team_members, clients, practices, interactions, etc.)

#### `migrations.migration_010`

Migration 010: Fix team_members schema alignment
Adds missing columns to align with Python User model

#### `migrations.migration_012`

Migration 012: Fix Production Schema Issues
Adds missing conversation_id column to interactions table

#### `migrations.migration_013`

Migration 013: Agentic RAG Tables
Creates tables for Parent-Child Retrieval and Golden Router

#### `migrations.migration_014`

Migration 014: Knowledge Graph Tables
Creates tables for Knowledge Graph

#### `migrations.migration_015`

Migration 015: Add Drive Columns
Adds Google Drive metadata to parent_documents table

#### `migrations.migration_016`

Migration 016: Add Summary to Parent Documents
Adds summary column to parent_documents table

#### `migrations.migration_018`

Migration 018: Collective Memory System
Creates tables for shared knowledge learned from multiple users

#### `migrations.migration_019`

Migration 019: Episodic Memory System
Creates table for storing timeline of user events and experiences

#### `migrations.migration_020`

Migration 020: Collective Memory Vector Search
Sets up Qdrant collection and backfills embeddings for existing memories

#### `migrations.migration_021`

Migration 021: Memory-Knowledge Graph Integration
Links memory_facts and episodic_memories to kg_entities

#### `migrations.migration_021_add_bm25_sparse_vectors`

Migration 021: Add BM25 Sparse Vectors for Hybrid Search

This migration adds BM25 sparse vectors to the legal_unified collection
to enable hybrid search (dense + sparse) with Reciprocal Rank Fusion (RRF).

Strategy:
1. Create new collection with sparse vector support (legal_unified_hybrid)
2. Copy all documents from old collection, generating sparse vectors
3. Rename collections (old -> _backup, new -> original name)

This approach minimizes downtime and provides rollback capability.

#### `migrations.migration_022`

Migration 022: Performance Indexes
Adds critical indexes for memory_facts and user_stats tables to prevent full table scans.

#### `migrations.migration_025`

Migration 025: Conversation Ratings System
Adds conversation ratings table and view for ConversationTrainer agent

#### `migrations.migration_026`

Migration 026: Review Queue System
Adds review_queue table for feedback correction logic

#### `migrations.migration_027_team_memory_facts`

Migration 027: Populate Memory Facts for Team Members

Populates the memory_facts table with rich profile facts for all Bali Zero team members.
This enables Zantara to recognize team members and provide personalized responses.

Facts are stored by EMAIL (user_id = email), as the memory system uses email for lookups.

#### `migrations.migration_028_knowledge_graph_schema`

Migration: Create Knowledge Graph Tables
Version: 028
Date: 2025-12-29
Description: Adds persistence for Knowledge Graph nodes and edges.

#### `migrations.migration_029_kg_source_chunks`

Migration: Add Source Chunk IDs to Knowledge Graph
Version: 029
Date: 2025-12-29
Description: Links entities and relationships to vector DB chunk IDs.

#### `migrations.migration_030_zoho_email`

Migration 030: Zoho Email Integration Schema

Creates tables for Zoho OAuth token storage and email caching.

Created: 2025-12-30

#### `migrations.migration_031_client_portal`

Migration 031: Client Portal Schema

Creates tables and columns for the Client Portal feature:
- Extends team_members for client authentication
- Client invitations for email-based onboarding
- Multi-company support (client_companies)
- Async messaging system (portal_messages)
- Client preferences

Created: 2025-12-30

#### `migrations.migration_031_hybrid_collections`

Migration 031: Migrate Legacy Collections to Hybrid Format

This migration converts old-format collections (unnamed vectors) to hybrid format
(named dense vectors + BM25 sparse vectors) for improved search quality.

Collections to migrate:
- tax_genius (332 docs)
- bali_zero_pricing (65 docs)
- training_conversations (2898 docs)

Strategy:
1. Read all documents from old collection
2. Create new collection with hybrid schema
3. Generate BM25 sparse vectors for each document
4. Upsert with named vectors (dense + bm25)
5. Rename collections (old -> _legacy, new -> original)

#### `migrations.migration_032_drop_legacy_kg_tables`

Migration 032: Drop Legacy Knowledge Graph Tables

Removes the old KG schema (kg_entities, kg_relationships, kg_entity_mentions)
which has been replaced by the unified schema (kg_nodes, kg_edges) in migrations 028-029.

Date: 2025-12-31

#### `migrations.migration_033_newsletter`

Migration 033: Newsletter Subscribers Schema

Creates tables for blog newsletter subscriptions.

Created: 2025-12-31

#### `migrations.migration_034_google_drive_tokens`

Migration 034: Google Drive OAuth Tokens Table

Creates the google_drive_tokens table for storing user OAuth tokens.

#### `migrations.migration_035_kbli_blueprints`

Migration: Create KBLI Blueprints Table
Version: 035
Date: 2026-01-01
Description: Stores high-quality KBLI Blueprint metadata and file references for Workspace and Client Portal.

#### `migrations.migration_036_team_departments`

Migration 035: Team Departments & Drive Folder Access
Adds department-based folder filtering for Google Drive

#### `migrations.migration_037_folder_access_rules`

Migration 037: Folder Access Rules

Creates the folder_access_rules table for granular Google Drive folder visibility.
This replaces the simple can_see_all logic with per-context permission rules.

Usage:
    python -m backend.migrations.migration_037_folder_access_rules

#### `migrations.migration_038_news_items`

Migration 038: News Items for Intel Feed

Creates tables for news items, user saved news, and subscriptions.
Supports the BaliZero Intel Feed feature.

Created: 2026-01-03

#### `migrations.migration_040_email_activity_log`

Migration 040: Email Activity Log

Creates tables for tracking email operations for weekly reporting.

Created: 2026-01-05

#### `migrations.migration_041_clients_missing_columns`

Migration 041: Add Missing Columns to Clients Table

Adds:
- avatar_url (already in backend model but missing in DB)
- passport_expiry (frontend sends, backend ignores)
- date_of_birth (frontend sends, backend ignores)
- lead_source (frontend sends, backend ignores)
- service_interest (frontend sends, backend ignores)
- company_name (present in frontend formData)

#### `migrations.migration_041_team_activity_logging`

Migration 041: Team Activity Logging System
Date: 2026-01-05
Purpose: Comprehensive logging system for team activities, conversations, and API calls

Tables:
- activity_logs: General activity tracking (login, CRM actions, etc.)
- team_interactions: Team communications (chat, WhatsApp, email, calls)
- api_audit_trail: Complete API request/response audit trail

#### `migrations.seed_visa_types`

Seed Visa Types Data - CORRECTED
Based on official imigrasi.go.id classification and training data

Run with:
    fly ssh console -a nuzantara-rag -C "python3 /app/backend/migrations/seed_visa_types.py"

#### `migrations.seed_visa_types_complete`

Complete Visa Types Seed - All Series A-F
Based on official imigrasi.go.id data + Bali Zero 2025 pricing

Run: fly ssh console -a nuzantara-rag -C "python -m backend.migrations.seed_visa_types_complete"

### Plugins

#### `plugins.__init__`

ZANTARA Plugins Directory

This directory contains all plugin implementations organized by category.

#### `plugins.bali_zero.__init__`

Bali Zero service plugins

#### `plugins.bali_zero.pricing_plugin`

Pricing Plugin - Official Bali Zero Pricing

Migrated from: backend/services/zantara_tools.py -> _get_pricing

#### `plugins.team.__init__`

Team management plugins

#### `plugins.team.list_members_plugin`

Team Members List Plugin

Migrated from: backend/services/zantara_tools.py -> _get_team_members_list

#### `plugins.team.search_member_plugin`

Team Member Search Plugin

Migrated from: backend/services/zantara_tools.py -> _search_team_member

### Prompts

#### `prompts.__init__`

Prompts package for Nuzantara AI - contains Jaksel personality and system prompts.

### Root

#### `__init__`

ZANTARA RAG Backend Package

#### `verify_soul_persona`

Verify Soul Persona - Test script for Zantara personality

UPDATED 2025-12-23:
- Migrated to new google-genai SDK via GenAIClient wrapper

### Scripts

#### `scripts.fix_user_auth`

Fix user authentication - Update PIN hashes for users in database
Can be run on Fly.io to fix authentication issues

#### `scripts.kg_extract_async`

Extract KG entities from 500 chunks using backend's async QdrantClient

### Self_Healing

#### `self_healing.backend_agent`

ü§ñ ZANTARA Backend Self-Healing Agent

Autonomous agent that monitors backend service health and auto-fixes issues
Runs continuously on each Fly.io service (RAG, Memory, etc.)

Features:
- Health checks (API, DB, Redis, Qdrant)
- Auto-restart on failures
- Memory leak detection
- Database connection pool management
- API endpoint monitoring
- Reports to Central Orchestrator

### Services

#### `services.__init__`

ZANTARA RAG - Services

Backward-compatible re-exports for all services after reorganization.
All services can still be imported from services.X for compatibility.

#### `services.analytics.__init__`

Analytics Module
Specialized analytics services extracted from TeamAnalyticsService

#### `services.analytics.analytics_aggregator`

Analytics Aggregator Service
Aggregates data from PostgreSQL, Qdrant, Prometheus metrics for the analytics dashboard.

#### `services.analytics.burnout_detector`

Burnout Detector Service
Responsibility: Burnout signal detection

#### `services.analytics.daily_checkin_notifier`

Daily Check-in Email Notifier

Sends a daily email at 10:00 Bali time to zero@balizero.com
with team check-in status.

#### `services.analytics.optimal_hours`

Optimal Hours Service
Responsibility: Optimal hours identification

#### `services.analytics.pattern_analyzer`

Pattern Analyzer Service
Responsibility: Work pattern analysis

#### `services.analytics.performance_trend`

Performance Trend Service
Responsibility: Performance trend analysis

#### `services.analytics.productivity_scorer`

Productivity Scorer Service
Responsibility: Productivity scoring

#### `services.analytics.team_analytics_service`

Team Work Analytics Service
7 Advanced Techniques for Team Performance Analysis

Provides intelligent insights on:
1. Pattern Recognition - Work hour patterns and habits
2. Productivity Scoring - Session productivity metrics
3. Burnout Detection - Early warning signs
4. Performance Trends - Long-term performance analysis
5. Workload Balance - Team workload distribution
6. Optimal Hours - Best performance time windows
7. Team Insights - Collaboration and synergy analysis

REFACTORED: Uses sub-services following Single Responsibility Principle
- PatternAnalyzerService: Work pattern analysis
- ProductivityScorerService: Productivity scoring
- BurnoutDetectorService: Burnout detection
- PerformanceTrendService: Trend analysis
- WorkloadBalanceService: Workload analysis
- OptimalHoursService: Optimal hours identification
- TeamInsightsService: Team insights generation

#### `services.analytics.team_insights`

Team Insights Service
Responsibility: Team collaboration insights

#### `services.analytics.team_timesheet_service`

Team Timesheet Service
Manages team member work hours tracking (clock-in/clock-out)
Timezone: Asia/Makassar (Bali Time, UTC+8)

#### `services.analytics.weekly_email_reporter`

Weekly Email Activity Reporter

Sends a weekly email every Sunday at 4:00 PM Bali time to zero@balizero.com
with individual team member email activities.

#### `services.analytics.workload_balance`

Workload Balance Service
Responsibility: Workload distribution analysis

#### `services.autonomous_agents.knowledge_graph_builder`

Knowledge Graph Builder - Phase 4 (Advanced Agent)

Builds and maintains a knowledge graph of relationships between entities
discovered in Qdrant collections.

Example Knowledge Graph:
```
KBLI 56101 (Restaurant)
  ‚òô‚Üí requires ‚Üí NIB
  ‚òô‚Üí requires ‚Üí NPWP
  ‚òô‚Üí tax_obligation ‚Üí PPh 23 (2%)
  ‚òô‚Üí tax_obligation ‚Üí PPn (11%)
  ‚òô‚Üí legal_structure ‚Üí PT vs CV
  ‚òô‚Üí location_restriction ‚Üí Zoning rules
  ‚òô‚Üí staff_visa ‚Üí IMTA requirements
```

The graph is stored in PostgreSQL (kg_nodes, kg_edges) for persistence.

#### `services.classification.__init__`

Classification Module
Intent classification and query type detection

#### `services.classification.intent_classifier`

Intent Classifier Module
Fast pattern-based intent classification without AI cost

#### `services.communication.__init__`

Communication utilities for response formatting and analysis.

This package provides utilities for:
- Language detection and language-specific instructions
- Emotional content detection and empathetic response formatting
- Procedural question detection and step-by-step formatting
- Domain-specific formatting (Visa, Tax, Company)
- Explanation level detection (simple, standard, expert)

This module maintains backward compatibility with the original communication_utils module
by re-exporting all functions from the focused sub-modules.

Example usage:
    from services.communication import detect_language, has_emotional_content

    language = detect_language(query)
    if has_emotional_content(query):
        instruction = get_emotional_response_instruction(language)

#### `services.communication.domain_formatter`

Domain-Specific Formatting Instructions

Responsibility: Provide formatting instructions for domain-specific questions
(Visa, Tax, Company Setup) using standard templates.

Domains supported:
- visa: KITAS, work permits, visa applications
- tax: Indonesian taxation, NPWP, tax compliance
- company: PT PMA setup, business registration

#### `services.communication.emotion_analyzer`

Emotion Analysis Utilities

Responsibility: Detect emotional content in user queries and provide appropriate
response instructions for empathetic communication.

Supports detection of emotions like:
- Frustration, desperation
- Happiness, hope
- Worry, anxiety, fear
- Anger, sadness

#### `services.communication.explanation_detector`

Explanation Level Detection Service

Detects user intent for explanation level (simple/expert/standard) and alternative requests.

#### `services.communication.language_detector`

Language Detection Utilities

Responsibility: Detect language from user queries and provide language-specific instructions
for the ZANTARA persona.

Supported languages:
- Italian (it)
- English (en)
- Indonesian (id)
- Ukrainian (uk/ua)
- Russian (ru)
- Auto - Adaptive detection

#### `services.communication.procedural_formatter`

Procedural Question Detection and Formatting

Responsibility: Detect if user is asking for step-by-step instructions and provide
formatting guidelines for procedural responses.

Examples of procedural questions:
- "How do I apply for a visa?"
- "What are the steps to set up a company?"
- "Come faccio a ottenere un KITAS?"

#### `services.compliance.__init__`

Compliance Module
Specialized services extracted from ProactiveComplianceMonitor

#### `services.compliance.alert_generator`

Alert Generator Service
Responsibility: Generate compliance alerts

#### `services.compliance.compliance_tracker`

Compliance Tracker Service
Responsibility: Track compliance items

#### `services.compliance.notifications`

Compliance Notification Service
Responsibility: Send compliance notifications

#### `services.compliance.severity_calculator`

Severity Calculator Service
Responsibility: Calculate alert severity

#### `services.compliance.templates`

Compliance Templates Service
Responsibility: Manage compliance templates

#### `services.crm.__init__`

CRM services module.

#### `services.crm.ai_crm_extractor`

ZANTARA CRM - AI Entity Extraction Service
Uses ZANTARA AI to extract structured data from conversations for CRM auto-population

#### `services.crm.auto_crm_service`

ZANTARA CRM - Auto-Population Service
Automatically creates/updates clients and practices from chat conversations

REFACTORED 2025-12-07:
- Migrated from psycopg2 to asyncpg with connection pooling
- Uses centralized database pool from app.state (dependency injection)
- Batched queries to reduce N+1 problem
- Improved error handling

REFACTORED 2025-12-07 (Phase 2):
- Removed own connection pool creation
- Uses centralized pool from get_database_pool() dependency
- Better integration with FastAPI dependency injection

#### `services.crm.collaborator_service`

Collaborator Service
--------------------

Loads real Bali Zero team data from JSON and provides search/list/stats helpers.
Replaces the legacy identity layers with a transparent, easy-to-edit dataset.

#### `services.ingestion.__init__`

Ingestion services module.

#### `services.ingestion.auto_ingestion_orchestrator`

Auto-Ingestion Orchestrator - Phase 5 (Automation Agent)

Automatically monitors external sources and updates Qdrant collections
with new regulations, laws, and business information.

Monitored Sources:
- OSS website (KBLI updates)
- Ditjen Imigrasi (visa regulations)
- DJP (tax circulars)
- BKPM newsletters
- Legal databases (for legal_updates)

Process:
1. Daily scrape of monitored sources
2. LLM filter: "Is this a regulation change?"
3. Extract key information
4. Generate embeddings
5. Add to relevant collection (tax_updates, legal_updates, etc.)
6. Notify admin of updates
7. Trigger collection health check

Integration with bali-intel-scraper:
- Extends existing scraper with structured ingestion
- Uses same 2-tier filtering (LLAMA ‚Üí ZANTARA AI)
- Adds to Qdrant instead of just logging

#### `services.ingestion.collection_health_service`

Collection Health Monitor - Phase 3

Monitors the health and quality of all Qdrant collections:
- Last update timestamps
- Document counts
- Query hit rates
- Average confidence scores
- Staleness detection
- Actionable recommendations

Provides admin dashboard with collection health metrics.

#### `services.ingestion.collection_manager`

Collection Manager Service
Manages Qdrant collection lifecycle and access

Extracted from SearchService to follow Single Responsibility Principle.

#### `services.ingestion.collection_warmup_service`

Collection Warmup Service

Handles warming up vector database collections to improve first-query latency.

Extracted from SearchService to follow Single Responsibility Principle.
Pre-loads critical collections and generates dummy embeddings to reduce cold-start latency.

#### `services.ingestion.ingestion_logger`

Structured Logging Utilities for Data Ingestion & Processing
Provides comprehensive logging with Document ID, Source, and Parsing Errors

#### `services.ingestion.ingestion_service`

ZANTARA RAG - Ingestion Service
Book processing pipeline: parse ‚Üí chunk ‚Üí embed ‚Üí store
Auto-routes legal documents to LegalIngestionService

#### `services.ingestion.legal_ingestion_service`

Legal Ingestion Service
Specialized ingestion pipeline for Indonesian legal documents

#### `services.ingestion.performance_monitor`

Advanced Performance Monitoring Service
Provides comprehensive monitoring, alerting, and optimization for ingestion services

#### `services.ingestion.scraper_normalizer`

Scraper Data Normalization Service
Normalizes data from various scrapers with structured logging and metrics

#### `services.integrations.__init__`

Integrations Services Module

External service integrations (OAuth, third-party APIs).

#### `services.integrations.google_drive_service`

Google Drive Integration Service

Handles OAuth 2.0 authentication and file operations for Google Drive.

Features:
- OAuth2 authorization flow with PKCE
- Token storage in PostgreSQL
- File listing with folder hierarchy
- Permission-aware file access (respects Google Drive sharing)
- Upload/download operations

#### `services.integrations.team_drive_service`

Team Drive Service - Hybrid OAuth + Service Account Access

Provides Google Drive access for all team members.

AUTHENTICATION PRIORITY:
1. OAuth SYSTEM token (if available) ‚Üí antonellosiano@gmail.com 30TB quota
2. Domain-Wide Delegation (if configured) ‚Üí Workspace org quota
3. Service Account direct ‚Üí 15GB limit

Team members authenticate via their Zoho credentials in Zantara, then access
Drive files through this service using the SYSTEM OAuth token.

OBSERVABILITY (Jan 2026):
- Prometheus metrics for all operations (duration, file size, errors)
- Structured audit logging for compliance (who, when, what, result)
- OAuth token refresh tracking

#### `services.integrations.telegram_bot_service`

Telegram Bot Service for Zantara
Handles incoming messages and sends responses via Telegram Bot API.

#### `services.integrations.zoho_email_service`

Zoho Email Service

Core email operations: list, read, send, reply, forward, search, attachments, etc.

Features:
- List emails with pagination and filtering
- Read full email content
- Send new emails with attachments
- Reply / Reply All / Forward
- Mark read/unread, flag/unflag
- Delete (move to trash)
- Folder management
- Search emails
- Attachment upload/download

#### `services.integrations.zoho_oauth_service`

Zoho OAuth Service

Handles OAuth 2.0 authentication flow, token exchange, storage, and auto-refresh.

Features:
- Authorization URL generation with CSRF state
- Token exchange (authorization code -> access/refresh tokens)
- Automatic token refresh before expiry
- Secure token storage in PostgreSQL

#### `services.journey.__init__`

Journey Module
Specialized services extracted from ClientJourneyOrchestrator

#### `services.journey.journey_builder`

Journey Builder Service
Responsibility: Build journeys from templates

#### `services.journey.journey_templates`

Journey Templates Service
Responsibility: Manage journey templates

#### `services.journey.prerequisites_checker`

Prerequisites Checker Service
Responsibility: Check step prerequisites

#### `services.journey.progress_tracker`

Progress Tracker Service
Responsibility: Track journey progress

#### `services.journey.step_manager`

Step Manager Service
Responsibility: Manage step lifecycle

#### `services.knowledge_graph.__init__`

Knowledge Graph Services
LLM-powered entity and relation extraction for Indonesian legal documents

#### `services.knowledge_graph.coreference`

Coreference Resolution for Legal Knowledge Graphs
Based on CORE-KG and LINK-KG (arXiv 2025) best practices

Resolves references like:
- "peraturan tersebut" -> UU No. 6 Tahun 2023
- "izin dimaksud" -> NIB
- "undang-undang ini" -> UU No. 25 Tahun 2007

#### `services.knowledge_graph.extractor`

LLM-based Knowledge Graph Extractor
Uses Claude/GPT for entity and relation extraction from Indonesian legal documents

Based on:
- KGGen (Stanford, NeurIPS 2025)
- CORE-KG (arXiv 2025) for legal documents
- LLM-IE best practices

#### `services.knowledge_graph.extractor_gemini`

Gemini-based Knowledge Graph Extractor
Uses Google AI Studio for entity and relation extraction from Indonesian legal documents

Cost-effective alternative to Claude (~50x cheaper with Flash)

#### `services.knowledge_graph.ontology`

Indonesian Legal Knowledge Graph Ontology
Based on LexID (Universitas Indonesia) and international best practices 2025

This ontology defines:
- Entity types for Indonesian legal domain
- Relation types between entities
- Extraction patterns and examples

#### `services.knowledge_graph.pipeline`

Knowledge Graph Pipeline Orchestrator
Complete end-to-end pipeline for extracting KG from Indonesian legal documents

Based on:
- KGGen (Stanford, NeurIPS 2025)
- CORE-KG/LINK-KG for legal domain
- GraphRAG best practices

#### `services.llm_clients.__init__`

LLM client services module.

#### `services.llm_clients.deepseek_client`

DeepSeek V3 Client - Cheapest LLM API fallback

Pricing: $0.27/1M input, $1.10/1M output (December 2025)
API: OpenAI-compatible

Fallback chain: Gemini 2.0 Flash ‚Üí DeepSeek V3 ‚Üí OpenRouter (free models)

#### `services.llm_clients.gemini_service`

Gemini Jaksel Service with OpenRouter Fallback

Primary: Google Gemini API (gemini-3-flash-preview)
Fallback: OpenRouter free models when quota exceeded (429)

UPDATED 2025-12-23:
- Migrated to new google-genai SDK (replaced deprecated google-generativeai)

#### `services.llm_clients.openrouter_client`

OpenRouter Smart AI Client - Native Fallback System

Uses OpenRouter's native 'models' array for server-side fallback (more efficient).
With $10+ credits: 1000 req/day on free models.

Free Models Available (as of 2025):
- google/gemini-2.0-flash-exp:free (1M context, best for RAG)
- meta-llama/llama-3.3-70b-instruct:free (131K context, best reasoning)
- qwen/qwen3-235b-a22b:free (40K context, powerful)
- mistralai/mistral-small-3.1-24b-instruct:free (32K context, fast)
- meta-llama/llama-3.2-3b-instruct:free (131K context, fastest)

Best Practice: Use 'models' array for automatic server-side fallback.
OpenRouter tries models in order until one succeeds.

#### `services.llm_clients.pricing`

LLM Pricing Configuration and Token Cost Calculator.

Provides pricing tables for all LLM providers used in the system
and utilities for calculating costs from token usage.

Pricing is in USD per 1 million tokens (input/output).

Author: Nuzantara Team
Date: 2025-12-28

#### `services.llm_clients.vertex_ai_service`

Vertex AI Service
Handles interactions with Google Cloud Vertex AI (Gemini Pro).
Used as a fallback for complex extraction tasks.

#### `services.memory.__init__`

Memory Module - Centralized Memory Orchestration for ZANTARA

Uses lazy imports for MemoryOrchestrator to avoid circular dependency
with agents module.

#### `services.memory.collective_memory_emitter`

Collective Memory Event Emitter
Emette eventi SSE per memoria collettiva al frontend

#### `services.memory.collective_memory_service`

ZANTARA Collective Memory Service

Manages shared knowledge learned from multiple users.
Facts become "collective" when confirmed by 3+ different users.

Key features:
- Contribution tracking with full user audit trail
- Automatic promotion to collective when threshold reached
- Confidence scoring based on confirmations vs refutations
- Category-based organization (process, location, provider, etc.)
- Query-aware semantic retrieval via Qdrant (v1.5+)

#### `services.memory.collective_memory_workflow`

LangGraph Workflow for Collective Memory
Gestisce memoria collettiva intelligente (work + personal) con workflow condizionali

#### `services.memory.episodic_memory_service`

Episodic Memory Service - Timeline of User Events

Manages user experiences and events over time, enabling:
- "When did I start the PT PMA process?"
- "What happened last week?"
- "Show me my milestones"

Features:
- Store events with temporal context (when, what, emotion)
- Extract events automatically from conversations
- Link events to Knowledge Graph entities
- Timeline queries with filtering

#### `services.memory.memory_fact_extractor`

Memory Fact Extractor - Automatic key facts extraction from conversations
Extracts important facts to save in user memory for context building

#### `services.memory.memory_service_postgres`

ZANTARA Memory Service - PostgreSQL Backend (Fly.io)

Manages user memory (profile facts, conversation summary, counters) with PostgreSQL persistence.
Replaces Firestore with PostgreSQL for Fly.io deployment.

#### `services.memory.models`

Memory Module Models - Pydantic models for memory operations

These models provide a unified interface for all memory operations,
replacing the scattered dataclasses and dicts used across services.

#### `services.memory.orchestrator`

Memory Orchestrator - Centralized Memory Management for ZANTARA

This is the main entry point for all memory operations. It coordinates:
- MemoryServicePostgres: PostgreSQL persistence for facts and stats
- MemoryFactExtractor: Pattern-based fact extraction from conversations
- (Future) MemoryVectorService: Qdrant semantic search

Usage:
    orchestrator = MemoryOrchestrator(db_pool)
    await orchestrator.initialize()

    # Get user context before generating response
    context = await orchestrator.get_user_context(user_email)

    # Save facts after response is generated
    result = await orchestrator.process_conversation(
        user_email=user_email,
        user_message=query,
        ai_response=response,
    )

#### `services.misc.__init__`

Miscellaneous services module.

Uses lazy imports to avoid circular dependencies with llm module.

#### `services.misc.autonomous_research_service`

Autonomous Research Agent - Phase 4 (Advanced Agent)

Self-directed research agent that iteratively explores Qdrant collections
to answer complex or ambiguous queries without human intervention.

Example: "How to open a crypto company in Indonesia?"
‚Üí Iteration 1: Search kbli_eye ‚Üí "crypto" not in KBLI database
‚Üí Iteration 2: Expand to legal_updates ‚Üí finds OJK crypto regulation 2024
‚Üí Iteration 3: Search tax_genius ‚Üí crypto tax treatment
‚Üí Iteration 4: Search visa_oracle ‚Üí fintech director visa requirements
‚Üí Synthesis: Comprehensive answer despite no direct KBLI match

Key Features:
- Self-directed query expansion
- Iterative collection exploration
- Semantic similarity for expansion
- Reasoning chain transparency
- Automatic termination when sufficient info gathered

#### `services.misc.autonomous_scheduler`

ü§ñ AUTONOMOUS SCHEDULER SERVICE
Centralizes scheduling of all autonomous agents and background tasks.

Managed Services:
1. Auto-Ingestion Orchestrator - Daily regulatory updates (every 24h)
2. Backend Self-Healing Agent - Health monitoring and auto-fix (every 5min)
3. Conversation Trainer Agent - Learn from successful conversations (every 6h)
4. Client Value Predictor Agent - Nurture high-value clients (every 12h)
5. Knowledge Graph Builder Agent - Build knowledge graphs (every 4h)

#### `services.misc.clarification_service`

Clarification Service - Detect ambiguous queries and request clarification
Improves response quality by ensuring the AI understands user intent clearly

This service detects when a user's question is ambiguous or incomplete,
prompting for clarification before generating a potentially incorrect response.

Author: ZANTARA Development Team
Date: 2025-10-16

#### `services.misc.client_journey_orchestrator`

Client Journey Orchestrator - Phase 3 (Orchestration Agent #1)

Manages multi-step business workflows with automatic progress tracking,
document collection, and timeline management.

REFACTORED: Uses sub-services following Single Responsibility Principle
- JourneyTemplatesService: Template management
- JourneyBuilderService: Journey creation
- PrerequisitesCheckerService: Prerequisites validation
- StepManagerService: Step lifecycle management
- ProgressTrackerService: Progress tracking

Example Journey: "PT PMA Setup"
‚Üí Steps:
  1. Company name approval (KEMENKUMHAM) - Prerequisites: None
  2. Notary deed preparation - Prerequisites: Step 1 complete
  3. NIB application (OSS) - Prerequisites: Step 2 complete
  4. NPWP registration - Prerequisites: Step 3 complete
  5. Bank account opening - Prerequisites: Step 4 complete
  6. Virtual office setup - Prerequisites: Step 5 complete
  7. Director KITAS application - Prerequisites: Step 1-6 complete

Each step tracks:
- Status (pending/in_progress/completed/blocked)
- Required documents
- Estimated timeline
- Actual completion date
- Blocking issues

#### `services.misc.context_suggestion_service`

Context Suggestion Service Stub
Restored to fix ImportError in IntelligentRouter.

#### `services.misc.context_window_manager`

Context Window Manager - Intelligent conversation history management
Prevents context overflow by keeping only recent messages with automatic summarization

#### `services.misc.cultural_insights_service`

Cultural Insights Service
Manages cultural insights storage and retrieval from Qdrant

Extracted from SearchService to follow Single Responsibility Principle.

#### `services.misc.cultural_rag_service`

Cultural RAG Service - Retrieve ZANTARA-generated Indonesian cultural intelligence

This service retrieves cultural insights from Qdrant that were generated by ZANTARA AI
and injects them as context for ZANTARA AI to provide culturally-aware responses.

Pattern: ZANTARA AI generates cultural knowledge offline ‚Üí Qdrant stores ‚Üí ZANTARA AI uses at runtime
Cost: Zero (pre-generated, instant retrieval)
Latency: <5ms (Qdrant vector search)

#### `services.misc.emotional_attunement`

ZANTARA Emotional Attunement Service - Phase 4

Detects emotional state from message content and adapts response tone/style.
Integrates with CollaboratorService for personalized emotional preferences.

#### `services.misc.followup_service`

Follow-up Service - Generate suggested follow-up questions
Helps users continue conversations naturally by suggesting relevant next questions

This service generates 3-4 contextually relevant follow-up questions after each AI response,
improving engagement and helping users discover what they can ask next.

Author: ZANTARA Development Team
Date: 2025-10-16

#### `services.misc.golden_answer_service`

Golden Answer Service - Fast lookup of pre-generated FAQ answers

Provides sub-100ms lookup of cached answers for frequent queries.
Integrated into Sonnet workflow BEFORE RAG search.

Flow:
1. User query comes in
2. Check golden_answers table (10-20ms PostgreSQL lookup)
3. If match found ‚Üí return cached answer immediately
4. If no match ‚Üí proceed to normal RAG + Sonnet generation

This provides 250x speedup for ~50-60% of queries.

#### `services.misc.graph_extractor`

Graph Extractor - LLM-based Knowledge Extraction
================================================

Extracts structured knowledge (Entities & Relations) from unstructured text
using ZantaraAIClient (Gemini).

Usage:
    extractor = GraphExtractor(ai_client)
    graph_data = await extractor.extract_from_text(text_chunk)

#### `services.misc.graph_service`

Graph Service - Persistent Knowledge Graph using PostgreSQL
===========================================================

Provides CRUD operations and traversal logic for the Knowledge Graph
stored in 'kg_nodes' and 'kg_edges' tables.

Updated Dec 2025 to use unified KG schema (kg_nodes/kg_edges).

#### `services.misc.image_generation_service`

Google Imagen Service for ZANTARA
Uses Google's Generative AI (Imagen) to generate images from text prompts.

UPDATED 2025-12-23:
- Migrated to new google-genai SDK (configuration removed, using pollinations.ai fallback)

#### `services.misc.mcp_client_service`

MCP Client Service - Connette Nuzantara a MCP Servers esterni
Permette all'AI di usare tool MCP (brave-search, filesystem, etc.)

#### `services.misc.migration_runner`

NUZANTARA PRIME - Automatic Migration Runner

Provides automatic migration execution with versioning and dependency management.
Replaces manual apply_migration_XXX.py scripts.

Features:
- Automatic discovery of migrations
- Dependency resolution
- Version tracking
- Rollback support
- Dry-run mode

#### `services.misc.performance_optimizer`

Performance Optimization Enhancements
For ZANTARA RAG Backend Python

#### `services.misc.personality_service`

ZANTARA Multi-Personality Service

Gestisce le diverse personalit√† dell'AI system:
- Jaksel: Indonesian slang (Amanda, Anton, Krisna, Dea, etc.)
- ZERO: Italian style (Zero, Nina)
- Professional: Standard English/Indonesian
- Custom: Basato sulle preferenze del team member

Integra Gemini 1.5 (RAG research) + Zantara Oracle Cloud (personality voice)

#### `services.misc.proactive_compliance_monitor`

Proactive Compliance Monitor - Phase 3 (Orchestration Agent #2)

Monitors compliance deadlines and requirements for clients, sending
proactive alerts before deadlines.

Features:
- Tracks visa expiry dates (KITAS, KITAP, passport)
- Monitors tax filing deadlines (SPT Tahunan, PPh, PPn)
- Tracks license renewals (IMTA, NIB, business permits)
- Monitors regulatory changes from legal_updates/tax_updates
- Sends proactive notifications (60/30/7 days before)
- Auto-calculates renewal costs from bali_zero_pricing

REFACTORED: Uses sub-services following Single Responsibility Principle
- ComplianceTrackerService: Item tracking
- AlertGeneratorService: Alert generation
- SeverityCalculatorService: Severity calculation
- ComplianceTemplatesService: Template management
- ComplianceNotificationService: Notification sending

Example Monitored Items:
- KITAS expiry: Remind 60 days before
- SPT Tahunan deadline (March 31): Remind in February
- IMTA renewal: Remind 30 days before
- Regulation changes: Immediate alert if affects client

#### `services.misc.result_formatter`

Result formatting utilities for vector database search results.

Extracted from SearchService to improve modularity and testability.

#### `services.misc.session_service`

Session Service - Redis-based conversation history storage for ZANTARA

Eliminates URL length constraints by storing conversation history in Redis
and passing only session_id in requests. Supports 50+ message conversations.

Author: ZANTARA AI Code (Bali Zero Team)
Date: November 5, 2025

#### `services.misc.tool_executor`

TOOL EXECUTOR SERVICE
Handles ZANTARA AI tool use execution
All tools are Python-native (ZantaraTools, GmailService, CalendarService, etc.)
+ MCP Client tools (filesystem, memory, brave-search, etc.)

#### `services.misc.work_session_service`

Work Session Tracking Service
Tracks team member work hours and activities
All reports sent to ZERO only

#### `services.misc.zantara_tools`

ZANTARA Tools - Python Native Tools for ZANTARA AI
Direct execution (no HTTP calls) - faster & more reliable

#### `services.monitoring.__init__`

Monitoring services module.

#### `services.monitoring.activity_logger`

Activity Logger Service
Centralized service for logging all team activities, interactions, and API calls

Usage:
    from services.monitoring.activity_logger import activity_logger

    # Log general activity
    await activity_logger.log_activity(
        user_email="zero@balizero.com",
        action_type="crm_client_created",
        resource_type="client",
        resource_id="123",
        description="Created new client: John Doe",
        details={"client_name": "John Doe", "status": "active"}
    )

    # Log team interaction
    await activity_logger.log_interaction(
        user_email="zero@balizero.com",
        interaction_type="chat",
        direction="outbound",
        client_email="john@example.com",
        message_content="Hi John, your KITAS is ready!",
        metadata={"response_time_seconds": 120}
    )

    # Log API call
    await activity_logger.log_api_call(
        user_email="zero@balizero.com",
        method="POST",
        endpoint="/api/clients",
        request_body={"name": "John"},
        response_status=201,
        response_time_ms=45
    )

#### `services.monitoring.alert_service`

Alert Notification Service
Sends alerts for critical errors via Slack, Discord, and logging

#### `services.monitoring.audit_service`

ZANTARA Audit Service
Handles security logging and system audit trails for compliance and debugging.
Replaces Node.js audit-trail.ts

#### `services.monitoring.health_monitor`

Health Monitor Service
Monitors system health and sends alerts on downtime or degradation

#### `services.monitoring.unified_health_service`

NUZANTARA PRIME - Unified Health Check Service

Centralizes all health check functionality:
- Manual health checks (from scripts/health_check.py)
- Continuous monitoring (from self_healing/backend_agent.py)
- Service registry integration (from app.core.service_health)

This service provides a single source of truth for system health.

#### `services.multimodal.pdf_vision_service`

PDF Vision Service
Usa Gemini Vision per "vedere" e interpretare tabelle complesse nei PDF (es: KBLI).
Integrato con Google Drive per scaricare i file on-demand.

UPDATED 2025-12-23:
- Migrated to new google-genai SDK via GenAIClient wrapper

#### `services.oracle.__init__`

Oracle Module
Specialized services extracted from OracleService

#### `services.oracle.analytics`

Oracle Analytics Service
Responsibility: Query analytics and tracking

#### `services.oracle.cross_oracle_synthesis_service`

Cross-Oracle Synthesis Agent - Phase 3 (Core Agent #1)

Orchestrates queries across multiple Oracle collections and synthesizes
integrated recommendations using ZANTARA AI.

Example Scenario: "I want to open a restaurant in Canggu"
‚Üí Queries: kbli_eye, legal_architect, tax_genius, visa_oracle, property_knowledge, bali_zero_pricing
‚Üí Synthesizes: Integrated plan with KBLI code, legal structure, tax obligations,
               staff visa requirements, location requirements, timeline, and total investment

This is the "magic" agent that makes complex business queries feel effortless.

#### `services.oracle.document_retrieval`

Document Retrieval Service
Responsibility: PDF download and document handling from Google Drive

#### `services.oracle.language_detector`

Language Detection Service
Responsibility: Detect query language for localization

#### `services.oracle.oracle_config`

Oracle Configuration Service
Manages configuration for Oracle Universal endpoints

#### `services.oracle.oracle_database`

Oracle Database Service
Manages PostgreSQL database operations for Oracle endpoints

#### `services.oracle.oracle_google_services`

Oracle Google Services
Manages Google Gemini AI and Drive integration for Oracle endpoints

UPDATED 2025-12-23:
- Migrated to new google-genai SDK via GenAIClient wrapper

#### `services.oracle.oracle_service`

Oracle Service
==============
Core business logic for the Universal Oracle system.
Decoupled from FastAPI router for better testability and maintainability.

REFACTORED: Uses sub-services following Single Responsibility Principle
- LanguageDetectionService: Language detection
- UserContextService: User profile/memory/personality
- ReasoningEngineService: Gemini reasoning
- DocumentRetrievalService: PDF/Drive integration
- OracleAnalyticsService: Analytics tracking

#### `services.oracle.reasoning_engine`

Reasoning Engine Service
Responsibility: Gemini reasoning logic for query processing

#### `services.oracle.smart_oracle`

Zantara Smart Oracle - Enhanced PDF Analysis with Google Drive Integration

This module provides intelligent document analysis by:
1. Downloading PDFs from Google Drive using Service Account
2. Processing documents with Google Gemini AI
3. Providing accurate answers based on full document content

UPDATED 2025-12-23:
- Migrated to new google-genai SDK via GenAIClient wrapper

#### `services.oracle.user_context`

User Context Service
Responsibility: Manage user profile, memory, and personality context

#### `services.portal.__init__`

Portal Services
- InviteService: Client invitation and onboarding
- PortalService: Client portal data access

#### `services.portal.invite_service`

Client Portal Invite Service

Handles client invitation flow:
1. Team sends invite to client email
2. Client clicks link, validates token
3. Client creates PIN to complete registration

#### `services.portal.portal_service`

Client Portal Service

Provides client-scoped data access for:
- Dashboard overview
- Visa & immigration status
- Company & licenses
- Tax deadlines
- Documents
- Messages
- Preferences

#### `services.pricing.__init__`

Pricing services module.

#### `services.pricing.dynamic_pricing_service`

Dynamic Scenario Pricer - Phase 3 (Core Agent #2)

Calculates comprehensive pricing for business scenarios by aggregating
costs from multiple Oracle collections.

Example: "PT PMA Restaurant in Seminyak, 3 foreign directors"
‚Üí Aggregates costs from:
  - KBLI setup (kbli_eye)
  - Legal incorporation (legal_architect)
  - Tax registration (tax_genius)
  - Visa costs (visa_oracle) x3
  - Location requirements (property_knowledge)
  - Service fees (bali_zero_pricing)

‚Üí Output: Detailed breakdown + total investment + timeline

#### `services.pricing.pricing_service`

Official Pricing Service
Loads official prices from JSON (NO AI GENERATION)

#### `services.rag.agent.diagnostics_tool`

Diagnostics Tool - System Health & Status Check
Permette a Zantara di diagnosticare lo stato dei servizi backend (DB, Redis, Qdrant).

#### `services.rag.agent.mcp_tool`

MCP Super Tool - D√† a Zantara i superpoteri MCP
Solo per admin (zero@balizero.com)

Permette a Zantara di:
- Cercare sul web in tempo reale (Brave Search)
- Leggere/scrivere file
- Salvare memoria persistente
- Ragionamento step-by-step

#### `services.rag.agentic.__init__`

Agentic RAG with Tool Use - Refactored Architecture

This module has been refactored from a 2,200+ line monolithic file into
a well-structured package with clear separation of concerns:

Structure:
- tools.py: Tool class definitions (VectorSearch, WebSearch, Database, Calculator, Vision, Pricing)
- orchestrator.py: Main orchestrator with query processing and streaming (910 lines)
- llm_gateway.py: Unified LLM interface with model fallback cascade (493 lines)
- reasoning.py: ReAct reasoning loop (Thought‚ÜíAction‚ÜíObservation) (294 lines)
- prompt_builder.py: System prompt construction with caching
- response_processor.py: Response cleaning and formatting
- context_manager.py: User context and memory management
- tool_executor.py: Tool parsing and execution with rate limiting
- pipeline.py: Response processing pipeline with verification, cleaning, and citation stages

Key Features:
- Quality routing (Fast/Pro/DeepThink)
- ReAct pattern (Reason-Act-Observe)
- Multi-tier fallback (Gemini Pro -> Flash -> Flash-Lite -> OpenRouter)
- Native function calling with regex fallback
- Memory persistence and semantic caching
- Streaming and non-streaming modes
- Response verification and self-correction

Backward Compatibility:
All original exports are maintained for seamless integration with existing code.

#### `services.rag.agentic.context_manager`

User Context Management for Agentic RAG

This module handles retrieval and management of user context including:
- User profile data from team_members table
- Conversation history
- Memory facts (via MemoryOrchestrator)
- Collective knowledge facts
- Memory vector search for recall assist

Key Features:
- Optimized single-query profile + history fetch (eliminates N+1 pattern)
- Integration with MemoryOrchestrator as single source of truth
- Memory cache fallback for entity extraction
- Graceful degradation on failures

#### `services.rag.agentic.entity_extractor`

Lightweight entity extraction for Agentic RAG.

This is intentionally heuristic-first to keep latency low and avoid unnecessary
LLM calls. It provides optional hooks for future LLM-backed extraction.

#### `services.rag.agentic.graph_tool`

Graph Traversal Tool - Agentic Interface for Knowledge Graph
============================================================

Allows the Agent to explore the Knowledge Graph to find relationships
and structured data that might be missed by vector search.

#### `services.rag.agentic.llm_gateway`

LLM Gateway - Unified interface for LLM interactions with automatic fallback.

This module provides a centralized gateway for all Language Model interactions,
handling model initialization, tier-based routing, and automatic fallback cascades.

Key Features:
- Multi-tier Gemini model support (Pro, Flash, Flash-Lite)
- Automatic fallback cascade on quota/service errors
- OpenRouter integration as final fallback
- Native function calling support
- Error handling and retry logic
- Health check capabilities

Architecture:
    LLMGateway acts as the single source of truth for all LLM operations,
    abstracting model complexity from business logic. It ensures high
    availability through intelligent fallback routing.

Example:
    >>> gateway = LLMGateway(gemini_tools=[...])
    >>> response, model, obj = await gateway.send_message(
    ...     chat=chat_session,
    ...     message="What is KITAS?",
    ...     tier=TIER_FLASH,
    ... )
    >>> print(f"Response from {model}: {response}")

Author: Nuzantara Team
Date: 2025-12-17
Version: 1.2.0

UPDATED 2025-12-23:
- Migrated to new google-genai SDK (replaced deprecated google-generativeai)
- Using GenAIClient wrapper for centralized client management

#### `services.rag.agentic.orchestrator`

Agentic RAG Orchestrator - Main Query Processing Logic

This is the core orchestrator that coordinates all agentic RAG operations:
- Query routing (Fast/Pro/DeepThink)
- Tool-based reasoning (ReAct pattern)
- Streaming and non-streaming query processing
- Model fallback cascade (Gemini Pro -> Flash -> Flash-Lite -> OpenRouter)
- Memory persistence
- Semantic caching
- Response verification

Architecture:
- Uses modular components for context, prompts, tools, and processing
- Implements quality routing based on intent classification
- Supports conversation history with context window management
- Provides backward compatibility with legacy interfaces

#### `services.rag.agentic.pipeline`

Response Processing Pipeline

A clean pipeline pattern for processing LLM responses through multiple stages.
Each stage is independent and can be tested/configured separately.

Architecture:
- PipelineStage: Base class for all processing stages
- VerificationStage: Verify response quality and accuracy
- PostProcessingStage: Clean and format response text
- CitationStage: Extract and normalize citations
- FormatStage: Final formatting for output
- ResponsePipeline: Main orchestrator that runs data through stages

Benefits:
- Single Responsibility: Each stage has one job
- Testability: Test stages independently
- Reusability: Stages can be reused in different pipelines
- Configurability: Easy to add/remove stages
- No Duplication: Post-processing logic in one place

#### `services.rag.agentic.prompt_builder`

System Prompt Builder for Agentic RAG

This module handles construction of dynamic system prompts based on:
- User profile and identity
- Personal memory facts
- Collective knowledge
- Query characteristics (language, domain, format)
- Deep think mode activation

Key Features:
- Caching system with 5-minute TTL
- Cache key includes facts count for invalidation
- Dynamic language/format instructions
- Domain-specific formatting (visa, tax, company)
- Explanation level detection

#### `services.rag.agentic.reasoning`

ReAct Reasoning Engine - Thought ‚Üí Action ‚Üí Observation Loop

This component handles the core agentic reasoning loop using the ReAct pattern:
- Thought: LLM generates reasoning about what to do next
- Action: Execute a tool based on the thought
- Observation: Collect results from tool execution
- Repeat until final answer or max steps reached

Key features:
- Native function calling with regex fallback
- Early exit optimization for efficient queries
- Citation handling for vector search results
- Final answer generation if not provided
- Integration with response verification pipeline

#### `services.rag.agentic.response_processor`

Response Post-Processing for Agentic RAG

This module handles cleaning and formatting of AI responses:
- Clean internal reasoning patterns (THOUGHT:, ACTION:, Observation:)
- Enforce language detection
- Format procedural questions as numbered lists
- Add emotional acknowledgment when needed
- Verify responses against source context

Key Features:
- Integration with response cleaner service
- Communication rules enforcement
- Emotional attunement
- Format detection and transformation

#### `services.rag.agentic.schema`

Agentic RAG schema models.

The wider codebase expects the AgenticRAGOrchestrator to return an object-like
result with attribute access (historically a Pydantic model).

#### `services.rag.agentic.session_fact_extractor`

Session Fact Extractor

Lightweight, dependency-free helper to extract "session facts" from the raw
conversation history (before trimming/summarization).

This module is intentionally simple and safe:
- No external services
- No database
- Best-effort heuristics only

#### `services.rag.agentic.tool_executor`

Tool Execution and Parsing for Agentic RAG

This module handles:
- Parsing tool calls from AI responses (native function calling or ReAct format)
- Executing tools with rate limiting
- Tool result handling
- Security validation

Key Features:
- Native Gemini function calling (primary)
- Regex ReAct parser fallback for OpenRouter/non-Gemini models
- Rate limiting (max 10 executions per query)
- User ID injection for admin tools
- Error handling and logging
- Prometheus metrics for tool call tracking

#### `services.rag.agentic.tools`

Agentic RAG Tool Definitions

This module contains the essential tool class definitions used by the AgenticRAGOrchestrator.
Each tool inherits from BaseTool and implements the required interface.

Essential Tools (Dec 2025):
- VectorSearchTool: Knowledge base search (Legal, Visa, KBLI).
- PricingTool: Official Service pricing lookup (High Precision).
- TeamKnowledgeTool: Team member information.
- CalculatorTool: Safe mathematical calculations (Safe Math).
- VisionTool: Visual document analysis.
- ImageGenerationTool: AI image generation (Google Imagen / Pollinations fallback).
- WebSearchTool: Web search for topics outside KB (tourism, lifestyle, general info).

DESIGN PRINCIPLE: No hardcoded keywords, patterns, or domain knowledge.
The LLM decides which collection to search based on the tool description.

#### `services.rag.kg_enhanced_retrieval`

Knowledge Graph Enhanced Retrieval Service

Enhances RAG retrieval by:
1. Extracting entities from user query
2. Finding related entities in KG (1-2 hops)
3. Retrieving source chunks linked to those entities
4. Augmenting context with structured graph knowledge

#### `services.rag.verification_service`

Verification Service
Implements the "Draft -> Verify" pattern for Agentic RAG.
Acts as a judge to evaluate if the generated answer is supported by the retrieved context.

UPDATED 2025-12-23:
- Migrated to new google-genai SDK via GenAIClient wrapper

#### `services.rag.vision_rag`

Vision RAG Service
RAG multi-modale per documenti con immagini, tabelle, grafici.

UPDATED 2025-12-23:
- Migrated to new google-genai SDK via GenAIClient wrapper

#### `services.response.standard_templates`

Standard Response Templates for ZANTARA
Defines structured markdown formats for key business domains (Visa, Tax, etc.)
to ensure consistency and readability.

#### `services.routing.__init__`

Routing Module
Specialized routing services extracted from QueryRouter

#### `services.routing.confidence_calculator`

Confidence Calculator Service
Responsibility: Calculate confidence scores for routing decisions

#### `services.routing.conflict_resolver`

Conflict Resolver Service
Detects and resolves conflicts between results from different collections

Extracted from SearchService to follow Single Responsibility Principle.

#### `services.routing.fallback_manager`

Fallback Manager Service
Responsibility: Manage fallback chains and collection selection

#### `services.routing.golden_router_service`

Golden Router Service
Instrada query a documenti specifici basandosi su "Golden Routes" (query canoniche).
Usa similarit√† semantica per matchare query utente ‚Üí query canonica ‚Üí documento.

#### `services.routing.keyword_matcher`

Keyword Matcher Service
Responsibility: Match keywords to domains for query routing

#### `services.routing.priority_override`

Priority Override Service
Responsibility: Detect priority override patterns (identity, team, backend services)

#### `services.routing.query_router`

ZANTARA RAG - Query Router
Intelligent routing between multiple Qdrant collections based on query content

Phase 3 Enhancement: Smart Fallback Chain Agent
- Confidence scoring for routing decisions
- Automatic fallback to secondary collections when confidence is low
- Configurable fallback chains per domain
- Detailed logging and metrics

REFACTORED: Uses sub-services following Single Responsibility Principle
- KeywordMatcherService: Keyword matching
- ConfidenceCalculatorService: Confidence calculation
- FallbackManagerService: Fallback chain management
- PriorityOverrideService: Priority override detection
- RoutingStatsService: Statistics tracking

#### `services.routing.query_router_integration`

Query Router Integration Service
Handles query routing and collection selection logic

Extracted from SearchService to follow Single Responsibility Principle.

#### `services.routing.response_handler`

Response Handler Module
Applies response sanitization and quality enforcement

#### `services.routing.routing_stats`

Routing Statistics Service
Responsibility: Track routing statistics and metrics

#### `services.routing.specialized_service_router`

Specialized Service Router Module
Routes to autonomous research and cross-oracle synthesis services

#### `services.search.__init__`

Search services module.

#### `services.search.citation_service`

Citation Service - Add inline citations and source references to AI responses
Enhances credibility and transparency by showing where information comes from

This service enables AI to cite sources using inline references [1], [2] and
provide full source details at the end of responses, building user trust.

Author: ZANTARA Development Team
Date: 2025-10-16

#### `services.search.search_filters`

Search filter utilities for tier-based access control and repealed law exclusion.

Extracted from SearchService to improve modularity and testability.

#### `services.search.search_service`

ZANTARA RAG - Search Service
Core search functionality with tier-based access control

REFACTORED: Split into focused services following Single Responsibility Principle.
- Collection management ‚Üí CollectionManager
- Conflict resolution ‚Üí ConflictResolver
- Cultural insights ‚Üí CulturalInsightsService
- Query routing ‚Üí QueryRouterIntegration
- Health monitoring ‚Üí CollectionHealthService
- Collection warmup ‚Üí CollectionWarmupService

This service now handles ONLY core search logic with proper delegation.

#### `services.search.semantic_cache`

Semantic Cache Service for RAG System

Features:
- Cache query embeddings (avoid re-computing)
- Cache RAG search results
- Similarity-based cache lookup (cosine similarity)
- TTL-based expiration
- LRU eviction policy

Performance Impact:
- Latency: 800ms ‚Üí 150ms (-81%)
- API costs: -50% (fewer embeddings)
- Database load: -70% (fewer Qdrant queries)

#### `services.tools.__init__`

Tools Module
Tool loading, caching, and detection

#### `services.tools.knowledge_graph_tool`

Knowledge Graph Tool for Agentic RAG.

Allows the AI Agent to query the persistent Knowledge Graph to find structured
relationships between business entities (e.g., "What connects PT PMA to KITAS?").

### Tests

#### `tests.integration.conversation.test_e2e_conversation_flow`

Integration Tests: End-to-End Conversation Flow

Tests complete conversation flow from user message through:
1. ConversationService save
2. Memory Cache persistence
3. Auto-CRM extraction
4. Episodic Memory linking
5. Conversation history retrieval
6. Context building for subsequent queries

Target: Test complete integration of conversation management

#### `tests.integration.knowledge.test_knowledge_service_integration`

Integration Tests: Knowledge Service End-to-End

Tests complete integration flow:
1. KnowledgeService initialization with real dependencies
2. Query routing and collection selection
3. Search execution with Qdrant
4. Tier-based access control
5. Reranking integration
6. HTTP router integration
7. Error handling and fallback scenarios

Target: Test complete integration of KnowledgeService with all dependencies

#### `tests.integration.knowledge_graph.test_e2e_kg_flow`

Integration Tests: End-to-End Knowledge Graph Flow

Tests complete Knowledge Graph flow from document ingestion through:
1. Document ingestion
2. Entity extraction (KGExtractor)
3. Relation extraction
4. Coreference resolution
5. Knowledge Graph Pipeline execution
6. Entity linking to Episodic Memory
7. Graph traversal queries

Target: Test complete integration of Knowledge Graph components

#### `tests.integration.multi_service.test_rag_memory_kg_integration`

Integration Tests: RAG + Memory + Knowledge Graph Integration

Tests complex multi-service integration scenarios:
1. RAG query with Memory context
2. Knowledge Graph entity extraction from conversation
3. Episodic Memory event creation from RAG results
4. Cross-service data flow and consistency

Target: Test integration between RAG, Memory, and Knowledge Graph services

#### `tests.integration.multi_tool.test_multi_tool_execution_flow`

Integration Tests: Multi-Tool Execution Flow

Tests complex scenarios with multiple tool calls:
1. Sequential tool execution
2. Parallel tool execution
3. Tool chaining (output of one tool feeds into another)
4. Rate limiting and error handling
5. Tool result aggregation

Target: Test multi-tool execution scenarios end-to-end

#### `tests.integration.rag_agentic.test_e2e_rag_flow`

Integration Tests: End-to-End RAG Agentic Flow

Tests complete query flow from user input through:
1. Intent Classification
2. Query Routing (Fast/Pro/DeepThink)
3. RAG Search with VectorSearchTool
4. Tool Execution (ReAct Pattern)
5. Reasoning Loop (Thought ‚Üí Action ‚Üí Observation)
6. Response Generation
7. Memory Persistence
8. Response Pipeline (Verification, PostProcessing, Citation, Format)

Target: Test complete integration of all components working together

#### `tests.integration.routing.test_e2e_routing_fallback`

Integration Tests: End-to-End Routing with Fallback Chain

Tests complete routing flow with fallback mechanisms:
1. Query Router collection selection
2. Specialized Service Router detection
3. Confidence calculation
4. Fallback chain execution
5. Routing statistics tracking
6. Priority override handling

Target: Test complete integration of routing components with fallback

#### `tests.integration.specialized_services.test_autonomous_research_integration`

Integration Tests: Autonomous Research Service Integration

Tests integration with Autonomous Research Service:
1. Complex multi-collection queries
2. Research orchestration
3. Result synthesis
4. Integration with RAG and Memory

Target: Test Autonomous Research Service end-to-end integration

#### `tests.integration.specialized_services.test_cross_oracle_synthesis_integration`

Integration Tests: Cross-Oracle Synthesis Service Integration

Tests integration with Cross-Oracle Synthesis Service:
1. Multi-oracle query synthesis
2. Business planning queries
3. Comprehensive analysis
4. Integration with RAG and Memory

Target: Test Cross-Oracle Synthesis Service end-to-end integration

#### `tests.integration.test_team_drive_api`

Integration tests for Team Drive API endpoints.

NOTE: Some tests are skipped due to circular import issues in the services module.
Full integration tests with FastAPI TestClient are covered via E2E tests.

For full business logic testing, see:
- backend/tests/unit/services/integrations/test_team_drive_service.py (38 tests)

The unit tests cover:
- OAuth token handling
- File operations (list, download, upload, search)
- CRUD operations (create, rename, delete, move, copy)
- Permission management
- Audit logging
- Prometheus metrics

#### `tests.unit.__init__`

Unit tests

#### `tests.unit.agents.__init__`

Tests for Agents

#### `tests.unit.agents.agents.__init__`

Tests for Agents

#### `tests.unit.agents.agents.test_client_value_predictor`

Unit tests for ClientValuePredictor
Target: >95% coverage

#### `tests.unit.agents.agents.test_conversation_trainer`

Unit tests for ConversationTrainer
Target: 100% coverage
Composer: 4

#### `tests.unit.agents.agents.test_knowledge_graph_builder`

Unit tests for KnowledgeGraphBuilder agent
Target: >95% coverage

#### `tests.unit.agents.agents.test_schemas`

Unit tests for agents/agents/schemas.py
Target: 100% coverage

#### `tests.unit.agents.services.__init__`

Tests for Agent Services

#### `tests.unit.agents.services.test_client_scoring`

Unit tests for ClientScoringService
Target: >95% coverage

#### `tests.unit.agents.services.test_client_segmentation`

Unit tests for ClientSegmentationService
Target: >95% coverage

#### `tests.unit.agents.services.test_kg_extractors`

Unit tests for KG Extractors (EntityExtractor, RelationshipExtractor)
Target: >95% coverage

#### `tests.unit.agents.services.test_kg_repository`

Unit tests for KnowledgeGraphRepository
Target: 100% coverage
Composer: 4

#### `tests.unit.agents.services.test_kg_repository_additional`

Additional unit tests for KnowledgeGraphRepository
Target: >95% coverage

#### `tests.unit.agents.services.test_kg_schema`

Unit tests for agents/services/kg_schema.py
Target: 100% coverage

#### `tests.unit.agents.services.test_nurturing_message`

Unit tests for NurturingMessageService
Target: >95% coverage

#### `tests.unit.agents.services.test_whatsapp_notification`

Unit tests for WhatsAppNotificationService
Target: >95% coverage

#### `tests.unit.app.__init__`

Tests for App

#### `tests.unit.app.decorators.test_auth`

Unit tests for app/decorators/auth.py
Target: >95% coverage

#### `tests.unit.app.lifecycle.test_shutdown`

Unit tests for shutdown lifecycle handlers
Target: >95% coverage

#### `tests.unit.app.lifecycle.test_startup`

Unit tests for app/lifecycle/startup.py
Target: >95% coverage

#### `tests.unit.app.modules.identity.test_router`

Unit tests for identity router
Target: >95% coverage

#### `tests.unit.app.modules.knowledge.test_knowledge_router`

Unit tests for Knowledge Router
Target: >95% coverage

#### `tests.unit.app.modules.knowledge.test_knowledge_service`

Unit tests for knowledge service
Target: >95% coverage

#### `tests.unit.app.routers.__init__`

Tests for App Routers

#### `tests.unit.app.routers.test_agentic_rag_router`

Unit tests for Agentic RAG Router
Target: 100% coverage
Composer: 2

#### `tests.unit.app.routers.test_analytics`

Unit tests for analytics router
Target: >95% coverage

#### `tests.unit.app.routers.test_audio`

Unit tests for audio router
Target: >95% coverage

#### `tests.unit.app.routers.test_crm_auto`

Unit tests for CRM Auto Router
Target: >99% coverage

#### `tests.unit.app.routers.test_crm_clients`

Tests for CRM Clients Router

#### `tests.unit.app.routers.test_debug`

Tests for Debug Router
Target: 100% coverage

#### `tests.unit.app.routers.test_feedback`

Unit tests for feedback router
Target: >95% coverage

#### `tests.unit.app.routers.test_handlers`

Unit tests for handlers router
Target: >95% coverage

#### `tests.unit.app.routers.test_health`

Unit tests for health router
Target: >95% coverage

#### `tests.unit.app.routers.test_image_generation`

Unit tests for image generation router
Target: >95% coverage

#### `tests.unit.app.routers.test_legal_ingest`

Unit tests for legal_ingest router
Target: >95% coverage

#### `tests.unit.app.routers.test_media`

Unit tests for media router
Target: >95% coverage

#### `tests.unit.app.routers.test_memory_vector`

Unit tests for memory_vector router
Target: >95% coverage

#### `tests.unit.app.routers.test_nusantara_health`

Unit tests for nusantara health router
Target: >95% coverage

#### `tests.unit.app.routers.test_performance`

Unit tests for performance router
Target: >95% coverage

#### `tests.unit.app.routers.test_root_endpoints`

Unit tests for root endpoints
Target: >95% coverage

#### `tests.unit.app.routers.test_session`

Unit tests for session router
Target: >95% coverage

#### `tests.unit.app.routers.test_system_observability`

Unit tests for system observability router
Target: >95% coverage

#### `tests.unit.app.routers.test_team_analytics`

Unit tests for team_analytics router
Target: >95% coverage

#### `tests.unit.app.routers.test_websocket`

Unit tests for websocket router
Target: >95% coverage

#### `tests.unit.app.services.test_api_key_auth`

Unit tests for API key authentication service
Target: >95% coverage

#### `tests.unit.app.services.test_metrics_pusher`

Unit tests for metrics pusher
Target: >95% coverage

#### `tests.unit.app.setup.test_cors_config`

Unit tests for CORS configuration
Target: >95% coverage

#### `tests.unit.app.setup.test_cors_config_comprehensive`

Comprehensive unit tests for app/setup/cors_config.py
Target: >95% coverage

#### `tests.unit.app.setup.test_exception_handlers`

Unit tests for exception handlers
Target: >95% coverage

#### `tests.unit.app.setup.test_exception_handlers_comprehensive`

Comprehensive unit tests for app/setup/exception_handlers.py
Target: >95% coverage

#### `tests.unit.app.setup.test_middleware_config`

Unit tests for middleware configuration
Target: >95% coverage

#### `tests.unit.app.setup.test_observability`

Unit tests for Observability Setup
Target: >99% coverage

#### `tests.unit.app.setup.test_service_initializer`

Tests for service_initializer module

#### `tests.unit.app.setup.test_service_initializer_coverage`

Complete test coverage for service_initializer module
Target: 100% coverage

#### `tests.unit.app.test_dependencies`

Unit tests for app/dependencies.py
Target: 100% coverage

#### `tests.unit.app.test_feature_flags`

Unit tests for feature flags
Target: >95% coverage

#### `tests.unit.app.test_main_cloud`

Unit tests for app/main_cloud.py
Target: 100% coverage

#### `tests.unit.app.test_metrics`

Unit tests for app/metrics.py
Target: >95% coverage

#### `tests.unit.app.test_models`

Unit tests for Pydantic models
Target: >95% coverage

#### `tests.unit.app.test_streaming`

Unit tests for Streaming endpoints
Target: 100% coverage
Composer: 2

#### `tests.unit.app.utils.test_cookie_auth`

Unit tests for cookie authentication utilities
Target: >95% coverage

#### `tests.unit.app.utils.test_db_debugger`

Unit tests for app/utils/db_debugger.py
Target: >95% coverage

#### `tests.unit.app.utils.test_debug_context`

Unit tests for app/utils/debug_context.py
Target: >95% coverage

#### `tests.unit.app.utils.test_error_handlers`

Unit tests for error_handlers
Target: >95% coverage

#### `tests.unit.app.utils.test_logging_utils`

Unit tests for logging_utils
Target: >95% coverage

#### `tests.unit.app.utils.test_postgres_debugger`

Unit tests for app/utils/postgres_debugger.py
Target: >95% coverage

#### `tests.unit.app.utils.test_qdrant_debugger`

Unit tests for app/utils/qdrant_debugger.py
Target: >95% coverage

#### `tests.unit.app.utils.test_rag_debugger`

Unit tests for app/utils/rag_debugger.py
Target: >95% coverage

#### `tests.unit.app.utils.test_state_helpers`

Unit tests for state_helpers
Target: >95% coverage

#### `tests.unit.app.utils.test_tracing`

Unit tests for tracing utilities
Target: >95% coverage

#### `tests.unit.auth.test_validation`

Unit tests for auth validation
Target: >95% coverage

#### `tests.unit.cli.__init__`

Tests for CLI

#### `tests.unit.cli.test_ingestion_cli`

Unit tests for Ingestion CLI
Target: 100% coverage
Composer: 4

#### `tests.unit.core.__init__`

Tests for Core Services

#### `tests.unit.core.legal.__init__`

Tests for Legal Core

#### `tests.unit.core.legal.test_chunker`

Tests for LegalChunker

#### `tests.unit.core.legal.test_cleaner`

Tests for LegalCleaner

#### `tests.unit.core.legal.test_constants`

Unit tests for legal constants
Target: >95% coverage

#### `tests.unit.core.legal.test_metadata_extractor`

Tests for LegalMetadataExtractor

#### `tests.unit.core.legal.test_quality_validators`

Unit tests for Quality Validators
Target: 100% coverage
Composer: 4

#### `tests.unit.core.legal.test_structure_parser`

Tests for LegalStructureParser

#### `tests.unit.core.test_bm25_vectorizer`

Unit tests for core/bm25_vectorizer.py
Target: >95% coverage

#### `tests.unit.core.test_cache`

Unit tests for cache service
Target: >95% coverage

#### `tests.unit.core.test_chunker`

Unit tests for Chunker
Target: >95% coverage

#### `tests.unit.core.test_circuit_breaker`

Unit tests for CircuitBreaker
Target: >95% coverage

#### `tests.unit.core.test_constants`

Unit tests for constants modules
Target: >95% coverage

#### `tests.unit.core.test_embeddings`

Unit tests for core/embeddings.py
Target: >95% coverage

#### `tests.unit.core.test_error_classification`

Unit tests for ErrorClassifier
Target: >95% coverage

#### `tests.unit.core.test_parsers`

Unit tests for document parsers
Target: >95% coverage

#### `tests.unit.core.test_qdrant_client_methods`

Unit tests for QdrantClient methods (get, delete, peek, hybrid_search, upsert_documents_with_sparse)
Target: >95% coverage

#### `tests.unit.core.test_qdrant_collection_ops`

Unit tests for QdrantClient collection operations (create_collection, upsert_documents)
Target: >95% coverage

#### `tests.unit.core.test_qdrant_db_comprehensive`

Comprehensive tests for QdrantClient
Target: 100% coverage
Composer: 1

#### `tests.unit.core.test_qdrant_error_classifier`

Unit tests for QdrantErrorClassifier in core/qdrant_db.py
Target: >95% coverage

#### `tests.unit.core.test_qdrant_filter_conversion`

Unit tests for QdrantClient filter conversion methods in core/qdrant_db.py
Target: >95% coverage

#### `tests.unit.core.test_qdrant_search`

Unit tests for QdrantClient.search method
Target: >95% coverage

#### `tests.unit.core.test_reranker`

Unit tests for core/reranker.py
Target: >95% coverage

#### `tests.unit.core.test_service_health`

Unit tests for ServiceHealth and ServiceRegistry
Target: >95% coverage

#### `tests.unit.llm.__init__`

Tests for LLM Clients

#### `tests.unit.llm.adapters.test_registry`

Unit tests for LLM Adapters Registry
Target: >99% coverage

#### `tests.unit.llm.providers.test_gemini`

Tests for GeminiProvider

#### `tests.unit.llm.test_client`

Tests for UnifiedLLMClient

#### `tests.unit.llm.test_fallback_messages`

Unit tests for Fallback Messages
Target: >99% coverage

#### `tests.unit.llm.test_genai_client`

Unit tests for GenAIClient
Target: 100% coverage
Composer: 3

#### `tests.unit.llm.test_token_estimator`

Unit tests for TokenEstimator
Target: >95% coverage

#### `tests.unit.llm.test_zantara_ai_client`

Tests for ZantaraAIClient
Target: 100% coverage

#### `tests.unit.middleware.__init__`

Tests for Middleware

#### `tests.unit.middleware.test_error_monitoring`

Unit tests for middleware/error_monitoring.py
Target: >95% coverage

#### `tests.unit.middleware.test_hybrid_auth`

Unit tests for HybridAuthMiddleware
Target: 100% coverage

#### `tests.unit.middleware.test_rate_limiter`

Unit tests for middleware/rate_limiter.py
Target: >95% coverage

#### `tests.unit.middleware.test_request_tracing`

Unit tests for middleware/request_tracing.py
Target: >95% coverage

#### `tests.unit.services.__init__`

Tests for Services

#### `tests.unit.services.analytics.test_analytics_aggregator`

Unit tests for AnalyticsAggregator
Target: >95% coverage

#### `tests.unit.services.analytics.test_burnout_detector`

Unit tests for BurnoutDetectorService
Target: >95% coverage

#### `tests.unit.services.analytics.test_daily_checkin_notifier`

Tests for DailyCheckinNotifier

#### `tests.unit.services.analytics.test_optimal_hours`

Unit tests for OptimalHoursService
Target: >95% coverage

#### `tests.unit.services.analytics.test_pattern_analyzer`

Unit tests for PatternAnalyzerService
Target: >95% coverage

#### `tests.unit.services.analytics.test_performance_trend`

Unit tests for PerformanceTrendService
Target: >95% coverage

#### `tests.unit.services.analytics.test_productivity_scorer`

Unit tests for ProductivityScorerService
Target: >95% coverage

#### `tests.unit.services.analytics.test_team_analytics_service`

Unit tests for TeamAnalyticsService
Target: >95% coverage

#### `tests.unit.services.analytics.test_team_insights`

Unit tests for TeamInsightsService
Target: >95% coverage

#### `tests.unit.services.analytics.test_team_timesheet_service`

Unit tests for TeamTimesheetService
Target: >95% coverage

#### `tests.unit.services.analytics.test_workload_balance`

Unit tests for WorkloadBalanceService
Target: >95% coverage

#### `tests.unit.services.autonomous_agents.__init__`

Tests for Autonomous Agents

#### `tests.unit.services.autonomous_agents.test_kg_builder`

Unit tests for KnowledgeGraphBuilder Agent
Target: 100% coverage
Composer: 4

#### `tests.unit.services.classification.test_intent_classifier`

Unit tests for Intent Classifier
Target: 100% coverage
Composer: 5

#### `tests.unit.services.communication.test_domain_formatter`

Unit tests for domain_formatter
Target: >95% coverage

#### `tests.unit.services.communication.test_emotion_analyzer`

Unit tests for emotion_analyzer
Target: >95% coverage

#### `tests.unit.services.communication.test_explanation_detector`

Unit tests for explanation_detector
Target: >95% coverage

#### `tests.unit.services.communication.test_language_detector`

Unit tests for language_detector
Target: >95% coverage

#### `tests.unit.services.communication.test_procedural_formatter`

Unit tests for procedural_formatter
Target: >95% coverage

#### `tests.unit.services.compliance.test_alert_generator`

Unit tests for AlertGeneratorService
Target: >95% coverage

#### `tests.unit.services.compliance.test_compliance_tracker`

Unit tests for ComplianceTrackerService
Target: 100% coverage
Composer: 5

#### `tests.unit.services.compliance.test_notifications`

Unit tests for ComplianceNotificationService
Target: >95% coverage

#### `tests.unit.services.compliance.test_severity_calculator`

Unit tests for SeverityCalculatorService
Target: >95% coverage

#### `tests.unit.services.compliance.test_templates`

Unit tests for ComplianceTemplatesService
Target: >95% coverage

#### `tests.unit.services.crm.test_ai_crm_extractor`

Comprehensive tests for AICRMExtractor
Target: >95% coverage

#### `tests.unit.services.crm.test_auto_crm_service`

Unit tests for AutoCRMService
Target: >95% coverage

#### `tests.unit.services.crm.test_collaborator_service`

Tests for CollaboratorService

#### `tests.unit.services.ingestion.test_auto_ingestion_orchestrator`

Unit tests for AutoIngestionOrchestrator
Target: >99% coverage

#### `tests.unit.services.ingestion.test_collection_health_service`

Unit tests for CollectionHealthService
Target: >95% coverage

#### `tests.unit.services.ingestion.test_collection_manager`

Unit tests for CollectionManager
Target: >95% coverage

#### `tests.unit.services.ingestion.test_collection_warmup_service`

Unit tests for CollectionWarmupService
Target: >95% coverage

#### `tests.unit.services.ingestion.test_ingestion_service`

Unit tests for IngestionService
Target: >95% coverage

#### `tests.unit.services.integrations.test_google_drive_service`

Unit tests for GoogleDriveService
Target: >95% coverage

#### `tests.unit.services.integrations.test_team_drive_service`

Unit tests for TeamDriveService

Tests cover:
- OAuth token handling (SYSTEM token, refresh)
- File operations (list, download, upload, search)
- Folder operations (create, get path)
- CRUD operations (rename, delete, move, copy)
- Permission management (list, add, update, remove)
- Audit logging functionality
- Prometheus metrics integration

Target: >90% coverage

#### `tests.unit.services.integrations.test_zoho_email_service`

Unit tests for ZohoEmailService
Target: >95% coverage

#### `tests.unit.services.integrations.test_zoho_oauth_service`

Unit tests for ZohoOAuthService
Target: >95% coverage

#### `tests.unit.services.journey.test_journey_builder`

Unit tests for JourneyBuilderService
Target: 100% coverage
Composer: 5

#### `tests.unit.services.journey.test_journey_templates`

Unit tests for JourneyTemplatesService
Target: >95% coverage

#### `tests.unit.services.journey.test_prerequisites_checker`

Unit tests for PrerequisitesCheckerService
Target: >95% coverage

#### `tests.unit.services.journey.test_progress_tracker`

Unit tests for ProgressTrackerService
Target: 100% coverage
Composer: 5

#### `tests.unit.services.journey.test_step_manager`

Unit tests for StepManagerService
Target: >95% coverage

#### `tests.unit.services.knowledge_graph.__init__`

Tests for Knowledge Graph

#### `tests.unit.services.knowledge_graph.test_coreference`

Unit tests for CoreferenceResolver
Target: >95% coverage

#### `tests.unit.services.knowledge_graph.test_kg_extractor`

Unit tests for Knowledge Graph Extractor
Target: 100% coverage
Composer: 1

#### `tests.unit.services.knowledge_graph.test_kg_ontology`

Unit tests for Knowledge Graph Ontology
Target: 100% coverage
Composer: 1

#### `tests.unit.services.knowledge_graph.test_kg_pipeline`

Unit tests for Knowledge Graph Pipeline
Target: 100% coverage
Composer: 1

#### `tests.unit.services.llm_clients.test_vertex_ai_service`

Unit tests for VertexAIService
Target: >95% coverage

#### `tests.unit.services.memory.__init__`

Tests for Memory Services

#### `tests.unit.services.memory.test_collective_memory_comprehensive`

Unit tests for CollectiveMemoryService
Target: 100% coverage
Composer: 4

#### `tests.unit.services.memory.test_collective_memory_emitter`

Unit tests for CollectiveMemoryEmitter
Target: >95% coverage

#### `tests.unit.services.memory.test_episodic_memory_comprehensive`

Comprehensive tests for EpisodicMemoryService
Target: 100% coverage
Composer: 1

#### `tests.unit.services.memory.test_memory_fact_extractor`

Unit tests for MemoryFactExtractor
Target: >95% coverage

#### `tests.unit.services.memory.test_memory_fallback`

Unit tests for InMemoryConversationCache
Target: >95% coverage

#### `tests.unit.services.memory.test_memory_orchestrator`

Unit tests for MemoryOrchestrator
Target: 100% coverage
Composer: 4

#### `tests.unit.services.memory.test_memory_service_postgres`

Tests for MemoryServicePostgres

#### `tests.unit.services.misc.__init__`

Tests for Misc Services

#### `tests.unit.services.misc.test_autonomous_research_service`

Unit tests for AutonomousResearchService
Target: >95% coverage

#### `tests.unit.services.misc.test_autonomous_scheduler`

Unit tests for AutonomousScheduler
Target: >95% coverage

#### `tests.unit.services.misc.test_clarification_service`

Unit tests for ClarificationService
Target: >95% coverage

#### `tests.unit.services.misc.test_client_journey_orchestrator`

Unit tests for ClientJourneyOrchestrator
Target: >95% coverage

#### `tests.unit.services.misc.test_context_suggestion_service`

Unit tests for ContextSuggestionService
Target: >95% coverage

#### `tests.unit.services.misc.test_context_window_manager`

Unit tests for ContextWindowManager
Target: >95% coverage

#### `tests.unit.services.misc.test_conversation_service`

Comprehensive tests for ConversationService
Target: >95% coverage

#### `tests.unit.services.misc.test_cultural_insights_service`

Unit tests for CulturalInsightsService
Target: >95% coverage

#### `tests.unit.services.misc.test_cultural_rag_service`

Unit tests for CulturalRAGService
Target: >95% coverage

#### `tests.unit.services.misc.test_emotional_attunement`

Unit tests for EmotionalAttunementService
Target: >95% coverage

#### `tests.unit.services.misc.test_followup_service`

Unit tests for FollowupService
Target: >95% coverage

#### `tests.unit.services.misc.test_golden_answer_service`

Unit tests for GoldenAnswerService
Target: >95% coverage

#### `tests.unit.services.misc.test_graph_extractor`

Unit tests for GraphExtractor
Target: >95% coverage

#### `tests.unit.services.misc.test_graph_service`

Unit tests for GraphService
Target: 100% coverage
Composer: 4

#### `tests.unit.services.misc.test_image_generation_service`

Unit tests for ImageGenerationService
Target: >95% coverage

#### `tests.unit.services.misc.test_mcp_client_service`

Unit tests for MCPClientService
Target: >95% coverage

#### `tests.unit.services.misc.test_migration_runner`

Unit tests for MigrationRunner
Target: >95% coverage

#### `tests.unit.services.misc.test_performance_optimizer`

Unit tests for Performance Optimizer
Target: >95% coverage

#### `tests.unit.services.misc.test_personality_service`

Unit tests for PersonalityService
Target: >95% coverage

#### `tests.unit.services.misc.test_proactive_compliance_monitor_comprehensive`

Unit tests for ProactiveComplianceMonitor
Target: >95% coverage

#### `tests.unit.services.misc.test_result_formatter`

Unit tests for result_formatter
Target: >95% coverage

#### `tests.unit.services.misc.test_session_service`

Unit tests for SessionService
Target: >95% coverage

#### `tests.unit.services.misc.test_tool_executor`

Unit tests for ToolExecutor
Target: >95% coverage

#### `tests.unit.services.misc.test_work_session_service_comprehensive`

Unit tests for WorkSessionService
Target: >95% coverage

#### `tests.unit.services.misc.test_zantara_tools`

Unit tests for ZantaraTools
Target: >95% coverage

#### `tests.unit.services.monitoring.test_alert_service`

Unit tests for AlertService
Target: >95% coverage

#### `tests.unit.services.monitoring.test_audit_service`

Unit tests for AuditService
Target: >95% coverage

#### `tests.unit.services.monitoring.test_health_monitor`

Unit tests for HealthMonitor
Target: >95% coverage

#### `tests.unit.services.monitoring.test_unified_health_service`

Unit tests for UnifiedHealthService
Target: >95% coverage

#### `tests.unit.services.multimodal.test_pdf_vision_service`

Unit tests for PDFVisionService
Target: >95% coverage

#### `tests.unit.services.oracle.__init__`

Tests for Oracle Services

#### `tests.unit.services.oracle.test_oracle_database`

Unit tests for DatabaseManager (Oracle Database)
Target: 100% coverage
Composer: 4

#### `tests.unit.services.oracle.test_oracle_service`

Unit tests for OracleService
Target: 100% coverage
Composer: 4

#### `tests.unit.services.oracle.test_oracle_service_properties`

Unit tests for OracleService properties
Target: >95% coverage

#### `tests.unit.services.portal.test_invite_service`

Unit tests for InviteService
Target: >95% coverage

#### `tests.unit.services.portal.test_portal_service`

Unit tests for PortalService
Target: >95% coverage

#### `tests.unit.services.pricing.test_dynamic_pricing_service`

Unit tests for DynamicPricingService
Target: >95% coverage

#### `tests.unit.services.pricing.test_pricing_service`

Unit tests for PricingService
Target: >95% coverage

#### `tests.unit.services.rag.agent.test_persona`

Unit tests for persona module
Target: >95% coverage

#### `tests.unit.services.rag.agent.test_safe_math_evaluator`

Unit tests for SafeMathEvaluator
Target: >95% coverage

#### `tests.unit.services.rag.agentic.__init__`

Tests for Agentic RAG

#### `tests.unit.services.rag.agentic.conftest`

Pytest configuration for orchestrator tests.
Patches settings before any imports to prevent pydantic validation errors.

#### `tests.unit.services.rag.agentic.test_agentic_tools_comprehensive`

Unit tests for Agentic RAG Tools
Target: 100% coverage
Composer: 1

#### `tests.unit.services.rag.agentic.test_context_manager`

Comprehensive test coverage for context_manager.py
Target: Maximum coverage for all code paths

#### `tests.unit.services.rag.agentic.test_entity_extractor`

Unit tests for EntityExtractionService
Target: >95% coverage

#### `tests.unit.services.rag.agentic.test_graph_tool_coverage`

Complete test coverage for graph_tool.py
Target: >95% coverage

This file provides comprehensive tests for:
- GraphTraversalTool class - initialization, properties, execution, error handling

#### `tests.unit.services.rag.agentic.test_llm_gateway_comprehensive`

Unit tests for LLMGateway
Target: 100% coverage
Composer: 1

#### `tests.unit.services.rag.agentic.test_orchestrator`

Unit tests for AgenticRAGOrchestrator
Target: >95% coverage

#### `tests.unit.services.rag.agentic.test_orchestrator_comprehensive`

Unit tests for AgenticRAGOrchestrator
Target: 100% coverage
Composer: 1

#### `tests.unit.services.rag.agentic.test_orchestrator_coverage`

Comprehensive test coverage for orchestrator.py
Target: Maximum coverage for all code paths

#### `tests.unit.services.rag.agentic.test_orchestrator_coverage_complete`

Complete test coverage for AgenticRAGOrchestrator
Target: >95% coverage

This file complements existing tests and focuses on:
- _save_conversation_memory() - race conditions, timeouts, errors
- stream_query() - all routing paths (greeting, casual, identity, injection, etc.)
- Edge cases and error handling
- Integration scenarios

#### `tests.unit.services.rag.agentic.test_pipeline`

Unit tests for pipeline module
Target: >95% coverage

#### `tests.unit.services.rag.agentic.test_pipeline_comprehensive`

Unit tests for Response Processing Pipeline
Target: 100% coverage
Composer: 1

#### `tests.unit.services.rag.agentic.test_pipeline_coverage_complete`

Complete test coverage for pipeline module
Target: >95% coverage

This file complements existing tests and adds comprehensive coverage for:
- VerificationStage - all error cases, verification service integration
- PostProcessingStage - error handling, edge cases
- CitationStage - normalization, deduplication, edge cases
- FormatStage - all formatting scenarios
- ResponsePipeline - error handling, stage failures
- create_default_pipeline() - factory function

#### `tests.unit.services.rag.agentic.test_prompt_builder_comprehensive`

Unit tests for SystemPromptBuilder
Target: 100% coverage
Composer: 1

#### `tests.unit.services.rag.agentic.test_prompt_builder_exponential_coverage`

EXPONENTIAL TEST COVERAGE for prompt_builder.py
Target: >95% coverage - from 10 tests to 100+ tests

This file provides MASSIVE test coverage for:
- SystemPromptBuilder.__init__() - cache initialization
- has_already_greeted() - all greeting patterns, edge cases
- build_system_prompt() - ALL combinations: languages, personas, memory, caching, deep_think
- check_greetings() - all languages, returning users, personalized
- check_casual_conversation() - business vs casual detection
- get_casual_response() - all casual response types
- detect_prompt_injection() - all injection patterns, security
- check_identity_questions() - all identity question types, languages

#### `tests.unit.services.rag.agentic.test_reasoning`

Unit tests for reasoning module
Target: >95% coverage

#### `tests.unit.services.rag.agentic.test_reasoning_comprehensive`

Unit tests for ReasoningEngine
Target: 100% coverage
Composer: 1

#### `tests.unit.services.rag.agentic.test_response_processor`

Comprehensive test coverage for response_processor.py
Target: Maximum coverage for all code paths

#### `tests.unit.services.rag.agentic.test_response_processor_coverage`

Complete test coverage for response_processor module
Target: >95% coverage

This file provides comprehensive tests for:
- post_process_response() - main function with all combinations
- _has_numbered_list() - numbered list detection
- _format_as_numbered_list() - procedural formatting
- _has_emotional_acknowledgment() - emotional detection
- _add_emotional_acknowledgment() - emotional acknowledgment addition

#### `tests.unit.services.rag.agentic.test_schema_coverage`

Complete test coverage for schema module
Target: >95% coverage

This file provides comprehensive tests for:
- CoreResult model - all fields, validation, defaults, edge cases

#### `tests.unit.services.rag.agentic.test_session_fact_extractor`

Comprehensive test coverage for session_fact_extractor.py
Target: Maximum coverage for all code paths

#### `tests.unit.services.rag.agentic.test_tool_executor`

Comprehensive test coverage for tool_executor.py
Target: Maximum coverage for all code paths - Security Critical

#### `tests.unit.services.rag.agentic.test_tools`

Unit tests for tools module
Target: >95% coverage

#### `tests.unit.services.rag.test_kg_enhanced_retrieval`

Tests for KGEnhancedRetrieval

#### `tests.unit.services.rag.test_verification_service`

Unit tests for VerificationService
Target: >95% coverage

#### `tests.unit.services.rag.test_vision_rag`

Unit tests for VisionRAGService
Target: >95% coverage

#### `tests.unit.services.response.test_cleaner`

Unit tests for Response Cleaner
Target: >95% coverage

#### `tests.unit.services.response.test_standard_templates`

Unit tests for Standard Templates
Target: >95% coverage

#### `tests.unit.services.response.test_validator`

Unit tests for ZantaraResponseValidator
Target: >95% coverage

#### `tests.unit.services.routing.test_confidence_calculator`

Unit tests for ConfidenceCalculatorService
Target: >95% coverage

#### `tests.unit.services.routing.test_conflict_resolver`

Unit tests for ConflictResolver
Target: >95% coverage

#### `tests.unit.services.routing.test_fallback_manager`

Unit tests for FallbackManagerService
Target: >95% coverage

#### `tests.unit.services.routing.test_golden_router_service`

Unit tests for Golden Router Service
Target: >99% coverage

#### `tests.unit.services.routing.test_keyword_matcher`

Unit tests for KeywordMatcherService
Target: >95% coverage

#### `tests.unit.services.routing.test_priority_override`

Unit tests for PriorityOverrideService
Target: >95% coverage

#### `tests.unit.services.routing.test_query_router`

Unit tests for QueryRouter
Target: >95% coverage

#### `tests.unit.services.routing.test_query_router_integration`

Unit tests for QueryRouterIntegration
Target: >95% coverage

#### `tests.unit.services.routing.test_response_handler`

Unit tests for ResponseHandler
Target: 100% coverage

#### `tests.unit.services.routing.test_routing_stats`

Unit tests for RoutingStatsService
Target: >95% coverage

#### `tests.unit.services.routing.test_routing_stats_comprehensive`

Comprehensive tests for RoutingStatsService
Target: 100% coverage
Composer: 1

#### `tests.unit.services.routing.test_specialized_service_router`

Unit tests for SpecializedServiceRouter
Target: 100% coverage

#### `tests.unit.services.routing.test_specialized_service_router_comprehensive`

Comprehensive tests for SpecializedServiceRouter
Target: 100% coverage
Composer: 1

#### `tests.unit.services.search.__init__`

Tests for Search Services

#### `tests.unit.services.search.test_citation_service`

Unit tests for CitationService
Target: >95% coverage

#### `tests.unit.services.search.test_search_filters`

Unit tests for Search Filters
Target: >95% coverage

#### `tests.unit.services.search.test_search_service_comprehensive`

Unit tests for SearchService
Target: 100% coverage
Composer: 3

#### `tests.unit.services.search.test_semantic_cache`

Unit tests for SemanticCache
Target: >95% coverage

#### `tests.unit.services.tools.test_knowledge_graph_tool`

Unit tests for services/tools/knowledge_graph_tool.py
Target: 100% coverage

#### `tests.unit.utils.test_response_sanitizer`

Unit tests for response sanitizer
Target: >95% coverage

#### `tests.unit.utils.test_response_sanitizer_comprehensive`

Comprehensive unit tests for utils/response_sanitizer.py
Target: >95% coverage

#### `tests.unit.utils.test_tier_classifier`

Unit tests for tier classifier
Target: >95% coverage

### Utils

#### `utils.__init__`

ZANTARA RAG - Utilities

#### `utils.response_sanitizer`

Response Sanitization Utilities for ZANTARA
Fixes Phase 1 & 2: Remove training data artifacts and enforce quality standards

#### `utils.tier_classifier`

ZANTARA RAG - Tier Classification
Classify books into knowledge tiers (S, A, B, C, D)

## Services

### `AlertGeneratorService`

**Module:** `services.compliance.alert_generator`

Service for generating compliance alerts.

Responsibility: Generate alerts from compliance items.

### `AlertService`

**Module:** `services.monitoring.alert_service`

Service for sending alerts to various channels

### `AudioService`

**Module:** `app.services.audio_service`

Hybrid Audio Service: Pollinations (free) with OpenAI fallback.

TTS: Pollinations GET endpoint -> OpenAI fallback (5s timeout for fast response)
STT: OpenAI Whisper (more reliable for transcription)

### `AuditService`

**Module:** `services.monitoring.audit_service`

Service for logging security and system events to the database.

### `AutoCRMService`

**Module:** `services.crm.auto_crm_service`

Automatically populate CRM from conversations using AI extraction

Uses centralized asyncpg connection pool via dependency injection.
No longer creates its own pool - uses app.state.db_pool.

### `AutonomousResearchService`

**Module:** `services.misc.autonomous_research_service`

Autonomous research agent that explores Qdrant collections iteratively.

The agent:
1. Starts with initial query
2. Searches most relevant collection
3. Analyzes results for gaps
4. Expands query based on findings
5. Searches additional collections
6. Repeats until confident or max iterations
7. Synthesizes findings into final answer using ZANTARA AI

### `BurnoutDetectorService`

**Module:** `services.analytics.burnout_detector`

Service for detecting burnout signals.

Responsibility: Detect early warning signs of burnout.

### `CacheService`

**Module:** `core.cache`

Intelligent caching service with Redis backend
Falls back to in-memory cache if Redis unavailable

Uses dependency injection instead of global state.
Each instance has its own in-memory cache (instance-level, not module-level).

Usage with DI:
    from fastapi import Depends
    from core.cache import get_cache_service

    async def endpoint(cache: CacheService = Depends(get_cache_service)):
        value = cache.get("key")

### `CitationService`

**Module:** `services.search.citation_service`

Manages citation formatting and source references for AI responses

Features:
- Inline citation markers [1], [2], etc.
- Full source details with titles, URLs, dates
- Automatic citation numbering
- Support for multiple source types (RAG docs, memory, web)

### `ClarificationService`

**Module:** `services.misc.clarification_service`

Detects ambiguous queries and generates clarification requests

Features:
- Pattern-based ambiguity detection
- Context-aware clarification questions
- Multi-language support (EN, IT, ID)
- Confidence scoring for ambiguity detection

### `ClientScoringService`

**Module:** `agents.services.client_scoring`

Service for calculating client LTV scores

### `ClientSegmentationService`

**Module:** `agents.services.client_segmentation`

Service for segmenting clients and calculating risk levels

### `CollaboratorService`

**Module:** `services.crm.collaborator_service`

Load collaborator profiles from JSON and expose search utilities.

Compatible with the old API (TEAM_DATABASE, identify) so existing plugins/tools
continue to work.

### `CollectionHealthService`

**Module:** `services.ingestion.collection_health_service`

Monitors and reports on Qdrant collection health.

Tracks:
- Collection usage patterns
- Data freshness
- Query performance
- Quality metrics

Provides:
- Health scores per collection
- Staleness alerts
- Actionable recommendations
- Admin dashboard data

### `CollectionWarmupService`

**Module:** `services.ingestion.collection_warmup_service`

Service for warming up Qdrant collections on startup.

Responsibilities:
- Pre-load critical collections into memory
- Initialize embedding models
- Reduce first-query latency from 5-20s to <1s

Does NOT handle:
- Search operations (use SearchService)
- Collection management (use CollectionManager)

### `CollectiveMemoryService`

**Module:** `services.memory.collective_memory_service`

Service for managing collective memory - shared knowledge across users.

Workflow:
1. User contributes a fact ‚Üí stored with source tracking
2. Other users confirm same fact ‚Üí source_count increases
3. When source_count >= 3 ‚Üí fact becomes "promoted" (collective)
4. Promoted facts are included in AI context for all users

### `ComplianceNotificationService`

**Module:** `services.compliance.notifications`

Service for sending compliance notifications.

Responsibility: Send alerts via various channels (WhatsApp, Email, etc.).

### `ComplianceTemplatesService`

**Module:** `services.compliance.templates`

Service for managing compliance templates.

Responsibility: Provide compliance templates and annual deadlines.

### `ComplianceTrackerService`

**Module:** `services.compliance.compliance_tracker`

Service for tracking compliance items.

Responsibility: Add, retrieve, and manage compliance items.

### `ConfidenceCalculatorService`

**Module:** `services.routing.confidence_calculator`

Service for calculating routing confidence scores.

Responsibility: Calculate confidence based on match strength, query length, and domain specificity.

### `ContextSuggestionService`

**Module:** `services.misc.context_suggestion_service`

Service for generating proactive context suggestions based on chat history.
Currently a stub to satisfy dependencies; logic to be implemented.

### `ConversationService`

**Module:** `services.misc.conversation_service`

Service for managing conversation persistence and retrieval.
Handles saving to PostgreSQL, Memory Cache fallback, and triggering Auto-CRM.

### `CrossOracleSynthesisService`

**Module:** `services.oracle.cross_oracle_synthesis_service`

Orchestrates multi-Oracle queries and synthesizes integrated responses.

The "conductor" of the Oracle system - knows when to consult which Oracles
and how to combine their knowledge into actionable business plans.

### `CulturalInsightsService`

**Module:** `services.misc.cultural_insights_service`

Manages cultural insights storage and retrieval.

REFACTORED: Extracted from SearchService to reduce complexity.

Responsibilities:
- Add cultural insights to Qdrant
- Query cultural insights by semantic search
- Format cultural insights for prompt injection

Does NOT handle:
- General document search (use SearchService)
- Collection management (use CollectionManager)

### `CulturalRAGService`

**Module:** `services.misc.cultural_rag_service`

Retrieves ZANTARA-generated Indonesian cultural intelligence for ZANTARA AI enrichment

### `DocumentRetrievalService`

**Module:** `services.oracle.document_retrieval`

Service for document retrieval from Google Drive.

Responsibility: Download PDFs from Google Drive using fuzzy search.

### `DynamicPricingService`

**Module:** `services.pricing.dynamic_pricing_service`

Calculates scenario-based pricing by aggregating Oracle knowledge.

Works with CrossOracleSynthesisService to extract cost information.

### `EmotionalAttunementService`

**Module:** `services.misc.emotional_attunement`

Analyzes message content to detect emotional state and suggest appropriate tone.

Features:
- Pattern-based emotion detection
- Keyword analysis
- Punctuation and capitalization analysis
- Integration with collaborator preferences
- Tone adaptation suggestions

### `EpisodicMemoryService`

**Module:** `services.memory.episodic_memory_service`

Service for managing episodic memories (timeline of events)

### `FallbackManagerService`

**Module:** `services.routing.fallback_manager`

Service for managing fallback chains.

Responsibility: Determine which collections to query based on confidence and fallback chains.

### `FollowupService`

**Module:** `services.misc.followup_service`

Generates suggested follow-up questions based on conversation context

Features:
- Context-aware question generation
- Language-appropriate suggestions (EN, IT, ID)
- Topic-specific follow-ups (business, casual, technical)
- Fast generation using ZANTARA AI

### `GeminiService`

**Module:** `services.llm_clients.gemini_service`

Wrapper class for GeminiJakselService to maintain compatibility with tests.

### `GoldenAnswerService`

**Module:** `services.misc.golden_answer_service`

Fast lookup and retrieval of pre-generated golden answers

### `GoldenRouterService`

**Module:** `services.routing.golden_router_service`

Router intelligente che mappa query utente a documenti specifici.
Non √® una cache di risposte, ma una cache di "intenti di routing".

### `GoogleDriveService`

**Module:** `services.integrations.google_drive_service`

Manages Google Drive OAuth 2.0 authentication and file operations.

### `GoogleServices`

**Module:** `services.oracle.oracle_google_services`

Google Cloud services manager for Oracle endpoints

### `IdentityService`

**Module:** `app.modules.identity.service`

Identity Service - Authentication and user management

Replicates the exact login flow from Node.js backend (team-login.ts)

### `ImageGenerationService`

**Module:** `services.misc.image_generation_service`

Service to generate images using Google's Generative AI.
Note: Currently uses pollinations.ai as fallback since Google Imagen
requires Vertex AI setup.

### `IngestionService`

**Module:** `services.ingestion.ingestion_service`

Complete book ingestion pipeline.
Handles the full flow from raw document to searchable embeddings.

### `InviteService`

**Module:** `services.portal.invite_service`

Service for managing client portal invitations.

### `JourneyBuilderService`

**Module:** `services.journey.journey_builder`

Service for building client journeys.

Responsibility: Create journeys from templates or custom steps.

### `JourneyTemplatesService`

**Module:** `services.journey.journey_templates`

Service for managing journey templates.

Responsibility: Provide predefined journey templates for common scenarios.

### `KeywordMatcherService`

**Module:** `services.routing.keyword_matcher`

Service for matching keywords to domains.

Responsibility: Calculate domain scores based on keyword matching.

### `KnowledgeService`

**Module:** `app.modules.knowledge.service`

Knowledge Service - RAG search with access control and multi-collection support

This service encapsulates all RAG/search logic, separated from HTTP interface.

### `LanguageDetectionService`

**Module:** `services.oracle.language_detector`

Service for detecting query language.

Responsibility: Detect language from query text with Italian focus for Bali Zero clients.

### `LegalIngestionService`

**Module:** `services.ingestion.legal_ingestion_service`

Specialized ingestion service for Indonesian legal documents.
Implements 4-stage pipeline: Clean ‚Üí Extract Metadata ‚Üí Parse Structure ‚Üí Chunk

### `MCPClientService`

**Module:** `services.misc.mcp_client_service`

Client MCP per Nuzantara.
Connette l'AI a server MCP esterni per estendere le capacit√†.

### `MemoryServicePostgres`

**Module:** `services.memory.memory_service_postgres`

Service for managing persistent user memory with PostgreSQL.

Features:
- Profile facts (max 10, auto-deduplicated)
- Conversation summary (max 500 chars)
- Activity counters
- PostgreSQL persistence with in-memory fallback

### `MemoryServiceStatus`

**Module:** `services.memory.orchestrator`

Status of memory service.

### `NurturingMessageService`

**Module:** `agents.services.nurturing_message`

Service for generating personalized nurturing messages

### `OptimalHoursService`

**Module:** `services.analytics.optimal_hours`

Service for identifying optimal hours.

Responsibility: Identify most productive time windows.

### `OptimizedSearchService`

**Module:** `services.misc.performance_optimizer`

Performance-optimized search service

### `OracleAnalyticsService`

**Module:** `services.oracle.analytics`

Service for Oracle query analytics.

Responsibility: Track query analytics and store metrics.

### `PDFVisionService`

**Module:** `services.multimodal.pdf_vision_service`

Servizio per analisi multimodale di PDF.
Estrae immagini delle pagine e le invia a Gemini Pro Vision.
Supporta download da Google Drive.

### `PatternAnalyzerService`

**Module:** `services.analytics.pattern_analyzer`

Service for analyzing work patterns.

Responsibility: Analyze work hour patterns and habits.

### `PerformanceTrendService`

**Module:** `services.analytics.performance_trend`

Service for analyzing performance trends.

Responsibility: Analyze performance trends over time.

### `PersonalityService`

**Module:** `services.misc.personality_service`

Servizio che gestisce le diverse personalit√† di ZANTARA
basandosi sul team member che interagisce

### `PoliticsIngestionService`

**Module:** `services.ingestion.politics_ingestion`

Ingest structured Indonesian politics KB (1999‚Üítoday) into Qdrant.
Stores in collection 'politics_id'.

### `PortalService`

**Module:** `services.portal.portal_service`

Service for client portal data access.

### `PrerequisitesCheckerService`

**Module:** `services.journey.prerequisites_checker`

Service for checking step prerequisites.

Responsibility: Verify if prerequisites for a step are met.

### `PricingService`

**Module:** `services.pricing.pricing_service`

Official Service Pricing - NO AI GENERATION ALLOWED

### `PriorityOverrideService`

**Module:** `services.routing.priority_override`

Service for detecting priority override patterns.

Responsibility: Check for special query patterns that override normal routing.

### `ProductivityScorerService`

**Module:** `services.analytics.productivity_scorer`

Service for calculating productivity scores.

Responsibility: Calculate productivity score for each team member.

### `ProgressTrackerService`

**Module:** `services.journey.progress_tracker`

Service for tracking journey progress.

Responsibility: Calculate progress metrics and identify next steps.

### `ReasoningEngineService`

**Module:** `services.oracle.reasoning_engine`

Service for Gemini reasoning.

Responsibility: Handle Gemini AI reasoning with context building and response validation.

### `RoutingStatsService`

**Module:** `services.routing.routing_stats`

Service for tracking routing statistics.

Responsibility: Record routing metrics and provide statistics.

### `SearchService`

**Module:** `services.search.search_service`

Core search service for document retrieval.

REFACTORED: Now handles ONLY core search functionality with proper delegation.
Uses dependency injection for all other responsibilities.

Responsibilities:
- Search documents in collections
- Apply tier-based access control
- Format search results
- Coordinate search operations

Properly delegates to:
- CollectionManager: Collection access and management
- ConflictResolver: Multi-collection conflict detection and resolution
- CollectionHealthService: Query metrics and health monitoring
- CulturalInsightsService: Cultural context enrichment
- QueryRouterIntegration: Collection routing decisions
- CollectionWarmupService: Collection pre-loading and warmup

### `ServiceHealth`

**Module:** `app.core.service_health`

Health information for a single service.

### `ServiceRegistry`

**Module:** `app.core.service_health`

Registry for tracking service health status.

Provides:
- Service registration with health status
- Overall system health assessment
- Critical service failure detection
- Health reporting for monitoring endpoints

### `ServiceStatus`

**Module:** `app.core.service_health`

Service health status levels.

### `SessionService`

**Module:** `services.misc.session_service`

Manages conversation sessions in Redis for extended context support.

Features:
- Create/Read/Update/Delete sessions
- 24-hour TTL with auto-extension on activity
- JSON serialization of conversation history
- Automatic cleanup of expired sessions

### `SeverityCalculatorService`

**Module:** `services.compliance.severity_calculator`

Service for calculating alert severity.

Responsibility: Calculate alert severity based on days until deadline.

### `SpecializedServiceRouter`

**Module:** `services.routing.specialized_service_router`

Router for specialized services

Routes complex queries to:
- AutonomousResearchService: Ambiguous/complex multi-collection queries
- CrossOracleSynthesisService: Business planning and comprehensive queries
- ClientJourneyOrchestrator: Multi-step business workflows

### `StepManagerService`

**Module:** `services.journey.step_manager`

Service for managing step lifecycle.

Responsibility: Start, complete, and block steps.

### `TeamAnalyticsService`

**Module:** `services.analytics.team_analytics_service`

Advanced analytics for team work sessions
Provides 7 intelligent analysis techniques

REFACTORED: Delegates to specialized sub-services.

### `TeamDriveService`

**Module:** `services.integrations.team_drive_service`

Google Drive access for team members using hybrid OAuth + Service Account.

AUTHENTICATION PRIORITY:
1. OAuth SYSTEM token ‚Üí antonellosiano@gmail.com's 30TB quota
2. Domain-Wide Delegation ‚Üí Workspace org quota
3. Service Account direct ‚Üí 15GB limit

The Service Account (nuzantara-bot@nuzantara.iam.gserviceaccount.com) is
used as fallback when OAuth is not available.

### `TeamInsightsService`

**Module:** `services.analytics.team_insights`

Service for generating team insights.

Responsibility: Generate comprehensive team collaboration insights.

### `TeamTimesheetService`

**Module:** `services.analytics.team_timesheet_service`

Team work hours tracking service

Features:
- Clock in/out tracking
- Auto-logout at 18:30 Bali time
- Daily/weekly/monthly summaries
- Real-time online status
- Admin-only dashboard data

### `TelegramBotService`

**Module:** `services.integrations.telegram_bot_service`

Service for interacting with Telegram Bot API.

### `TestAlertGeneratorService`

**Module:** `tests.unit.services.compliance.test_alert_generator`

Tests for AlertGeneratorService

### `TestAlertService`

**Module:** `tests.unit.services.monitoring.test_alert_service`

Tests for AlertService

### `TestAuditService`

**Module:** `tests.unit.services.monitoring.test_audit_service`

Tests for AuditService

### `TestAutoCRMService`

**Module:** `tests.unit.services.crm.test_auto_crm_service`

Tests for AutoCRMService

### `TestAutonomousResearchService`

**Module:** `tests.unit.services.misc.test_autonomous_research_service`

Tests for AutonomousResearchService

### `TestBurnoutDetectorService`

**Module:** `tests.unit.services.analytics.test_burnout_detector`

Tests for BurnoutDetectorService

### `TestCitationService`

**Module:** `tests.unit.services.search.test_citation_service`

Tests for CitationService

### `TestClarificationService`

**Module:** `tests.unit.services.misc.test_clarification_service`

Tests for ClarificationService

### `TestClientScoringService`

**Module:** `tests.unit.agents.services.test_client_scoring`

Tests for ClientScoringService

### `TestClientSegmentationService`

**Module:** `tests.unit.agents.services.test_client_segmentation`

Tests for ClientSegmentationService

### `TestCollaboratorService`

**Module:** `tests.unit.services.crm.test_collaborator_service`

Tests for CollaboratorService

### `TestCollectionHealthService`

**Module:** `tests.unit.services.ingestion.test_collection_health_service`

Tests for CollectionHealthService

### `TestCollectionWarmupService`

**Module:** `tests.unit.services.ingestion.test_collection_warmup_service`

Tests for CollectionWarmupService

### `TestCollectiveMemoryService`

**Module:** `tests.unit.services.memory.test_collective_memory_comprehensive`

Tests for CollectiveMemoryService

### `TestComplianceNotificationService`

**Module:** `tests.unit.services.compliance.test_notifications`

Tests for ComplianceNotificationService

### `TestComplianceTemplatesService`

**Module:** `tests.unit.services.compliance.test_templates`

Tests for ComplianceTemplatesService

### `TestComplianceTrackerService`

**Module:** `tests.unit.services.compliance.test_compliance_tracker`

Tests for ComplianceTrackerService

### `TestConfidenceCalculatorService`

**Module:** `tests.unit.services.routing.test_confidence_calculator`

Tests for ConfidenceCalculatorService

### `TestContextSuggestionService`

**Module:** `tests.unit.services.misc.test_context_suggestion_service`

Tests for ContextSuggestionService

### `TestConversationService`

**Module:** `tests.unit.services.misc.test_conversation_service`

Tests for ConversationService

### `TestCulturalInsightsService`

**Module:** `tests.unit.services.misc.test_cultural_insights_service`

Tests for CulturalInsightsService

### `TestCulturalRAGService`

**Module:** `tests.unit.services.misc.test_cultural_rag_service`

Tests for CulturalRAGService

### `TestDynamicPricingService`

**Module:** `tests.unit.services.pricing.test_dynamic_pricing_service`

Tests for DynamicPricingService

### `TestEmotionalAttunementService`

**Module:** `tests.unit.services.misc.test_emotional_attunement`

Tests for EmotionalAttunementService

### `TestEntityExtractionService`

**Module:** `tests.unit.services.rag.agentic.test_entity_extractor`

Tests for EntityExtractionService

### `TestEpisodicMemoryService`

**Module:** `tests.unit.services.memory.test_episodic_memory_comprehensive`

Tests for EpisodicMemoryService

### `TestFallbackManagerService`

**Module:** `tests.unit.services.routing.test_fallback_manager`

Tests for FallbackManagerService

### `TestFollowupService`

**Module:** `tests.unit.services.misc.test_followup_service`

Tests for FollowupService

### `TestGetSearchService`

**Module:** `tests.unit.app.modules.knowledge.test_knowledge_router`

Tests for get_search_service function

### `TestGoldenAnswerService`

**Module:** `tests.unit.services.misc.test_golden_answer_service`

Tests for GoldenAnswerService

### `TestGoldenRouterService`

**Module:** `tests.unit.services.routing.test_golden_router_service`

Tests for GoldenRouterService

### `TestGoogleDriveService`

**Module:** `tests.unit.services.integrations.test_google_drive_service`

Tests for GoogleDriveService

### `TestGraphService`

**Module:** `tests.unit.services.misc.test_graph_service`

Tests for GraphService

### `TestImageGenerationService`

**Module:** `tests.unit.services.misc.test_image_generation_service`

Tests for ImageGenerationService

### `TestIngestionService`

**Module:** `tests.unit.services.ingestion.test_ingestion_service`

Tests for IngestionService

### `TestInitCriticalServices`

**Module:** `tests.unit.app.setup.test_service_initializer`

Test _init_critical_services function

### `TestInitializeCRMAndMemoryServices`

**Module:** `tests.unit.app.setup.test_service_initializer`

Test initialize_crm_and_memory_services function

### `TestInitializeDatabaseServices`

**Module:** `tests.unit.app.setup.test_service_initializer`

Test initialize_database_services function

### `TestInviteService`

**Module:** `tests.unit.services.portal.test_invite_service`

Tests for InviteService

### `TestJourneyBuilderService`

**Module:** `tests.unit.services.journey.test_journey_builder`

Tests for JourneyBuilderService

### `TestJourneyTemplatesService`

**Module:** `tests.unit.services.journey.test_journey_templates`

Tests for JourneyTemplatesService

### `TestKeywordMatcherService`

**Module:** `tests.unit.services.routing.test_keyword_matcher`

Tests for KeywordMatcherService

### `TestKnowledgeService`

**Module:** `tests.unit.app.modules.knowledge.test_knowledge_service`

Tests for KnowledgeService

### `TestKnowledgeServiceIntegration`

**Module:** `tests.integration.knowledge.test_knowledge_service_integration`

Integration tests for KnowledgeService

### `TestMCPClientService`

**Module:** `tests.unit.services.misc.test_mcp_client_service`

Tests for MCPClientService

### `TestMemoryServicePostgres`

**Module:** `tests.unit.services.memory.test_memory_service_postgres`

Test suite for MemoryServicePostgres

### `TestNurturingMessageService`

**Module:** `tests.unit.agents.services.test_nurturing_message`

Tests for NurturingMessageService

### `TestOptimalHoursService`

**Module:** `tests.unit.services.analytics.test_optimal_hours`

Tests for OptimalHoursService

### `TestOracleService`

**Module:** `tests.unit.services.oracle.test_oracle_service`

Tests for OracleService

### `TestOracleServiceProperties`

**Module:** `tests.unit.services.oracle.test_oracle_service_properties`

Tests for OracleService properties

### `TestPDFVisionService`

**Module:** `tests.unit.services.multimodal.test_pdf_vision_service`

Tests for PDFVisionService

### `TestPatternAnalyzerService`

**Module:** `tests.unit.services.analytics.test_pattern_analyzer`

Tests for PatternAnalyzerService

### `TestPerformanceTrendService`

**Module:** `tests.unit.services.analytics.test_performance_trend`

Tests for PerformanceTrendService

### `TestPersonalityService`

**Module:** `tests.unit.services.misc.test_personality_service`

Tests for PersonalityService

### `TestPortalService`

**Module:** `tests.unit.services.portal.test_portal_service`

Tests for PortalService

### `TestPrerequisitesCheckerService`

**Module:** `tests.unit.services.journey.test_prerequisites_checker`

Tests for PrerequisitesCheckerService

### `TestPricingService`

**Module:** `tests.unit.services.pricing.test_pricing_service`

Tests for PricingService

### `TestPricingServiceConvenienceFunctions`

**Module:** `tests.unit.services.pricing.test_pricing_service`

Tests for convenience functions

### `TestPriorityOverrideService`

**Module:** `tests.unit.services.routing.test_priority_override`

Tests for PriorityOverrideService

### `TestProductivityScorerService`

**Module:** `tests.unit.services.analytics.test_productivity_scorer`

Tests for ProductivityScorerService

### `TestProgressTrackerService`

**Module:** `tests.unit.services.journey.test_progress_tracker`

Tests for ProgressTrackerService

### `TestRoutingStatsService`

**Module:** `tests.unit.services.routing.test_routing_stats_comprehensive`

Tests for RoutingStatsService

### `TestSearchService`

**Module:** `tests.unit.services.search.test_search_service_comprehensive`

Tests for SearchService

### `TestSearchServiceBM25Init`

**Module:** `tests.unit.services.search.test_search_service_comprehensive`

Tests for BM25 initialization in SearchService

### `TestSearchServiceMetrics`

**Module:** `tests.unit.services.search.test_search_service_comprehensive`

Tests for metrics collection in SearchService

### `TestServiceHealth`

**Module:** `tests.unit.core.test_service_health`

Tests for ServiceHealth

### `TestServiceRegistry`

**Module:** `tests.unit.core.test_service_health`

Tests for ServiceRegistry

### `TestSessionService`

**Module:** `tests.unit.services.misc.test_session_service`

Tests for SessionService

### `TestSeverityCalculatorService`

**Module:** `tests.unit.services.compliance.test_severity_calculator`

Tests for SeverityCalculatorService

### `TestSpecializedServiceRouter`

**Module:** `tests.unit.services.routing.test_specialized_service_router_comprehensive`

Tests for SpecializedServiceRouter

### `TestStepManagerService`

**Module:** `tests.unit.services.journey.test_step_manager`

Tests for StepManagerService

### `TestTeamAnalyticsService`

**Module:** `tests.unit.services.analytics.test_team_analytics_service`

Tests for TeamAnalyticsService

### `TestTeamDriveServiceInit`

**Module:** `tests.unit.services.integrations.test_team_drive_service`

Tests for service initialization.

### `TestTeamDriveServiceIntegration`

**Module:** `tests.integration.test_team_drive_api`

Tests for TeamDriveService integration.

### `TestTeamInsightsService`

**Module:** `tests.unit.services.analytics.test_team_insights`

Tests for TeamInsightsService

### `TestTeamTimesheetService`

**Module:** `tests.unit.services.analytics.test_team_timesheet_service`

Tests for TeamTimesheetService

### `TestUnifiedHealthService`

**Module:** `tests.unit.services.monitoring.test_unified_health_service`

Tests for UnifiedHealthService

### `TestVerificationService`

**Module:** `tests.unit.services.rag.test_verification_service`

Tests for VerificationService

### `TestVerificationServiceInit`

**Module:** `tests.unit.services.rag.test_verification_service`

Tests for VerificationService initialization

### `TestVertexAIService`

**Module:** `tests.unit.services.llm_clients.test_vertex_ai_service`

Tests for VertexAIService

### `TestVisionRAGService`

**Module:** `tests.unit.services.rag.test_vision_rag`

Tests for VisionRAGService

### `TestWhatsAppNotificationService`

**Module:** `tests.unit.agents.services.test_whatsapp_notification`

Tests for WhatsAppNotificationService

### `TestWorkSessionService`

**Module:** `tests.unit.services.misc.test_work_session_service_comprehensive`

Tests for WorkSessionService

### `TestWorkloadBalanceService`

**Module:** `tests.unit.services.analytics.test_workload_balance`

Tests for WorkloadBalanceService

### `TestZohoEmailServiceInit`

**Module:** `tests.unit.services.integrations.test_zoho_email_service`

Tests for initialization

### `TestZohoOAuthService`

**Module:** `tests.unit.services.integrations.test_zoho_oauth_service`

Tests for ZohoOAuthService

### `UnifiedHealthService`

**Module:** `services.monitoring.unified_health_service`

Unified Health Check Service

Provides:
- Comprehensive health checks for all services
- System metrics monitoring
- Integration with ServiceRegistry
- Continuous monitoring capabilities
- Health check reporting

### `UserContextService`

**Module:** `services.oracle.user_context`

Service for managing user context.

Responsibility: Load and manage user profile, memory, and personality information.

### `VerificationService`

**Module:** `services.rag.verification_service`

Service responsible for verifying RAG generated responses against source context.
Uses a lightweight LLM call to act as a 'Guardian'.

### `VertexAIService`

**Module:** `services.llm_clients.vertex_ai_service`

Service for interacting with Vertex AI Gemini models.

### `VisionRAGService`

**Module:** `services.rag.vision_rag`

Servizio per RAG su documenti multi-modali.
Estrae e indicizza elementi visuali (tabelle, grafici, form).

### `WhatsAppNotificationService`

**Module:** `agents.services.whatsapp_notification`

Service for sending WhatsApp messages via Twilio

### `WorkSessionService`

**Module:** `services.misc.work_session_service`

Track team work sessions and send reports to ZERO
ZERO decides what to share with team

Data persistence:
- PostgreSQL: Primary storage (Fly.io cloud database)
- JSONL file: Local backup log (work_sessions_log.jsonl)

### `WorkloadBalanceService`

**Module:** `services.analytics.workload_balance`

Service for analyzing workload balance.

Responsibility: Analyze workload distribution across team.

### `ZohoEmailService`

**Module:** `services.integrations.zoho_email_service`

Handles all Zoho Mail API operations.

### `ZohoOAuthService`

**Module:** `services.integrations.zoho_oauth_service`

Manages Zoho OAuth 2.0 authentication flow and token lifecycle.

## Agents

### `app/routers/agents.py`

ZANTARA Agentic Functions Router
Exposes all 10 advanced agentic capabilities as REST API endpoints

Phase 1-2: Foundation Agents (6)
Phase 3: Orchestration Agents (2)
Phase 4: Advanced Intelligence (1)
Phase 5: Automation (1)

Performance Optimizations:
- Redis caching (5 min TTL for status endpoints)
- Rate limiting (prevents abuse)
- Request deduplication

SECURITY: All endpoints require authentication (added 2025-12-03)

### `app/routers/agentic_rag.py`

Agentic RAG API Router

### `app/routers/autonomous_agents.py`

TIER 1 AUTONOMOUS AGENTS - HTTP Endpoints
Provides HTTP API for orchestrator to trigger autonomous agents

Agents:
1. Conversation Quality Trainer
2. Client LTV Predictor & Nurturing
3. Knowledge Graph Builder

### `self_healing/backend_agent.py`

ü§ñ ZANTARA Backend Self-Healing Agent

Autonomous agent that monitors backend service health and auto-fixes issues
Runs continuously on each Fly.io service (RAG, Memory, etc.)

Features:
- Health checks (API, DB, Redis, Qdrant)
- Auto-restart on failures
- Memory leak detection
- Database connection pool management
- API endpoint monitoring
- Reports to Central Orchestrator

### `tests/unit/app/routers/test_agentic_rag_router.py`

Unit tests for Agentic RAG Router
Target: 100% coverage
Composer: 2

### `tests/unit/services/rag/agentic/test_agentic_tools_comprehensive.py`

Unit tests for Agentic RAG Tools
Target: 100% coverage
Composer: 1

---

*Last updated: 2026-01-06 19:45:18*