name: CD - Deploy to Fly.io

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging
      service:
        description: 'Service to deploy (all or specific)'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - backend-rag
          - mouth

concurrency:
  group: deploy-${{ github.ref }}-${{ inputs.environment || 'production' }}
  cancel-in-progress: false

jobs:
  # ============================================
  # Pre-deployment validation
  # ============================================
  pre-deploy-checks:
    name: Pre-deployment Checks
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Validate configuration files
        run: |
          echo "üîç Validating deployment configuration..."
          
          # Check fly.toml files exist
          if [ ! -f "apps/backend-rag/fly.toml" ]; then
            echo "‚ùå Missing apps/backend-rag/fly.toml"
            exit 1
          fi
          
          if [ ! -f "apps/mouth/fly.toml" ]; then
            echo "‚ùå Missing apps/mouth/fly.toml"
            exit 1
          fi
          
          echo "‚úÖ Configuration files validated"

      - name: Validate environment variables
        run: |
          echo "üîç Checking required secrets..."
          # This will be checked by Fly.io during deployment
          echo "‚úÖ Environment validation complete"

      - name: Run pre-deployment tests
        run: |
          echo "üß™ Running pre-deployment tests..."
          npm run test:ci
          echo "‚úÖ Pre-deployment tests passed"

  # ============================================
  # Deploy Backend RAG (Python FastAPI)
  # ============================================
  deploy-backend-rag:
    name: Deploy Backend RAG
    runs-on: ubuntu-latest
    needs: pre-deploy-checks
    if: |
      github.event.inputs.service == 'all' || 
      github.event.inputs.service == 'backend-rag' ||
      github.event_name == 'push'
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Fly.io CLI
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Deploy Backend RAG to Fly.io
        working-directory: apps/backend-rag
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        run: |
          echo "üöÄ Deploying Backend RAG to Fly.io..."
          
          # Set secrets (if not already set)
          flyctl secrets set \
            OPENAI_API_KEY="${{ secrets.OPENAI_API_KEY }}" \
            ANTHROPIC_API_KEY="${{ secrets.ANTHROPIC_API_KEY }}" \
            GOOGLE_API_KEY="${{ secrets.GOOGLE_API_KEY }}" \
            DATABASE_URL="${{ secrets.DATABASE_URL }}" \
            REDIS_URL="${{ secrets.REDIS_URL }}" \
            JWT_SECRET="${{ secrets.JWT_SECRET }}" \
            --app nuzantara-rag \
            || echo "Secrets already set or error occurred"
          
          # Deploy the app
          flyctl deploy --remote-only --strategy rolling
          
          echo "‚úÖ Backend RAG deployed successfully"

      - name: Health check - Backend RAG
        run: |
          echo "üè• Running health check..."
          sleep 15
          
          HEALTH_URL="https://nuzantara-rag.fly.dev/health"
          MAX_RETRIES=10
          RETRY_COUNT=0
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            echo "Attempt $((RETRY_COUNT + 1))/$MAX_RETRIES: Checking $HEALTH_URL"
            
            if curl -f -s "$HEALTH_URL" | jq . ; then
              echo "‚úÖ Health check passed!"
              exit 0
            fi
            
            RETRY_COUNT=$((RETRY_COUNT + 1))
            echo "‚è≥ Retrying in 10 seconds..."
            sleep 10
          done
          
          echo "‚ùå Health check failed after $MAX_RETRIES attempts"
          exit 1

  # ============================================
  # Deploy Mouth (Next.js Frontend)
  # ============================================
  deploy-mouth:
    name: Deploy Mouth Frontend
    runs-on: ubuntu-latest
    needs: [pre-deploy-checks, deploy-backend-rag]
    if: |
      always() &&
      needs.pre-deploy-checks.result == 'success' &&
      (needs.deploy-backend-rag.result == 'success' || needs.deploy-backend-rag.result == 'skipped') &&
      (github.event.inputs.service == 'all' || 
       github.event.inputs.service == 'mouth' ||
       github.event_name == 'push')
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Fly.io CLI
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Deploy Mouth to Fly.io
        working-directory: apps/mouth
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        run: |
          echo "üöÄ Deploying Mouth Frontend to Fly.io..."
          
          # Set secrets
          flyctl secrets set \
            NEXT_PUBLIC_API_URL="${{ secrets.NEXT_PUBLIC_API_URL || 'https://nuzantara-rag.fly.dev' }}" \
            --app nuzantara-mouth \
            || echo "Secrets already set or error occurred"
          
          # Deploy the app
          flyctl deploy --remote-only --strategy rolling
          
          echo "‚úÖ Mouth Frontend deployed successfully"

      - name: Health check - Mouth
        run: |
          echo "üè• Running health check..."
          sleep 15
          
          HEALTH_URL="https://nuzantara-mouth.fly.dev"
          MAX_RETRIES=10
          RETRY_COUNT=0
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            echo "Attempt $((RETRY_COUNT + 1))/$MAX_RETRIES: Checking $HEALTH_URL"
            
            if curl -f -s -o /dev/null -w "%{http_code}" "$HEALTH_URL" | grep -q "200\|301\|302"; then
              echo "‚úÖ Health check passed!"
              exit 0
            fi
            
            RETRY_COUNT=$((RETRY_COUNT + 1))
            echo "‚è≥ Retrying in 10 seconds..."
            sleep 10
          done
          
          echo "‚ùå Health check failed after $MAX_RETRIES attempts"
          exit 1

  # ============================================
  # Post-deployment validation
  # ============================================
  post-deploy-validation:
    name: Post-deployment Validation
    runs-on: ubuntu-latest
    needs: [deploy-backend-rag, deploy-mouth]
    if: always()
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run integration tests
        run: |
          echo "üß™ Running post-deployment integration tests..."
          
          # Test backend health endpoint
          echo "Testing Backend RAG..."
          curl -f https://nuzantara-rag.fly.dev/health || echo "Backend health check warning"
          
          # Test frontend accessibility
          echo "Testing Mouth Frontend..."
          curl -f https://nuzantara-mouth.fly.dev || echo "Frontend accessibility warning"
          
          echo "‚úÖ Post-deployment validation complete"

      - name: Notify deployment status
        if: always()
        run: |
          if [ "${{ needs.deploy-backend-rag.result }}" == "success" ] || [ "${{ needs.deploy-mouth.result }}" == "success" ]; then
            echo "‚úÖ Deployment successful!"
            echo "üåê Backend: https://nuzantara-rag.fly.dev"
            echo "üåê Frontend: https://nuzantara-mouth.fly.dev"
          else
            echo "‚ùå Deployment failed or skipped"
          fi

  # ============================================
  # Rollback job (manual trigger only)
  # ============================================
  rollback:
    name: Rollback Deployment
    runs-on: ubuntu-latest
    if: failure() && github.event_name == 'workflow_dispatch'
    needs: [deploy-backend-rag, deploy-mouth]
    timeout-minutes: 15

    steps:
      - name: Setup Fly.io CLI
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Rollback Backend RAG
        if: needs.deploy-backend-rag.result == 'failure'
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        run: |
          echo "üîÑ Rolling back Backend RAG..."
          flyctl releases rollback --app nuzantara-rag -y || echo "Rollback failed or not needed"

      - name: Rollback Mouth
        if: needs.deploy-mouth.result == 'failure'
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        run: |
          echo "üîÑ Rolling back Mouth..."
          flyctl releases rollback --app nuzantara-mouth -y || echo "Rollback failed or not needed"
